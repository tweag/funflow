<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MagicHash #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE UnboxedTuples #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Store.Core</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Core Types</span></span><span>
</span><span id="line-15"></span><span>      </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier">Poke</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier">PokeException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeException"><span class="hs-identifier">pokeException</span></a></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier">Peek</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier">PeekResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier">PeekException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekException"><span class="hs-identifier">peekException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier">tooManyBytes</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier">PokeState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier">pokeStatePtr</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier">PeekState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier">peekStateEndPtr</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier">Offset</span></a></span><span>
</span><span id="line-20"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Encode ByteString</span></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#unsafeEncodeWith"><span class="hs-identifier">unsafeEncodeWith</span></a></span><span>
</span><span id="line-22"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Decode ByteString</span></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeWith"><span class="hs-identifier">decodeWith</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeExWith"><span class="hs-identifier">decodeExWith</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeExPortionWith"><span class="hs-identifier">decodeExPortionWith</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeIOWith"><span class="hs-identifier">decodeIOWith</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeIOPortionWith"><span class="hs-identifier">decodeIOPortionWith</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeIOWithFromPtr"><span class="hs-identifier">decodeIOWithFromPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#decodeIOPortionWithFromPtr"><span class="hs-identifier">decodeIOPortionWithFromPtr</span></a></span><span>
</span><span id="line-27"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Storable</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeStorable"><span class="hs-identifier">pokeStorable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekStorable"><span class="hs-identifier">peekStorable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekStorableTy"><span class="hs-identifier">peekStorableTy</span></a></span><span>
</span><span id="line-29"></span><span>      </span><span class="annot"><span class="hs-comment">-- * ForeignPtr</span></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeFromForeignPtr"><span class="hs-identifier">pokeFromForeignPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekToPlainForeignPtr"><span class="hs-identifier">peekToPlainForeignPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeFromPtr"><span class="hs-identifier">pokeFromPtr</span></a></span><span>
</span><span id="line-31"></span><span>      </span><span class="annot"><span class="hs-comment">-- * ByteArray</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeFromByteArray"><span class="hs-identifier">pokeFromByteArray</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekToByteArray"><span class="hs-identifier">peekToByteArray</span></a></span><span>
</span><span id="line-33"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Creation of PokeState / PeekState</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#unsafeMakePokeState"><span class="hs-identifier">unsafeMakePokeState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#unsafeMakePeekState"><span class="hs-identifier">unsafeMakePeekState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.Core.html#maybeAlignmentBufferSize"><span class="hs-identifier">maybeAlignmentBufferSize</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Primitive</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PrimMonad</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Internal</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Primitive.ByteArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteArray</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MutableByteArray</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newByteArray</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeFreezeByteArray</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Foreign.ForeignPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ForeignPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">withForeignPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">castForeignPtr</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Foreign.Ptr</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Foreign.Storable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Storable</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Exts</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeCoerce#</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Prim</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RealWorld</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ByteArray#</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">copyByteArrayToAddr#</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">copyAddrToByteArray#</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ptr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Int</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span class="hs-cpp">

#if MIN_VERSION_base(4,9,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Fail</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Fail</span></span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign.Marshal.Alloc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">allocaBytesAligned</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-67"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- Helpful Type Synonyms</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- | How far into the given Ptr to look</span><span>
</span><span id="line-71"></span><span class="hs-keyword">type</span><span> </span><span id="Offset"><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-var">Offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- Poke monad</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | 'Poke' actions are useful for building sequential serializers.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- They are actions which write values to bytes into memory specified by</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- a 'Ptr' base. The 'Applicative' and 'Monad' instances make it easy to</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- write serializations, by keeping track of the 'Offset' of the current</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- byte. They allow you to chain 'Poke' action such that subsequent</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- 'Poke's write into subsequent portions of the output.</span><span>
</span><span id="line-83"></span><span class="hs-keyword">newtype</span><span> </span><span id="Poke"><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span></span><span> </span><span id="local-6989586621679054110"><span class="annot"><a href="#local-6989586621679054110"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Poke"><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="runPoke"><span class="annot"><span class="annottext">Poke a -&gt; PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#runPoke"><span class="hs-identifier hs-var hs-var">runPoke</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-type">PokeState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679054110"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">-- ^ Run the 'Poke' action, with the 'Ptr' to the buffer where</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-comment">-- data is poked, and the current 'Offset'. The result is the new</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-comment">-- offset, along with a return value.</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-comment">-- May throw a 'PokeException', though this should be avoided when</span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-comment">-- possible.  They usually indicate a programming error.</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679053921"><span id="local-6989586621679053923"><span class="annot"><span class="annottext">a -&gt; Poke b -&gt; Poke a
(a -&gt; b) -&gt; Poke a -&gt; Poke b
(forall a b. (a -&gt; b) -&gt; Poke a -&gt; Poke b)
-&gt; (forall a b. a -&gt; Poke b -&gt; Poke a) -&gt; Functor Poke
forall a b. a -&gt; Poke b -&gt; Poke a
forall a b. (a -&gt; b) -&gt; Poke a -&gt; Poke b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; Poke b -&gt; Poke a
$c&lt;$ :: forall a b. a -&gt; Poke b -&gt; Poke a
fmap :: (a -&gt; b) -&gt; Poke a -&gt; Poke b
$cfmap :: forall a b. (a -&gt; b) -&gt; Poke a -&gt; Poke b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053912"><span id="local-6989586621679053915"><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621679053910"><span class="annot"><span class="annottext">pure :: a -&gt; Poke a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></span></span><span> </span><span id="local-6989586621679053909"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053909"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053908"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053908"><span class="hs-identifier hs-var">_ptr</span></a></span></span><span> </span><span id="local-6989586621679053907"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053907"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Offset, a) -&gt; IO (Offset, a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053907"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053909"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">pure</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span id="local-6989586621679053906"><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a -&gt; b)
</span><a href="#local-6989586621679053906"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679053905"><span class="annot"><span class="annottext">&lt;*&gt; :: Poke (a -&gt; b) -&gt; Poke a -&gt; Poke b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;*&gt;</span></span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span id="local-6989586621679053904"><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053904"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053903"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053903"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679053902"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053902"><span class="hs-identifier hs-var">offset1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679053901"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053901"><span class="hs-identifier hs-var">offset2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053900"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679053900"><span class="hs-identifier hs-var">f'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a -&gt; b)
</span><a href="#local-6989586621679053906"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053903"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053902"><span class="hs-identifier hs-var">offset1</span></a></span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679053899"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053899"><span class="hs-identifier hs-var">offset3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053898"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053898"><span class="hs-identifier hs-var">g'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053904"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053903"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053901"><span class="hs-identifier hs-var">offset2</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">(Offset, b) -&gt; IO (Offset, b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053899"><span class="hs-identifier hs-var">offset3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679053900"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053898"><span class="hs-identifier hs-var">g'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span id="local-6989586621679053897"><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053897"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679053896"><span class="annot"><span class="annottext">*&gt; :: Poke a -&gt; Poke b -&gt; Poke b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">*&gt;</span></span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span id="local-6989586621679053895"><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, b)
</span><a href="#local-6989586621679053895"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053894"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053894"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679053893"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053893"><span class="hs-identifier hs-var">offset1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679053892"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053892"><span class="hs-identifier hs-var">offset2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053897"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053894"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053893"><span class="hs-identifier hs-var">offset1</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, b)
</span><a href="#local-6989586621679053895"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053894"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053892"><span class="hs-identifier hs-var">offset2</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621679053886"><span class="annot"><span class="annottext">return :: a -&gt; Poke a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">return</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Poke a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">return</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621679053885"><span class="annot"><span class="annottext">&gt;&gt; :: Poke a -&gt; Poke b -&gt; Poke b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&gt;&gt;)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Poke a -&gt; Poke b -&gt; Poke b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">(*&gt;)</span></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span id="local-6989586621679053884"><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053884"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679053883"><span class="annot"><span class="annottext">&gt;&gt;= :: Poke a -&gt; (a -&gt; Poke b) -&gt; Poke b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&gt;&gt;=</span></span></span><span> </span><span id="local-6989586621679053882"><span class="annot"><span class="annottext">a -&gt; Poke b
</span><a href="#local-6989586621679053882"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, b)) -&gt; Poke b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053881"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053881"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679053880"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053880"><span class="hs-identifier hs-var">offset1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679053879"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053879"><span class="hs-identifier hs-var">offset2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053878"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053878"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="#local-6989586621679053884"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053881"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053880"><span class="hs-identifier hs-var">offset1</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span class="annot"><span class="annottext">Poke b -&gt; PokeState -&gt; Offset -&gt; IO (Offset, b)
forall a. Poke a -&gt; PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#runPoke"><span class="hs-identifier hs-var hs-var">runPoke</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Poke b
</span><a href="#local-6989586621679053882"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053878"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053881"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053879"><span class="hs-identifier hs-var">offset2</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#if !(MIN_VERSION_base(4,13,0))
</span><span>    </span><span class="hs-identifier">fail</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pokeException</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">T.pack</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">fail</span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if MIN_VERSION_base(4,9,0)
</span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fail.MonadFail</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621679053874"><span class="annot"><span class="annottext">fail :: String -&gt; Poke a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fail</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Poke a
forall a. Text -&gt; Poke a
</span><a href="Data.Store.Core.html#pokeException"><span class="hs-identifier hs-var">pokeException</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Poke a) -&gt; (String -&gt; Text) -&gt; String -&gt; Poke a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">fail</span></span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-127"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621679053868"><span class="annot"><span class="annottext">liftIO :: IO a -&gt; Poke a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">liftIO</span></span></span><span> </span><span id="local-6989586621679053866"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679053866"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PokeState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679053865"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053865"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053865"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; (Offset, a)) -&gt; IO a -&gt; IO (Offset, a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679053866"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">liftIO</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Holds a 'pokeStatePtr', which is passed in to each 'Poke' action.</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- If the package is built with the 'force-alignment' flag, this also</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- has a hidden 'Ptr' field, which is used as scratch space during</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- unaligned writes.</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">PokeState</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">PokeState</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pokeStatePtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pokeStateAlignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">}</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">newtype</span><span> </span><span id="PokeState"><span class="annot"><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-var">PokeState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PokeState"><span class="annot"><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-var">PokeState</span></a></span></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="pokeStatePtr"><span class="annot"><span class="annottext">PokeState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var hs-var">pokeStatePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- | Make a 'PokeState' from a buffer pointer.</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- The first argument is a pointer to the memory to write to. The second</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- argument is an IO action which is invoked if the store-core package</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- was built with the @force-alignment@ flag. The action should yield a</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- pointer to scratch memory as large as 'maybeAlignmentBufferSize'.</span><span>
</span><span id="line-152"></span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- Since 0.4.2</span><span>
</span><span id="line-154"></span><span class="annot"><a href="Data.Store.Core.html#unsafeMakePokeState"><span class="hs-identifier hs-type">unsafeMakePokeState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-comment">-- ^ pokeStatePtr</span><span>
</span><span id="line-155"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ action to produce pokeStateAlignPtr</span><span>
</span><span id="line-156"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-type">PokeState</span></a></span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span class="hs-identifier">unsafeMakePokeState</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">PokeState</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">f</span><span class="hs-cpp">
#else
</span><span id="unsafeMakePokeState"><span class="annot"><span class="annottext">unsafeMakePokeState :: Ptr Word8 -&gt; IO (Ptr Word8) -&gt; IO PokeState
</span><a href="Data.Store.Core.html#unsafeMakePokeState"><span class="hs-identifier hs-var hs-var">unsafeMakePokeState</span></a></span></span><span> </span><span id="local-6989586621679053862"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053862"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="annot"><span class="annottext">IO (Ptr Word8)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; IO PokeState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; IO PokeState) -&gt; PokeState -&gt; IO PokeState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; PokeState
</span><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-var">PokeState</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053862"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- | Exception thrown while running 'poke'. Note that other types of</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- exceptions could also be thrown. Invocations of 'fail' in the 'Poke'</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- monad causes this exception to be thrown.</span><span>
</span><span id="line-166"></span><span class="hs-comment">--</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- 'PokeException's are not expected to occur in ordinary circumstances,</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- and usually indicate a programming error.</span><span>
</span><span id="line-169"></span><span class="hs-keyword">data</span><span> </span><span id="PokeException"><span class="annot"><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-var">PokeException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PokeException"><span class="annot"><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-var">PokeException</span></a></span></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="pokeExByteIndex"><span class="annot"><span class="annottext">PokeException -&gt; Offset
</span><a href="Data.Store.Core.html#pokeExByteIndex"><span class="hs-identifier hs-var hs-var">pokeExByteIndex</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pokeExMessage"><span class="annot"><span class="annottext">PokeException -&gt; Text
</span><a href="Data.Store.Core.html#pokeExMessage"><span class="hs-identifier hs-var hs-var">pokeExMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679053855"><span id="local-6989586621679053857"><span class="annot"><span class="annottext">PokeException -&gt; PokeException -&gt; Bool
(PokeException -&gt; PokeException -&gt; Bool)
-&gt; (PokeException -&gt; PokeException -&gt; Bool) -&gt; Eq PokeException
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PokeException -&gt; PokeException -&gt; Bool
$c/= :: PokeException -&gt; PokeException -&gt; Bool
== :: PokeException -&gt; PokeException -&gt; Bool
$c== :: PokeException -&gt; PokeException -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053848"><span id="local-6989586621679053850"><span id="local-6989586621679053852"><span class="annot"><span class="annottext">Offset -&gt; PokeException -&gt; ShowS
[PokeException] -&gt; ShowS
PokeException -&gt; String
(Offset -&gt; PokeException -&gt; ShowS)
-&gt; (PokeException -&gt; String)
-&gt; ([PokeException] -&gt; ShowS)
-&gt; Show PokeException
forall a.
(Offset -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PokeException] -&gt; ShowS
$cshowList :: [PokeException] -&gt; ShowS
show :: PokeException -&gt; String
$cshow :: PokeException -&gt; String
showsPrec :: Offset -&gt; PokeException -&gt; ShowS
$cshowsPrec :: Offset -&gt; PokeException -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053841"><span id="local-6989586621679053843"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-type">PokeException</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span class="hs-cpp">
#if MIN_VERSION_base(4,8,0)
</span><span>    </span><span id="local-6989586621679053838"><span class="annot"><span class="annottext">displayException :: PokeException -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">displayException</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-type">PokeException</span></a></span><span> </span><span id="local-6989586621679053836"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053836"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621679053835"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053835"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Exception while poking, at byte index &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053836"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; : &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053835"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- | Throws a 'PokeException'. These should be avoided when possible,</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- they usually indicate a programming error.</span><span>
</span><span id="line-186"></span><span id="local-6989586621679054086"><span class="annot"><a href="Data.Store.Core.html#pokeException"><span class="hs-identifier hs-type">pokeException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054086"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-187"></span><span id="pokeException"><span class="annot"><span class="annottext">pokeException :: Text -&gt; Poke a
</span><a href="Data.Store.Core.html#pokeException"><span class="hs-identifier hs-var hs-var">pokeException</span></a></span></span><span> </span><span id="local-6989586621679053832"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053832"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a)
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PokeState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679053831"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053831"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PokeException -&gt; IO (Offset, a)
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PokeException
</span><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-var">PokeException</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053831"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053832"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- Peek monad</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- | 'Peek' actions are useful for building sequential deserializers.</span><span>
</span><span id="line-193"></span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- They are actions which read from memory and construct values from it.</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- The 'Applicative' and 'Monad' instances make it easy to chain these</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- together to get more complicated deserializers. This machinery keeps</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- track of the current 'Ptr' and end-of-buffer 'Ptr'.</span><span>
</span><span id="line-198"></span><span class="hs-keyword">newtype</span><span> </span><span id="Peek"><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span></span><span> </span><span id="local-6989586621679054046"><span class="annot"><a href="#local-6989586621679054046"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Peek"><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="runPeek"><span class="annot"><span class="annottext">Peek a -&gt; PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="Data.Store.Core.html#runPeek"><span class="hs-identifier hs-var hs-var">runPeek</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-type">PeekState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054046"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-comment">-- ^ Run the 'Peek' action, with a 'Ptr' to the end of the buffer</span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-comment">-- where data is poked, and a 'Ptr' to the current position. The</span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-comment">-- result is the 'Ptr', along with a return value.</span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-comment">-- May throw a 'PeekException' if the memory contains invalid</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">-- values.</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679053825"><span id="local-6989586621679053827"><span class="annot"><span class="annottext">a -&gt; Peek b -&gt; Peek a
(a -&gt; b) -&gt; Peek a -&gt; Peek b
(forall a b. (a -&gt; b) -&gt; Peek a -&gt; Peek b)
-&gt; (forall a b. a -&gt; Peek b -&gt; Peek a) -&gt; Functor Peek
forall a b. a -&gt; Peek b -&gt; Peek a
forall a b. (a -&gt; b) -&gt; Peek a -&gt; Peek b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; Peek b -&gt; Peek a
$c&lt;$ :: forall a b. a -&gt; Peek b -&gt; Peek a
fmap :: (a -&gt; b) -&gt; Peek a -&gt; Peek b
$cfmap :: forall a b. (a -&gt; b) -&gt; Peek a -&gt; Peek b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- | A result of a 'Peek' action containing the current 'Ptr' and a return value.</span><span>
</span><span id="line-209"></span><span class="hs-keyword">data</span><span> </span><span id="PeekResult"><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span></span><span> </span><span id="local-6989586621679054045"><span class="annot"><a href="#local-6989586621679054045"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeekResult"><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span></span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679054045"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679053820"><span id="local-6989586621679053822"><span class="annot"><span class="annottext">a -&gt; PeekResult b -&gt; PeekResult a
(a -&gt; b) -&gt; PeekResult a -&gt; PeekResult b
(forall a b. (a -&gt; b) -&gt; PeekResult a -&gt; PeekResult b)
-&gt; (forall a b. a -&gt; PeekResult b -&gt; PeekResult a)
-&gt; Functor PeekResult
forall a b. a -&gt; PeekResult b -&gt; PeekResult a
forall a b. (a -&gt; b) -&gt; PeekResult a -&gt; PeekResult b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; PeekResult b -&gt; PeekResult a
$c&lt;$ :: forall a b. a -&gt; PeekResult b -&gt; PeekResult a
fmap :: (a -&gt; b) -&gt; PeekResult a -&gt; PeekResult b
$cfmap :: forall a b. (a -&gt; b) -&gt; PeekResult a -&gt; PeekResult b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053812"><span id="local-6989586621679053815"><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679053811"><span class="annot"><span class="annottext">pure :: a -&gt; Peek a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></span></span><span> </span><span id="local-6989586621679053810"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053810"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PeekState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679053809"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053809"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeekResult a -&gt; IO (PeekResult a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult a -&gt; IO (PeekResult a))
-&gt; PeekResult a -&gt; IO (PeekResult a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; a -&gt; PeekResult a
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053809"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053810"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">pure</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span id="local-6989586621679053808"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult (a -&gt; b))
</span><a href="#local-6989586621679053808"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679053807"><span class="annot"><span class="annottext">&lt;*&gt; :: Peek (a -&gt; b) -&gt; Peek a -&gt; Peek b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;*&gt;</span></span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span id="local-6989586621679053806"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053806"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053805"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053805"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679053804"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053804"><span class="hs-identifier hs-var">ptr1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span id="local-6989586621679053803"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053803"><span class="hs-identifier hs-var">ptr2</span></a></span></span><span> </span><span id="local-6989586621679053802"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679053802"><span class="hs-identifier hs-var">f'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult (a -&gt; b))
</span><a href="#local-6989586621679053808"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053805"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053804"><span class="hs-identifier hs-var">ptr1</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span id="local-6989586621679053801"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053801"><span class="hs-identifier hs-var">ptr3</span></a></span></span><span> </span><span id="local-6989586621679053800"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053800"><span class="hs-identifier hs-var">g'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053806"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053805"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053803"><span class="hs-identifier hs-var">ptr2</span></a></span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">PeekResult b -&gt; IO (PeekResult b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult b -&gt; IO (PeekResult b))
-&gt; PeekResult b -&gt; IO (PeekResult b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; b -&gt; PeekResult b
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053801"><span class="hs-identifier hs-var">ptr3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679053802"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053800"><span class="hs-identifier hs-var">g'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span id="local-6989586621679053799"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053799"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679053798"><span class="annot"><span class="annottext">*&gt; :: Peek a -&gt; Peek b -&gt; Peek b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">*&gt;</span></span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span id="local-6989586621679053797"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)
</span><a href="#local-6989586621679053797"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053796"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053796"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679053795"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053795"><span class="hs-identifier hs-var">ptr1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span id="local-6989586621679053794"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053794"><span class="hs-identifier hs-var">ptr2</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053799"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053796"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053795"><span class="hs-identifier hs-var">ptr1</span></a></span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)
</span><a href="#local-6989586621679053797"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053796"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053794"><span class="hs-identifier hs-var">ptr2</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621679053789"><span class="annot"><span class="annottext">return :: a -&gt; Peek a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">return</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Peek a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">return</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621679053788"><span class="annot"><span class="annottext">&gt;&gt; :: Peek a -&gt; Peek b -&gt; Peek b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&gt;&gt;)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; Peek b -&gt; Peek b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">(*&gt;)</span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span id="local-6989586621679053787"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053787"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679053786"><span class="annot"><span class="annottext">&gt;&gt;= :: Peek a -&gt; (a -&gt; Peek b) -&gt; Peek b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&gt;&gt;=</span></span></span><span> </span><span id="local-6989586621679053785"><span class="annot"><span class="annottext">a -&gt; Peek b
</span><a href="#local-6989586621679053785"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)) -&gt; Peek b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053784"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053784"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679053783"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053783"><span class="hs-identifier hs-var">ptr1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span id="local-6989586621679053782"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053782"><span class="hs-identifier hs-var">ptr2</span></a></span></span><span> </span><span id="local-6989586621679053781"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053781"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="#local-6989586621679053787"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053784"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053783"><span class="hs-identifier hs-var">ptr1</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">Peek b -&gt; PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult b)
forall a. Peek a -&gt; PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="Data.Store.Core.html#runPeek"><span class="hs-identifier hs-var hs-var">runPeek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Peek b
</span><a href="#local-6989586621679053785"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053781"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053784"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053782"><span class="hs-identifier hs-var">ptr2</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#if !(MIN_VERSION_base(4,13,0))
</span><span>    </span><span class="hs-identifier">fail</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">peekException</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">T.pack</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">fail</span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if MIN_VERSION_base(4,9,0)
</span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fail.MonadFail</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621679053778"><span class="annot"><span class="annottext">fail :: String -&gt; Peek a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fail</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Peek a
forall a. Text -&gt; Peek a
</span><a href="Data.Store.Core.html#peekException"><span class="hs-identifier hs-var">peekException</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Peek a) -&gt; (String -&gt; Text) -&gt; String -&gt; Peek a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">fail</span></span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-245"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PrimMonad</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="PrimState"><span class="annot"><span class="hs-identifier hs-var">PrimState</span></span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RealWorld</span></span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621679053774"><span class="annot"><span class="annottext">primitive :: (State# (PrimState Peek) -&gt; (# State# (PrimState Peek), a #))
-&gt; Peek a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">primitive</span></span></span><span> </span><span id="local-6989586621679053772"><span class="annot"><span class="annottext">State# (PrimState Peek) -&gt; (# State# (PrimState Peek), a #)
</span><a href="#local-6989586621679053772"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PeekState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679053771"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053771"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>        </span><span id="local-6989586621679053770"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053770"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(State# (PrimState IO) -&gt; (# State# (PrimState IO), a #)) -&gt; IO a
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
(State# (PrimState m) -&gt; (# State# (PrimState m), a #)) -&gt; m a
</span><span class="hs-identifier hs-var">primitive</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, a #))
-&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
</span><span class="hs-identifier hs-var">unsafeCoerce#</span></span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, a #)
State# (PrimState Peek) -&gt; (# State# (PrimState Peek), a #)
</span><a href="#local-6989586621679053772"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">PeekResult a -&gt; IO (PeekResult a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult a -&gt; IO (PeekResult a))
-&gt; PeekResult a -&gt; IO (PeekResult a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; a -&gt; PeekResult a
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053771"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053770"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">primitive</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621679053767"><span class="annot"><span class="annottext">liftIO :: IO a -&gt; Peek a
</span><a href="#local-6989586621679053767"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftIO</span></a></span></span><span> </span><span id="local-6989586621679053766"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679053766"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">PeekState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679053765"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053765"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; a -&gt; PeekResult a
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053765"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; PeekResult a) -&gt; IO a -&gt; IO (PeekResult a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679053766"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">liftIO</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="hs-comment">-- | Holds a 'peekStatePtr', which is passed in to each 'Peek' action.</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- If the package is built with the 'force-alignment' flag, this also</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- has a hidden 'Ptr' field, which is used as scratch space during</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- unaligned reads.</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">PeekState</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">PeekState</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">peekStateEndPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">peekStateAlignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-special">}</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">newtype</span><span> </span><span id="PeekState"><span class="annot"><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-var">PeekState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeekState"><span class="annot"><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-var">PeekState</span></a></span></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="peekStateEndPtr"><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier hs-var hs-var">peekStateEndPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-special">}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- | Make a 'PeekState' from a buffer pointer.</span><span>
</span><span id="line-271"></span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- The first argument is a pointer to the memory to write to. The second</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- argument is an IO action which is invoked if the store-core package</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- was built with the @force-alignment@ flag. The action should yield a</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- pointer to scratch memory as large as 'maybeAlignmentBufferSize'.</span><span>
</span><span id="line-276"></span><span class="hs-comment">--</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- Since 0.4.2</span><span>
</span><span id="line-278"></span><span class="annot"><a href="Data.Store.Core.html#unsafeMakePeekState"><span class="hs-identifier hs-type">unsafeMakePeekState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-comment">-- ^ peekStateEndPtr</span><span>
</span><span id="line-279"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ action to produce peekStateAlignPtr</span><span>
</span><span id="line-280"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-type">PeekState</span></a></span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span class="hs-identifier">unsafeMakePeekState</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">PeekState</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">f</span><span class="hs-cpp">
#else
</span><span id="unsafeMakePeekState"><span class="annot"><span class="annottext">unsafeMakePeekState :: Ptr Word8 -&gt; IO (Ptr Word8) -&gt; IO PeekState
</span><a href="Data.Store.Core.html#unsafeMakePeekState"><span class="hs-identifier hs-var hs-var">unsafeMakePeekState</span></a></span></span><span> </span><span id="local-6989586621679053763"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053763"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="annot"><span class="annottext">IO (Ptr Word8)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; IO PeekState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; IO PeekState) -&gt; PeekState -&gt; IO PeekState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; PeekState
</span><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-var">PeekState</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053763"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- | Exception thrown while running 'peek'. Note that other types of</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- exceptions can also be thrown. Invocations of 'fail' in the 'Poke'</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- monad causes this exception to be thrown.</span><span>
</span><span id="line-290"></span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- 'PeekException' is thrown when the data being decoded is invalid.</span><span>
</span><span id="line-292"></span><span class="hs-keyword">data</span><span> </span><span id="PeekException"><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PeekException"><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="peekExBytesFromEnd"><span class="annot"><span class="annottext">PeekException -&gt; Offset
</span><a href="Data.Store.Core.html#peekExBytesFromEnd"><span class="hs-identifier hs-var hs-var">peekExBytesFromEnd</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="peekExMessage"><span class="annot"><span class="annottext">PeekException -&gt; Text
</span><a href="Data.Store.Core.html#peekExMessage"><span class="hs-identifier hs-var hs-var">peekExMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679053756"><span id="local-6989586621679053758"><span class="annot"><span class="annottext">PeekException -&gt; PeekException -&gt; Bool
(PeekException -&gt; PeekException -&gt; Bool)
-&gt; (PeekException -&gt; PeekException -&gt; Bool) -&gt; Eq PeekException
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PeekException -&gt; PeekException -&gt; Bool
$c/= :: PeekException -&gt; PeekException -&gt; Bool
== :: PeekException -&gt; PeekException -&gt; Bool
$c== :: PeekException -&gt; PeekException -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053750"><span id="local-6989586621679053752"><span id="local-6989586621679053754"><span class="annot"><span class="annottext">Offset -&gt; PeekException -&gt; ShowS
[PeekException] -&gt; ShowS
PeekException -&gt; String
(Offset -&gt; PeekException -&gt; ShowS)
-&gt; (PeekException -&gt; String)
-&gt; ([PeekException] -&gt; ShowS)
-&gt; Show PeekException
forall a.
(Offset -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PeekException] -&gt; ShowS
$cshowList :: [PeekException] -&gt; ShowS
show :: PeekException -&gt; String
$cshow :: PeekException -&gt; String
showsPrec :: Offset -&gt; PeekException -&gt; ShowS
$cshowsPrec :: Offset -&gt; PeekException -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053744"><span id="local-6989586621679053746"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-type">PeekException</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span class="hs-cpp">
#if MIN_VERSION_base(4,8,0)
</span><span>    </span><span id="local-6989586621679053742"><span class="annot"><span class="annottext">displayException :: PeekException -&gt; String
</span><a href="#local-6989586621679053742"><span class="hs-identifier hs-var hs-var hs-var hs-var">displayException</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-type">PeekException</span></a></span><span> </span><span id="local-6989586621679053741"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053741"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621679053740"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053740"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Exception while peeking, &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053741"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; bytes from end: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053740"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- | Throws a 'PeekException'.</span><span>
</span><span id="line-307"></span><span id="local-6989586621679054034"><span class="annot"><a href="Data.Store.Core.html#peekException"><span class="hs-identifier hs-type">peekException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054034"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-308"></span><span id="peekException"><span class="annot"><span class="annottext">peekException :: Text -&gt; Peek a
</span><a href="Data.Store.Core.html#peekException"><span class="hs-identifier hs-var hs-var">peekException</span></a></span></span><span> </span><span id="local-6989586621679053739"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053739"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053738"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053738"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679053737"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053737"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeekException -&gt; IO (PeekResult a)
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PeekException
</span><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier hs-var hs-var">peekStateEndPtr</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053738"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053737"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679053739"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">-- | Throws a 'PeekException' about an attempt to read too many bytes.</span><span>
</span><span id="line-311"></span><span id="local-6989586621679053977"><span class="annot"><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier hs-type">tooManyBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679053977"><span class="hs-identifier hs-type">void</span></a></span></span><span>
</span><span id="line-312"></span><span id="tooManyBytes"><span class="annot"><span class="annottext">tooManyBytes :: Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier hs-var hs-var">tooManyBytes</span></a></span></span><span> </span><span id="local-6989586621679053735"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053735"><span class="hs-identifier hs-var">needed</span></a></span></span><span> </span><span id="local-6989586621679053734"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053734"><span class="hs-identifier hs-var">remaining</span></a></span></span><span> </span><span id="local-6989586621679053733"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053733"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">PeekException -&gt; IO void
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PeekException -&gt; IO void) -&gt; PeekException -&gt; IO void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PeekException
</span><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053734"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PeekException) -&gt; Text -&gt; PeekException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-314"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Attempted to read too many bytes for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053733"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;. Needed &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053735"><span class="hs-identifier hs-var">needed</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, but only &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053734"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; remain.&quot;</span></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | Throws a 'PeekException' about an attempt to read a negative number of bytes.</span><span>
</span><span id="line-321"></span><span class="hs-comment">--</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- This can happen when we read invalid data -- the length tag is</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- basically random in this case.</span><span>
</span><span id="line-324"></span><span id="local-6989586621679053732"><span class="annot"><a href="Data.Store.Core.html#negativeBytes"><span class="hs-identifier hs-type">negativeBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679053732"><span class="hs-identifier hs-type">void</span></a></span></span><span>
</span><span id="line-325"></span><span id="negativeBytes"><span class="annot"><span class="annottext">negativeBytes :: Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#negativeBytes"><span class="hs-identifier hs-var hs-var">negativeBytes</span></a></span></span><span> </span><span id="local-6989586621679053730"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053730"><span class="hs-identifier hs-var">needed</span></a></span></span><span> </span><span id="local-6989586621679053729"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053729"><span class="hs-identifier hs-var">remaining</span></a></span></span><span> </span><span id="local-6989586621679053728"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053728"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">PeekException -&gt; IO void
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PeekException -&gt; IO void) -&gt; PeekException -&gt; IO void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PeekException
</span><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053729"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PeekException) -&gt; Text -&gt; PeekException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Attempted to read negative number of bytes for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053728"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;. Tried to read &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053730"><span class="hs-identifier hs-var">needed</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.  This probably means that we're trying to read invalid data.&quot;</span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- Decoding and encoding ByteStrings</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- | Given a 'Poke' and its length, uses it to fill a 'ByteString'</span><span>
</span><span id="line-337"></span><span class="hs-comment">--</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- This function is unsafe because the provided length must exactly</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- match the number of bytes used by the 'Poke'. It will throw</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- 'PokeException' errors when the buffer is under or overshot. However,</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- in the case of overshooting the buffer, memory corruption and</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- segfaults may occur.</span><span>
</span><span id="line-343"></span><span class="annot"><a href="Data.Store.Core.html#unsafeEncodeWith"><span class="hs-identifier hs-type">unsafeEncodeWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-344"></span><span id="unsafeEncodeWith"><span class="annot"><span class="annottext">unsafeEncodeWith :: Poke () -&gt; Offset -&gt; ByteString
</span><a href="Data.Store.Core.html#unsafeEncodeWith"><span class="hs-identifier hs-var hs-var">unsafeEncodeWith</span></a></span></span><span> </span><span id="local-6989586621679053727"><span class="annot"><span class="annottext">Poke ()
</span><a href="#local-6989586621679053727"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679053726"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053726"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">Offset -&gt; (Ptr Word8 -&gt; IO ()) -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.unsafeCreate</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053726"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053724"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053724"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>    </span><span class="hs-identifier">allocaBytesAligned</span><span> </span><span class="hs-identifier">alignBufferSize</span><span> </span><span class="hs-number">8</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">aptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
#endif
</span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053723"><span class="annot"><span class="annottext">ps :: PokeState
</span><a href="#local-6989586621679053723"><span class="hs-identifier hs-var hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeState :: Ptr Word8 -&gt; PokeState
</span><a href="Data.Store.Core.html#PokeState"><span class="hs-identifier hs-type">PokeState</span></a></span><span>
</span><span id="line-350"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pokeStatePtr :: Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var">pokeStatePtr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053724"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pokeStateAlignPtr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">aptr</span><span class="hs-cpp">
#endif
</span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679053722"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053722"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Poke () -&gt; PokeState -&gt; Offset -&gt; IO (Offset, ())
forall a. Poke a -&gt; PokeState -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#runPoke"><span class="hs-identifier hs-var hs-var">runPoke</span></a></span><span> </span><span class="annot"><span class="annottext">Poke ()
</span><a href="#local-6989586621679053727"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053723"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#checkOffset"><span class="hs-identifier hs-var">checkOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053722"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053726"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-cpp">

#if ALIGNED_MEMORY
</span><span class="hs-identifier">alignBufferSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span>
</span><span id="line-360"></span><span class="hs-identifier">alignBufferSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">32</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- | If store-core is built with the @force-alignment@ flag, then this</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- will be a 'Just' value indicating the amount of memory that is</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- expected in the alignment buffer used by 'PeekState' and 'PokeState'.</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- Currently this will either be @Just 32@ or @Nothing@.</span><span>
</span><span id="line-367"></span><span class="annot"><a href="Data.Store.Core.html#maybeAlignmentBufferSize"><span class="hs-identifier hs-type">maybeAlignmentBufferSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-368"></span><span id="maybeAlignmentBufferSize"><span class="annot"><span class="annottext">maybeAlignmentBufferSize :: Maybe Offset
</span><a href="Data.Store.Core.html#maybeAlignmentBufferSize"><span class="hs-identifier hs-var hs-var">maybeAlignmentBufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>  </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">alignBufferSize</span><span class="hs-cpp">
#else
</span><span>  </span><span class="annot"><span class="annottext">Maybe Offset
forall k1. Maybe k1
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- | Checks if the offset matches the expected length, and throw a</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- 'PokeException' otherwise.</span><span>
</span><span id="line-377"></span><span class="annot"><a href="Data.Store.Core.html#checkOffset"><span class="hs-identifier hs-type">checkOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span id="checkOffset"><span class="annot"><span class="annottext">checkOffset :: Offset -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#checkOffset"><span class="hs-identifier hs-var hs-var">checkOffset</span></a></span></span><span> </span><span id="local-6989586621679053720"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053720"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679053719"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053719"><span class="hs-identifier hs-var">l</span></a></span></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053720"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053719"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PokeException -&gt; IO ()) -&gt; PokeException -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PokeException
</span><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-var">PokeException</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053720"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PokeException) -&gt; Text -&gt; PokeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;encode overshot end of &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053719"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; byte long buffer&quot;</span></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053720"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053719"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PokeException -&gt; IO ()) -&gt; PokeException -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PokeException
</span><a href="Data.Store.Core.html#PokeException"><span class="hs-identifier hs-var">PokeException</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053720"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PokeException) -&gt; Text -&gt; PokeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;encode undershot end of &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-385"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053719"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; byte long buffer&quot;</span></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="hs-comment">-- | Decodes a value from a 'ByteString', potentially throwing</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- exceptions, and taking a 'Peek' to run. It is an exception to not</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- consume all input.</span><span>
</span><span id="line-392"></span><span id="local-6989586621679053716"><span class="annot"><a href="Data.Store.Core.html#decodeWith"><span class="hs-identifier hs-type">decodeWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053716"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-type">PeekException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053716"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-393"></span><span id="decodeWith"><span class="annot"><span class="annottext">decodeWith :: Peek a -&gt; ByteString -&gt; Either PeekException a
</span><a href="Data.Store.Core.html#decodeWith"><span class="hs-identifier hs-var hs-var">decodeWith</span></a></span></span><span> </span><span id="local-6989586621679053715"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053715"><span class="hs-identifier hs-var">mypeek</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Either PeekException a) -&gt; Either PeekException a
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either PeekException a) -&gt; Either PeekException a)
-&gt; (ByteString -&gt; IO (Either PeekException a))
-&gt; ByteString
-&gt; Either PeekException a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO (Either PeekException a)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO (Either PeekException a))
-&gt; (ByteString -&gt; IO a)
-&gt; ByteString
-&gt; IO (Either PeekException a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; ByteString -&gt; IO a
forall a. Peek a -&gt; ByteString -&gt; IO a
</span><a href="Data.Store.Core.html#decodeIOWith"><span class="hs-identifier hs-var">decodeIOWith</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053715"><span class="hs-identifier hs-var">mypeek</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- | Decodes a value from a 'ByteString', potentially throwing</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- exceptions, and taking a 'Peek' to run. It is an exception to not</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- consume all input.</span><span>
</span><span id="line-398"></span><span id="local-6989586621679053714"><span class="annot"><a href="Data.Store.Core.html#decodeExWith"><span class="hs-identifier hs-type">decodeExWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053714"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679053714"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-399"></span><span id="decodeExWith"><span class="annot"><span class="annottext">decodeExWith :: Peek a -&gt; ByteString -&gt; a
</span><a href="Data.Store.Core.html#decodeExWith"><span class="hs-identifier hs-var hs-var">decodeExWith</span></a></span></span><span> </span><span id="local-6989586621679053713"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053713"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; a
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; a) -&gt; (ByteString -&gt; IO a) -&gt; ByteString -&gt; a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; ByteString -&gt; IO a
forall a. Peek a -&gt; ByteString -&gt; IO a
</span><a href="Data.Store.Core.html#decodeIOWith"><span class="hs-identifier hs-var">decodeIOWith</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053713"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="hs-comment">-- | Similar to 'decodeExWith', but it allows there to be more of the</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- buffer remaining. The 'Offset' of the buffer contents immediately</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- after the decoded value is returned.</span><span>
</span><span id="line-404"></span><span id="local-6989586621679053712"><span class="annot"><a href="Data.Store.Core.html#decodeExPortionWith"><span class="hs-identifier hs-type">decodeExPortionWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053712"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679053712"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-405"></span><span id="decodeExPortionWith"><span class="annot"><span class="annottext">decodeExPortionWith :: Peek a -&gt; ByteString -&gt; (Offset, a)
</span><a href="Data.Store.Core.html#decodeExPortionWith"><span class="hs-identifier hs-var hs-var">decodeExPortionWith</span></a></span></span><span> </span><span id="local-6989586621679053711"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053711"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Offset, a) -&gt; (Offset, a)
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Offset, a) -&gt; (Offset, a))
-&gt; (ByteString -&gt; IO (Offset, a)) -&gt; ByteString -&gt; (Offset, a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; ByteString -&gt; IO (Offset, a)
forall a. Peek a -&gt; ByteString -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#decodeIOPortionWith"><span class="hs-identifier hs-var">decodeIOPortionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="hs-comment">-- | Decodes a value from a 'ByteString', potentially throwing</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- exceptions, and taking a 'Peek' to run. It is an exception to not</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- consume all input.</span><span>
</span><span id="line-410"></span><span id="local-6989586621679054010"><span class="annot"><a href="Data.Store.Core.html#decodeIOWith"><span class="hs-identifier hs-type">decodeIOWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679054010"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-411"></span><span id="decodeIOWith"><span class="annot"><span class="annottext">decodeIOWith :: Peek a -&gt; ByteString -&gt; IO a
</span><a href="Data.Store.Core.html#decodeIOWith"><span class="hs-identifier hs-var hs-var">decodeIOWith</span></a></span></span><span> </span><span id="local-6989586621679053710"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053710"><span class="hs-identifier hs-var">mypeek</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BS.PS</span></span><span> </span><span id="local-6989586621679053708"><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053708"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679053707"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053707"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679053706"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053706"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">ForeignPtr Word8 -&gt; (Ptr Word8 -&gt; IO a) -&gt; IO a
forall a b. ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053708"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO a) -&gt; IO a) -&gt; (Ptr Word8 -&gt; IO a) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053705"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053705"><span class="hs-identifier hs-var">ptr0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-413"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053704"><span class="annot"><span class="annottext">ptr :: Ptr Word8
</span><a href="#local-6989586621679053704"><span class="hs-identifier hs-var hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053705"><span class="hs-identifier hs-var">ptr0</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053707"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO a
forall a. Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO a
</span><a href="Data.Store.Core.html#decodeIOWithFromPtr"><span class="hs-identifier hs-var">decodeIOWithFromPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053710"><span class="hs-identifier hs-var">mypeek</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053704"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053706"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="hs-comment">-- | Similar to 'decodeExPortionWith', but runs in the 'IO' monad.</span><span>
</span><span id="line-417"></span><span id="local-6989586621679054007"><span class="annot"><a href="Data.Store.Core.html#decodeIOPortionWith"><span class="hs-identifier hs-type">decodeIOPortionWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054007"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679054007"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-418"></span><span id="decodeIOPortionWith"><span class="annot"><span class="annottext">decodeIOPortionWith :: Peek a -&gt; ByteString -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#decodeIOPortionWith"><span class="hs-identifier hs-var hs-var">decodeIOPortionWith</span></a></span></span><span> </span><span id="local-6989586621679053702"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053702"><span class="hs-identifier hs-var">mypeek</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BS.PS</span></span><span> </span><span id="local-6989586621679053701"><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053701"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679053700"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053700"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679053699"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053699"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><span class="annottext">ForeignPtr Word8 -&gt; (Ptr Word8 -&gt; IO (Offset, a)) -&gt; IO (Offset, a)
forall a b. ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053701"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO (Offset, a)) -&gt; IO (Offset, a))
-&gt; (Ptr Word8 -&gt; IO (Offset, a)) -&gt; IO (Offset, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053698"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053698"><span class="hs-identifier hs-var">ptr0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053697"><span class="annot"><span class="annottext">ptr :: Ptr Word8
</span><a href="#local-6989586621679053697"><span class="hs-identifier hs-var hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053698"><span class="hs-identifier hs-var">ptr0</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053700"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO (Offset, a)
forall a. Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#decodeIOPortionWithFromPtr"><span class="hs-identifier hs-var">decodeIOPortionWithFromPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053702"><span class="hs-identifier hs-var">mypeek</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053697"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053699"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-comment">-- | Like 'decodeIOWith', but using 'Ptr' and length instead of a</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- 'ByteString'.</span><span>
</span><span id="line-425"></span><span id="local-6989586621679054000"><span class="annot"><a href="Data.Store.Core.html#decodeIOWithFromPtr"><span class="hs-identifier hs-type">decodeIOWithFromPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054000"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679054000"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-426"></span><span id="decodeIOWithFromPtr"><span class="annot"><span class="annottext">decodeIOWithFromPtr :: Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO a
</span><a href="Data.Store.Core.html#decodeIOWithFromPtr"><span class="hs-identifier hs-var hs-var">decodeIOWithFromPtr</span></a></span></span><span> </span><span id="local-6989586621679053696"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053696"><span class="hs-identifier hs-var">mypeek</span></a></span></span><span> </span><span id="local-6989586621679053695"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053695"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679053694"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053694"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679053693"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053693"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053692"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053692"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO (Offset, a)
forall a. Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#decodeIOPortionWithFromPtr"><span class="hs-identifier hs-var">decodeIOPortionWithFromPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053696"><span class="hs-identifier hs-var">mypeek</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053695"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053694"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053694"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053693"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PeekException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PeekException -&gt; IO a) -&gt; PeekException -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PeekException
</span><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053694"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Offset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053693"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Didn't consume all input.&quot;</span></span><span>
</span><span id="line-430"></span><span>       </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053692"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-comment">-- | Like 'decodeIOPortionWith', but using 'Ptr' and length instead of a 'ByteString'.</span><span>
</span><span id="line-433"></span><span id="local-6989586621679053998"><span class="annot"><a href="Data.Store.Core.html#decodeIOPortionWithFromPtr"><span class="hs-identifier hs-type">decodeIOPortionWithFromPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053998"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.Core.html#Offset"><span class="hs-identifier hs-type">Offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679053998"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-434"></span><span id="decodeIOPortionWithFromPtr"><span class="annot"><span class="annottext">decodeIOPortionWithFromPtr :: Peek a -&gt; Ptr Word8 -&gt; Offset -&gt; IO (Offset, a)
</span><a href="Data.Store.Core.html#decodeIOPortionWithFromPtr"><span class="hs-identifier hs-var hs-var">decodeIOPortionWithFromPtr</span></a></span></span><span> </span><span id="local-6989586621679053690"><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053690"><span class="hs-identifier hs-var">mypeek</span></a></span></span><span> </span><span id="local-6989586621679053689"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053689"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679053688"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053688"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053687"><span class="annot"><span class="annottext">end :: Ptr Word8
</span><a href="#local-6989586621679053687"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053689"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053688"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span id="local-6989586621679053686"><span class="annot"><span class="annottext">remaining :: Offset
</span><a href="#local-6989586621679053686"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053687"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053689"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-type">PeekResult</span></a></span><span> </span><span id="local-6989586621679053685"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053685"><span class="hs-identifier hs-var">ptr2</span></a></span></span><span> </span><span id="local-6989586621679053684"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053684"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>              </span><span class="hs-identifier">allocaBytesAligned</span><span> </span><span class="hs-identifier">alignBufferSize</span><span> </span><span class="hs-number">8</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">aptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                  </span><span class="hs-identifier">runPeek</span><span> </span><span class="hs-identifier">mypeek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">PeekState</span><span> </span><span class="hs-identifier">end</span><span> </span><span class="hs-identifier">aptr</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-cpp">
#else
</span><span>              </span><span class="annot"><span class="annottext">Peek a -&gt; PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
forall a. Peek a -&gt; PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)
</span><a href="Data.Store.Core.html#runPeek"><span class="hs-identifier hs-var hs-var">runPeek</span></a></span><span> </span><span class="annot"><span class="annottext">Peek a
</span><a href="#local-6989586621679053690"><span class="hs-identifier hs-var">mypeek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; PeekState
</span><a href="Data.Store.Core.html#PeekState"><span class="hs-identifier hs-var">PeekState</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053687"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053689"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-cpp">
#endif
</span><span>        </span><span class="hs-comment">-- TODO: consider moving this condition to before running the peek?</span><span>
</span><span id="line-445"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053688"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053686"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="hs-comment">-- Do not perform the check on the new pointer, since it could have overflowed</span><span>
</span><span id="line-446"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PeekException -&gt; IO (Offset, a)
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(PeekException -&gt; IO (Offset, a))
-&gt; PeekException -&gt; IO (Offset, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Text -&gt; PeekException
</span><a href="Data.Store.Core.html#PeekException"><span class="hs-identifier hs-var">PeekException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053687"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053685"><span class="hs-identifier hs-var">ptr2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Overshot end of buffer&quot;</span></span><span>
</span><span id="line-447"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Offset, a) -&gt; IO (Offset, a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053685"><span class="hs-identifier hs-var">ptr2</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053689"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053684"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- Utilities for defining 'Store' instances based on 'Storable'</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span class="hs-comment">-- | A 'poke' implementation based on an instance of 'Storable'.</span><span>
</span><span id="line-453"></span><span id="local-6989586621679053683"><span class="annot"><a href="Data.Store.Core.html#pokeStorable"><span class="hs-identifier hs-type">pokeStorable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679053683"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679053683"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-454"></span><span id="pokeStorable"><span class="annot"><span class="annottext">pokeStorable :: a -&gt; Poke ()
</span><a href="Data.Store.Core.html#pokeStorable"><span class="hs-identifier hs-var hs-var">pokeStorable</span></a></span></span><span> </span><span id="local-6989586621679053682"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053682"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ())
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053681"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053681"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679053680"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053680"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053679"><span class="annot"><span class="annottext">targetPtr :: Ptr a
</span><a href="#local-6989586621679053679"><span class="hs-identifier hs-var hs-var">targetPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var hs-var">pokeStatePtr</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053681"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr a
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053680"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>    </span><span class="hs-comment">-- If necessary, poke into the scratch buffer, and copy the results</span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-comment">-- to the output buffer.</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">bufStart</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pokeStateAlignPtr</span><span> </span><span class="hs-identifier">ps</span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-identifier">alignStart</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alignPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pokeStateAlignPtr</span><span> </span><span class="hs-identifier">ps</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alignment</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-identifier">sz</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-identifier">x</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">targetPtr</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">alignPtr</span><span> </span><span class="hs-identifier">targetPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alignment</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>        </span><span class="hs-comment">-- If we luck out and the output is already aligned, just poke it</span><span>
</span><span id="line-464"></span><span>        </span><span class="hs-comment">-- directly.</span><span>
</span><span id="line-465"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier">targetPtr</span><span> </span><span class="hs-identifier">x</span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alignStart</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufStart</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">alignBufferSize</span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>                </span><span class="hs-identifier">poke</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">alignStart</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">x</span><span>
</span><span id="line-469"></span><span>                </span><span class="hs-identifier">BS.memcpy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">targetPtr</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">alignStart</span><span> </span><span class="hs-identifier">sz</span><span>
</span><span id="line-470"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>                </span><span class="hs-identifier">allocaBytesAligned</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alignment</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">tempPtr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>                    </span><span class="hs-identifier">poke</span><span> </span><span class="hs-identifier">tempPtr</span><span> </span><span class="hs-identifier">x</span><span>
</span><span id="line-473"></span><span>                    </span><span class="hs-identifier">BS.memcpy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">targetPtr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">tempPtr</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>    </span><span class="annot"><span class="annottext">Ptr a -&gt; a -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679053679"><span class="hs-identifier hs-var">targetPtr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053682"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-cpp">
#endif
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053677"><span class="annot"><span class="annottext">newOffset :: Offset
</span><a href="#local-6989586621679053677"><span class="hs-identifier hs-var hs-var">newOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053680"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Offset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Offset
forall a. Storable a =&gt; a -&gt; Offset
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053682"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><span class="annottext">(Offset, ()) -&gt; IO (Offset, ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053677"><span class="hs-identifier hs-var">newOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Store.Core.html#pokeStorable"><span class="hs-pragma hs-type">pokeStorable</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="hs-comment">-- FIXME: make it the responsibility of the caller to check this.</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="hs-comment">-- | A 'peek' implementation based on an instance of 'Storable' and</span><span>
</span><span id="line-484"></span><span class="hs-comment">-- 'Typeable'.</span><span>
</span><span id="line-485"></span><span class="annot"><a href="Data.Store.Core.html#peekStorable"><span class="hs-identifier hs-type">peekStorable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679053674"><span class="annot"><a href="#local-6989586621679053674"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679053674"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679053674"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053674"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-486"></span><span id="peekStorable"><span class="annot"><span class="annottext">peekStorable :: Peek a
</span><a href="Data.Store.Core.html#peekStorable"><span class="hs-identifier hs-var hs-var">peekStorable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Peek a
forall a. Storable a =&gt; String -&gt; Peek a
</span><a href="Data.Store.Core.html#peekStorableTy"><span class="hs-identifier hs-var">peekStorableTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeRep -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy a -&gt; TypeRep
forall k (proxy :: k -&gt; *) (a :: k).
Typeable a =&gt;
proxy a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy a
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621679053674"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekStorable"><span class="hs-pragma hs-type">peekStorable</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-comment">-- | A 'peek' implementation based on an instance of 'Storable'. Use</span><span>
</span><span id="line-490"></span><span class="hs-comment">-- this if the type is not 'Typeable'.</span><span>
</span><span id="line-491"></span><span class="annot"><a href="Data.Store.Core.html#peekStorableTy"><span class="hs-identifier hs-type">peekStorableTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679053990"><span class="annot"><a href="#local-6989586621679053990"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679053990"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053990"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-492"></span><span id="peekStorableTy"><span class="annot"><span class="annottext">peekStorableTy :: String -&gt; Peek a
</span><a href="Data.Store.Core.html#peekStorableTy"><span class="hs-identifier hs-var hs-var">peekStorableTy</span></a></span></span><span> </span><span id="local-6989586621679053671"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053671"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053670"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053670"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679053669"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053669"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053668"><span class="annot"><span class="annottext">ptr' :: Ptr Word8
</span><a href="#local-6989586621679053668"><span class="hs-identifier hs-var hs-var">ptr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053669"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053667"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span id="local-6989586621679053667"><span class="annot"><span class="annottext">sz :: Offset
</span><a href="#local-6989586621679053667"><span class="hs-identifier hs-var hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Offset
forall a. Storable a =&gt; a -&gt; Offset
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679053990"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>        </span><span id="local-6989586621679053665"><span class="annot"><span class="annottext">remaining :: Offset
</span><a href="#local-6989586621679053665"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier hs-var hs-var">peekStateEndPtr</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053670"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053669"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053667"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053665"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Do not perform the check on the new pointer, since it could have overflowed</span><span>
</span><span id="line-497"></span><span>        </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; String -&gt; IO ()
forall void. Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier hs-var">tooManyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053667"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053665"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053671"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-cpp">
#if ALIGNED_MEMORY
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">bufStart</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">peekStateAlignPtr</span><span> </span><span class="hs-identifier">ps</span><span>
</span><span id="line-500"></span><span>        </span><span class="hs-identifier">alignStart</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alignPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peekStateAlignPtr</span><span> </span><span class="hs-identifier">ps</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">alignAmount</span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-identifier">alignAmount</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alignment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-identifier">x</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">alignPtr</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">alignAmount</span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">Storable.peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alignStart</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bufStart</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">alignBufferSize</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>                </span><span class="hs-identifier">BS.memcpy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">alignStart</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-identifier">sz</span><span>
</span><span id="line-507"></span><span>                </span><span class="hs-identifier">Storable.peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">alignStart</span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>                </span><span class="hs-identifier">allocaBytesAligned</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-identifier">alignAmount</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">tempPtr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>                    </span><span class="hs-identifier">BS.memcpy</span><span> </span><span class="hs-identifier">tempPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">sz</span><span>
</span><span id="line-511"></span><span>                    </span><span class="hs-identifier">Storable.peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">tempPtr</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>    </span><span id="local-6989586621679053664"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053664"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO a
forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">Storable.peek</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr a
forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053669"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="annottext">PeekResult a -&gt; IO (PeekResult a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult a -&gt; IO (PeekResult a))
-&gt; PeekResult a -&gt; IO (PeekResult a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; a -&gt; PeekResult a
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053668"><span class="hs-identifier hs-var">ptr'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679053664"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-516"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Store.Core.html#peekStorableTy"><span class="hs-pragma hs-type">peekStorableTy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- Utilities for implementing 'Store' instances via memcpy</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-comment">-- | Copy a section of memory, based on a 'ForeignPtr', to the output.</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- Note that this operation is unsafe, the offset and length parameters</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- are not checked.</span><span>
</span><span id="line-524"></span><span id="local-6989586621679053661"><span class="annot"><a href="Data.Store.Core.html#pokeFromForeignPtr"><span class="hs-identifier hs-type">pokeFromForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ForeignPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679053661"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-525"></span><span id="pokeFromForeignPtr"><span class="annot"><span class="annottext">pokeFromForeignPtr :: ForeignPtr a -&gt; Offset -&gt; Offset -&gt; Poke ()
</span><a href="Data.Store.Core.html#pokeFromForeignPtr"><span class="hs-identifier hs-var hs-var">pokeFromForeignPtr</span></a></span></span><span> </span><span id="local-6989586621679053660"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679053660"><span class="hs-identifier hs-var">sourceFp</span></a></span></span><span> </span><span id="local-6989586621679053659"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053659"><span class="hs-identifier hs-var">sourceOffset</span></a></span></span><span> </span><span id="local-6989586621679053658"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053658"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ())
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053657"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053657"><span class="hs-identifier hs-var">targetState</span></a></span></span><span> </span><span id="local-6989586621679053656"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053656"><span class="hs-identifier hs-var">targetOffset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053655"><span class="annot"><span class="annottext">targetPtr :: Ptr Word8
</span><a href="#local-6989586621679053655"><span class="hs-identifier hs-var hs-var">targetPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var hs-var">pokeStatePtr</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053657"><span class="hs-identifier hs-var">targetState</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; (Ptr a -&gt; IO ()) -&gt; IO ()
forall a b. ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679053660"><span class="hs-identifier hs-var">sourceFp</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr a -&gt; IO ()) -&gt; IO ()) -&gt; (Ptr a -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053654"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679053654"><span class="hs-identifier hs-var">sourcePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-529"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset -&gt; IO ()
</span><span class="hs-identifier hs-var">BS.memcpy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053655"><span class="hs-identifier hs-var">targetPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053656"><span class="hs-identifier hs-var">targetOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679053654"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053659"><span class="hs-identifier hs-var">sourceOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>                      </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053658"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053652"><span class="annot"><span class="annottext">newOffset :: Offset
</span><a href="#local-6989586621679053652"><span class="hs-identifier hs-var hs-var">newOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053656"><span class="hs-identifier hs-var">targetOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Offset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053658"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">(Offset, ()) -&gt; IO (Offset, ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053652"><span class="hs-identifier hs-var">newOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span class="hs-comment">-- | Allocate a plain ForeignPtr (no finalizers), of the specified</span><span>
</span><span id="line-536"></span><span class="hs-comment">-- length and fill it with bytes from the input.</span><span>
</span><span id="line-537"></span><span id="local-6989586621679053651"><span class="annot"><a href="Data.Store.Core.html#peekToPlainForeignPtr"><span class="hs-identifier hs-type">peekToPlainForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ForeignPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679053651"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-538"></span><span id="peekToPlainForeignPtr"><span class="annot"><span class="annottext">peekToPlainForeignPtr :: String -&gt; Offset -&gt; Peek (ForeignPtr a)
</span><a href="Data.Store.Core.html#peekToPlainForeignPtr"><span class="hs-identifier hs-var hs-var">peekToPlainForeignPtr</span></a></span></span><span> </span><span id="local-6989586621679053650"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053650"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679053649"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-539"></span><span>    </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult (ForeignPtr a)))
-&gt; Peek (ForeignPtr a)
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult (ForeignPtr a)))
 -&gt; Peek (ForeignPtr a))
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult (ForeignPtr a)))
-&gt; Peek (ForeignPtr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053648"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053648"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679053647"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053647"><span class="hs-identifier hs-var">sourcePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053646"><span class="annot"><span class="annottext">ptr2 :: Ptr Word8
</span><a href="#local-6989586621679053646"><span class="hs-identifier hs-var hs-var">ptr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053647"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-541"></span><span>            </span><span id="local-6989586621679053645"><span class="annot"><span class="annottext">remaining :: Offset
</span><a href="#local-6989586621679053645"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier hs-var hs-var">peekStateEndPtr</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053648"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053647"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span>
</span><span id="line-542"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053645"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Do not perform the check on the new pointer, since it could have overflowed</span><span>
</span><span id="line-543"></span><span>            </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; String -&gt; IO ()
forall void. Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier hs-var">tooManyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053645"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053650"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-544"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-545"></span><span>            </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; String -&gt; IO ()
forall void. Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#negativeBytes"><span class="hs-identifier hs-var">negativeBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053645"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053650"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-546"></span><span>        </span><span id="local-6989586621679053644"><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053644"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Offset -&gt; IO (ForeignPtr Word8)
forall a. Offset -&gt; IO (ForeignPtr a)
</span><span class="hs-identifier hs-var">BS.mallocByteString</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-547"></span><span>        </span><span class="annot"><span class="annottext">ForeignPtr Word8 -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ()
forall a b. ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053644"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ()) -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053642"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053642"><span class="hs-identifier hs-var">targetPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-548"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset -&gt; IO ()
</span><span class="hs-identifier hs-var">BS.memcpy</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053642"><span class="hs-identifier hs-var">targetPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053647"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053649"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="annot"><span class="annottext">PeekResult (ForeignPtr a) -&gt; IO (PeekResult (ForeignPtr a))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult (ForeignPtr a) -&gt; IO (PeekResult (ForeignPtr a)))
-&gt; PeekResult (ForeignPtr a) -&gt; IO (PeekResult (ForeignPtr a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; ForeignPtr a -&gt; PeekResult (ForeignPtr a)
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053646"><span class="hs-identifier hs-var">ptr2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignPtr Word8 -&gt; ForeignPtr a
forall a b. ForeignPtr a -&gt; ForeignPtr b
</span><span class="hs-identifier hs-var">castForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8
</span><a href="#local-6989586621679053644"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="hs-comment">-- | Copy a section of memory, based on a 'Ptr', to the output. Note</span><span>
</span><span id="line-552"></span><span class="hs-comment">-- that this operation is unsafe, because the offset and length</span><span>
</span><span id="line-553"></span><span class="hs-comment">-- parameters are not checked.</span><span>
</span><span id="line-554"></span><span id="local-6989586621679053641"><span class="annot"><a href="Data.Store.Core.html#pokeFromPtr"><span class="hs-identifier hs-type">pokeFromPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679053641"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-555"></span><span id="pokeFromPtr"><span class="annot"><span class="annottext">pokeFromPtr :: Ptr a -&gt; Offset -&gt; Offset -&gt; Poke ()
</span><a href="Data.Store.Core.html#pokeFromPtr"><span class="hs-identifier hs-var hs-var">pokeFromPtr</span></a></span></span><span> </span><span id="local-6989586621679053640"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679053640"><span class="hs-identifier hs-var">sourcePtr</span></a></span></span><span> </span><span id="local-6989586621679053639"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053639"><span class="hs-identifier hs-var">sourceOffset</span></a></span></span><span> </span><span id="local-6989586621679053638"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053638"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ())
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053637"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053637"><span class="hs-identifier hs-var">targetState</span></a></span></span><span> </span><span id="local-6989586621679053636"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053636"><span class="hs-identifier hs-var">targetOffset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-557"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053635"><span class="annot"><span class="annottext">targetPtr :: Ptr Word8
</span><a href="#local-6989586621679053635"><span class="hs-identifier hs-var hs-var">targetPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PokeState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var hs-var">pokeStatePtr</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053637"><span class="hs-identifier hs-var">targetState</span></a></span><span>
</span><span id="line-558"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset -&gt; IO ()
</span><span class="hs-identifier hs-var">BS.memcpy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053635"><span class="hs-identifier hs-var">targetPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053636"><span class="hs-identifier hs-var">targetOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679053640"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053639"><span class="hs-identifier hs-var">sourceOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>                  </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053638"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-561"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053634"><span class="annot"><span class="annottext">newOffset :: Offset
</span><a href="#local-6989586621679053634"><span class="hs-identifier hs-var hs-var">newOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053636"><span class="hs-identifier hs-var">targetOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Offset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053638"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-562"></span><span>        </span><span class="annot"><span class="annottext">(Offset, ()) -&gt; IO (Offset, ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053634"><span class="hs-identifier hs-var">newOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="hs-comment">-- TODO: have a safer variant with the check?</span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="hs-comment">-- | Copy a section of memory, based on a 'ByteArray#', to the output.</span><span>
</span><span id="line-567"></span><span class="hs-comment">-- Note that this operation is unsafe, because the offset and length</span><span>
</span><span id="line-568"></span><span class="hs-comment">-- parameters are not checked.</span><span>
</span><span id="line-569"></span><span class="annot"><a href="Data.Store.Core.html#pokeFromByteArray"><span class="hs-identifier hs-type">pokeFromByteArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArray#</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-type">Poke</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span id="pokeFromByteArray"><span class="annot"><span class="annottext">pokeFromByteArray :: ByteArray# -&gt; Offset -&gt; Offset -&gt; Poke ()
</span><a href="Data.Store.Core.html#pokeFromByteArray"><span class="hs-identifier hs-var hs-var">pokeFromByteArray</span></a></span></span><span> </span><span id="local-6989586621679053633"><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679053633"><span class="hs-identifier hs-var">sourceArr</span></a></span></span><span> </span><span id="local-6989586621679053632"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053632"><span class="hs-identifier hs-var">sourceOffset</span></a></span></span><span> </span><span id="local-6989586621679053631"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053631"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>    </span><span class="annot"><span class="annottext">(PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a. (PokeState -&gt; Offset -&gt; IO (Offset, a)) -&gt; Poke a
</span><a href="Data.Store.Core.html#Poke"><span class="hs-identifier hs-var">Poke</span></a></span><span> </span><span class="annot"><span class="annottext">((PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ())
-&gt; (PokeState -&gt; Offset -&gt; IO (Offset, ())) -&gt; Poke ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053630"><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053630"><span class="hs-identifier hs-var">targetState</span></a></span></span><span> </span><span id="local-6989586621679053629"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053629"><span class="hs-identifier hs-var">targetOffset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053628"><span class="annot"><span class="annottext">target :: Ptr Any
</span><a href="#local-6989586621679053628"><span class="hs-identifier hs-var hs-var">target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PokeState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#pokeStatePtr"><span class="hs-identifier hs-var hs-var">pokeStatePtr</span></a></span><span> </span><span class="annot"><span class="annottext">PokeState
</span><a href="#local-6989586621679053630"><span class="hs-identifier hs-var">targetState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Any
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053629"><span class="hs-identifier hs-var">targetOffset</span></a></span><span>
</span><span id="line-573"></span><span>        </span><span class="annot"><span class="annottext">ByteArray# -&gt; Offset -&gt; Ptr Any -&gt; Offset -&gt; IO ()
forall a. ByteArray# -&gt; Offset -&gt; Ptr a -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#copyByteArrayToAddr"><span class="hs-identifier hs-var">copyByteArrayToAddr</span></a></span><span> </span><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679053633"><span class="hs-identifier hs-var">sourceArr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053632"><span class="hs-identifier hs-var">sourceOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Any
</span><a href="#local-6989586621679053628"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053631"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053626"><span class="annot"><span class="annottext">newOffset :: Offset
</span><a href="#local-6989586621679053626"><span class="hs-identifier hs-var hs-var">newOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053629"><span class="hs-identifier hs-var">targetOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Offset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053631"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-575"></span><span>        </span><span class="annot"><span class="annottext">(Offset, ()) -&gt; IO (Offset, ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053626"><span class="hs-identifier hs-var">newOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="hs-comment">-- | Allocate a ByteArray of the specified length and fill it with bytes</span><span>
</span><span id="line-578"></span><span class="hs-comment">-- from the input.</span><span>
</span><span id="line-579"></span><span class="annot"><a href="Data.Store.Core.html#peekToByteArray"><span class="hs-identifier hs-type">peekToByteArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-type">Peek</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArray</span></span><span>
</span><span id="line-580"></span><span id="peekToByteArray"><span class="annot"><span class="annottext">peekToByteArray :: String -&gt; Offset -&gt; Peek ByteArray
</span><a href="Data.Store.Core.html#peekToByteArray"><span class="hs-identifier hs-var hs-var">peekToByteArray</span></a></span></span><span> </span><span id="local-6989586621679053625"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053625"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621679053624"><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-581"></span><span>    </span><span class="annot"><span class="annottext">(PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult ByteArray))
-&gt; Peek ByteArray
forall a. (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult a)) -&gt; Peek a
</span><a href="Data.Store.Core.html#Peek"><span class="hs-identifier hs-var">Peek</span></a></span><span> </span><span class="annot"><span class="annottext">((PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult ByteArray))
 -&gt; Peek ByteArray)
-&gt; (PeekState -&gt; Ptr Word8 -&gt; IO (PeekResult ByteArray))
-&gt; Peek ByteArray
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679053623"><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053623"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679053622"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053622"><span class="hs-identifier hs-var">sourcePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053621"><span class="annot"><span class="annottext">ptr2 :: Ptr Word8
</span><a href="#local-6989586621679053621"><span class="hs-identifier hs-var hs-var">ptr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053622"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Offset -&gt; Ptr Word8
forall a b. Ptr a -&gt; Offset -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-583"></span><span>            </span><span id="local-6989586621679053620"><span class="annot"><span class="annottext">remaining :: Offset
</span><a href="#local-6989586621679053620"><span class="hs-identifier hs-var hs-var">remaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeekState -&gt; Ptr Word8
</span><a href="Data.Store.Core.html#peekStateEndPtr"><span class="hs-identifier hs-var hs-var">peekStateEndPtr</span></a></span><span> </span><span class="annot"><span class="annottext">PeekState
</span><a href="#local-6989586621679053623"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Offset
forall a b. Ptr a -&gt; Ptr b -&gt; Offset
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053622"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053620"><span class="hs-identifier hs-var">remaining</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- Do not perform the check on the new pointer, since it could have overflowed</span><span>
</span><span id="line-585"></span><span>            </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; String -&gt; IO ()
forall void. Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#tooManyBytes"><span class="hs-identifier hs-var">tooManyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053620"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053625"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-587"></span><span>            </span><span class="annot"><span class="annottext">Offset -&gt; Offset -&gt; String -&gt; IO ()
forall void. Offset -&gt; Offset -&gt; String -&gt; IO void
</span><a href="Data.Store.Core.html#negativeBytes"><span class="hs-identifier hs-var">negativeBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053620"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679053625"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span id="local-6989586621679053619"><span class="annot"><span class="annottext">MutableByteArray RealWorld
</span><a href="#local-6989586621679053619"><span class="hs-identifier hs-var">marr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Offset -&gt; IO (MutableByteArray (PrimState IO))
forall (m :: * -&gt; *).
PrimMonad m =&gt;
Offset -&gt; m (MutableByteArray (PrimState m))
</span><span class="hs-identifier hs-var">newByteArray</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-589"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8
-&gt; MutableByteArray (PrimState IO) -&gt; Offset -&gt; Offset -&gt; IO ()
forall a.
Ptr a
-&gt; MutableByteArray (PrimState IO) -&gt; Offset -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#copyAddrToByteArray"><span class="hs-identifier hs-var">copyAddrToByteArray</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053622"><span class="hs-identifier hs-var">sourcePtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray RealWorld
MutableByteArray (PrimState IO)
</span><a href="#local-6989586621679053619"><span class="hs-identifier hs-var">marr</span></a></span><span> </span><span class="annot"><span class="annottext">Offset
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Offset
</span><a href="#local-6989586621679053624"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span id="local-6989586621679053617"><span class="annot"><span class="annottext">ByteArray
</span><a href="#local-6989586621679053617"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MutableByteArray (PrimState IO) -&gt; IO ByteArray
forall (m :: * -&gt; *).
PrimMonad m =&gt;
MutableByteArray (PrimState m) -&gt; m ByteArray
</span><span class="hs-identifier hs-var">unsafeFreezeByteArray</span></span><span> </span><span class="annot"><span class="annottext">MutableByteArray RealWorld
MutableByteArray (PrimState IO)
</span><a href="#local-6989586621679053619"><span class="hs-identifier hs-var">marr</span></a></span><span>
</span><span id="line-591"></span><span>        </span><span class="annot"><span class="annottext">PeekResult ByteArray -&gt; IO (PeekResult ByteArray)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PeekResult ByteArray -&gt; IO (PeekResult ByteArray))
-&gt; PeekResult ByteArray -&gt; IO (PeekResult ByteArray)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; ByteArray -&gt; PeekResult ByteArray
forall a. Ptr Word8 -&gt; a -&gt; PeekResult a
</span><a href="Data.Store.Core.html#PeekResult"><span class="hs-identifier hs-var">PeekResult</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679053621"><span class="hs-identifier hs-var">ptr2</span></a></span><span> </span><span class="annot"><span class="annottext">ByteArray
</span><a href="#local-6989586621679053617"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- | Wrapper around @copyByteArrayToAddr#@ primop.</span><span>
</span><span id="line-594"></span><span id="local-6989586621679053968"><span class="annot"><a href="Data.Store.Core.html#copyByteArrayToAddr"><span class="hs-identifier hs-type">copyByteArrayToAddr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArray#</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679053968"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-595"></span><span id="copyByteArrayToAddr"><span class="annot"><span class="annottext">copyByteArrayToAddr :: ByteArray# -&gt; Offset -&gt; Ptr a -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#copyByteArrayToAddr"><span class="hs-identifier hs-var hs-var">copyByteArrayToAddr</span></a></span></span><span> </span><span id="local-6989586621679053616"><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679053616"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679053615"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053615"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span id="local-6989586621679053613"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679053613"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679053612"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053612"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-596"></span><span>    </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><span class="hs-identifier hs-var">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679053611"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679053611"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">ByteArray#
-&gt; Int# -&gt; Addr# -&gt; Int# -&gt; State# RealWorld -&gt; State# RealWorld
forall d.
ByteArray# -&gt; Int# -&gt; Addr# -&gt; Int# -&gt; State# d -&gt; State# d
</span><span class="hs-identifier hs-var">copyByteArrayToAddr#</span></span><span> </span><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679053616"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053615"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679053613"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053612"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679053611"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Store.Core.html#copyByteArrayToAddr"><span class="hs-pragma hs-type">copyByteArrayToAddr</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">-- | Wrapper around @copyAddrToByteArray#@ primop.</span><span>
</span><span id="line-600"></span><span id="local-6989586621679053964"><span class="annot"><a href="Data.Store.Core.html#copyAddrToByteArray"><span class="hs-identifier hs-type">copyAddrToByteArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679053964"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MutableByteArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PrimState</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-601"></span><span id="copyAddrToByteArray"><span class="annot"><span class="annottext">copyAddrToByteArray :: Ptr a
-&gt; MutableByteArray (PrimState IO) -&gt; Offset -&gt; Offset -&gt; IO ()
</span><a href="Data.Store.Core.html#copyAddrToByteArray"><span class="hs-identifier hs-var hs-var">copyAddrToByteArray</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span id="local-6989586621679053610"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679053610"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MutableByteArray</span></span><span> </span><span id="local-6989586621679053608"><span class="annot"><span class="annottext">MutableByteArray# (PrimState IO)
</span><a href="#local-6989586621679053608"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679053607"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053607"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679053606"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053606"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-602"></span><span>    </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><span class="hs-identifier hs-var">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679053605"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679053605"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Addr#
-&gt; MutableByteArray# RealWorld
-&gt; Int#
-&gt; Int#
-&gt; State# RealWorld
-&gt; State# RealWorld
forall d.
Addr#
-&gt; MutableByteArray# d -&gt; Int# -&gt; Int# -&gt; State# d -&gt; State# d
</span><span class="hs-identifier hs-var">copyAddrToByteArray#</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679053610"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
MutableByteArray# (PrimState IO)
</span><a href="#local-6989586621679053608"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053607"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679053606"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679053605"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Store.Core.html#copyAddrToByteArray"><span class="hs-pragma hs-type">copyAddrToByteArray</span></a></span><span>  </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-604"></span></pre></body></html>