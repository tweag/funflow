<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>dist-install/build/System/Posix/IO/Common.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LINE 1 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CApiFFI #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE NondecreasingIndentation #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE RecordWildCards #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-# LINE 5 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE Safe #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LINE 9 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-12"></a><span class='hs-comment'>-- |</span>
<a name="line-13"></a><span class='hs-comment'>-- Module      :  System.Posix.IO.Common</span>
<a name="line-14"></a><span class='hs-comment'>-- Copyright   :  (c) The University of Glasgow 2002</span>
<a name="line-15"></a><span class='hs-comment'>-- License     :  BSD-style (see the file libraries/base/LICENSE)</span>
<a name="line-16"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><span class='hs-comment'>-- Maintainer  :  libraries@haskell.org</span>
<a name="line-18"></a><span class='hs-comment'>-- Stability   :  provisional</span>
<a name="line-19"></a><span class='hs-comment'>-- Portability :  non-portable (requires POSIX)</span>
<a name="line-20"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>System.Posix.IO.Common</span> <span class='hs-layout'>(</span>
<a name="line-24"></a>    <span class='hs-comment'>-- * Input \/ Output</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-comment'>-- ** Standard file descriptors</span>
<a name="line-27"></a>    <span class='hs-varid'>stdInput</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdOutput</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdError</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-comment'>-- ** Opening and closing files</span>
<a name="line-30"></a>    <span class='hs-conid'>OpenMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-conid'>OpenFileFlags</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultFileFlags</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    <span class='hs-varid'>open_</span><span class='hs-layout'>,</span>
<a name="line-33"></a>    <span class='hs-varid'>closeFd</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-comment'>-- ** Reading\/writing data</span>
<a name="line-36"></a>    <span class='hs-comment'>-- |Programmers using the 'fdRead' and 'fdWrite' API should be aware that</span>
<a name="line-37"></a>    <span class='hs-comment'>-- EAGAIN exceptions may occur for non-blocking IO!</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>fdRead</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdWrite</span><span class='hs-layout'>,</span>
<a name="line-40"></a>    <span class='hs-varid'>fdReadBuf</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdWriteBuf</span><span class='hs-layout'>,</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-comment'>-- ** Seeking</span>
<a name="line-43"></a>    <span class='hs-varid'>fdSeek</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-comment'>-- ** File options</span>
<a name="line-46"></a>    <span class='hs-conid'>FdOption</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>    <span class='hs-varid'>queryFdOption</span><span class='hs-layout'>,</span>
<a name="line-48"></a>    <span class='hs-varid'>setFdOption</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-comment'>-- ** Locking</span>
<a name="line-51"></a>    <span class='hs-conid'>FileLock</span><span class='hs-layout'>,</span>
<a name="line-52"></a>    <span class='hs-conid'>LockRequest</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-53"></a>    <span class='hs-varid'>getLock</span><span class='hs-layout'>,</span>  <span class='hs-varid'>setLock</span><span class='hs-layout'>,</span>
<a name="line-54"></a>    <span class='hs-varid'>waitToSetLock</span><span class='hs-layout'>,</span>
<a name="line-55"></a>
<a name="line-56"></a>    <span class='hs-comment'>-- ** Pipes</span>
<a name="line-57"></a>    <span class='hs-varid'>createPipe</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-comment'>-- ** Duplicating file descriptors</span>
<a name="line-60"></a>    <span class='hs-varid'>dup</span><span class='hs-layout'>,</span> <span class='hs-varid'>dupTo</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-comment'>-- ** Converting file descriptors to\/from Handles</span>
<a name="line-63"></a>    <span class='hs-varid'>handleToFd</span><span class='hs-layout'>,</span>
<a name="line-64"></a>    <span class='hs-varid'>fdToHandle</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Error</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Posix.Types</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System.Posix.Internals</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Base</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Handle.Internals</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Handle.Types</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.IO.FD</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FD</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.IO.Handle.FD</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FD</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Exception</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span> <span class='hs-layout'>(</span><span class='hs-varid'>cast</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-86"></a><span class='hs-comment'>-- Pipes</span>
<a name="line-87"></a><span class='hs-comment'>-- |The 'createPipe' function creates a pair of connected file</span>
<a name="line-88"></a><span class='hs-comment'>-- descriptors. The first component is the fd to read from, the second</span>
<a name="line-89"></a><span class='hs-comment'>-- is the write end.  Although pipes may be bidirectional, this</span>
<a name="line-90"></a><span class='hs-comment'>-- behaviour is not portable and programmers should use two separate</span>
<a name="line-91"></a><span class='hs-comment'>-- pipes for this purpose.  May throw an exception if this is an</span>
<a name="line-92"></a><span class='hs-comment'>-- invalid descriptor.</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="createPipe"></a><span class='hs-definition'>createPipe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fd</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-definition'>createPipe</span> <span class='hs-keyglyph'>=</span>
<a name="line-96"></a>  <span class='hs-varid'>allocaArray</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p_fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-97"></a>    <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"createPipe"</span> <span class='hs-layout'>(</span><span class='hs-varid'>c_pipe</span> <span class='hs-varid'>p_fd</span><span class='hs-layout'>)</span>
<a name="line-98"></a>    <span class='hs-varid'>rfd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peekElemOff</span> <span class='hs-varid'>p_fd</span> <span class='hs-num'>0</span>
<a name="line-99"></a>    <span class='hs-varid'>wfd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peekElemOff</span> <span class='hs-varid'>p_fd</span> <span class='hs-num'>1</span>
<a name="line-100"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>rfd</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fd</span> <span class='hs-varid'>wfd</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"pipe"</span>
<a name="line-103"></a>   <span class='hs-varid'>c_pipe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-106"></a><span class='hs-comment'>-- Duplicating file descriptors</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="dup"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-109"></a><span class='hs-definition'>dup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Fd</span>
<a name="line-110"></a><span class='hs-definition'>dup</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>throwErrnoIfMinus1</span> <span class='hs-str'>"dup"</span> <span class='hs-layout'>(</span><span class='hs-varid'>c_dup</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="dupTo"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-113"></a><span class='hs-definition'>dupTo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Fd</span>
<a name="line-114"></a><span class='hs-definition'>dupTo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-115"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>throwErrnoIfMinus1</span> <span class='hs-str'>"dupTo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>c_dup2</span> <span class='hs-varid'>fd1</span> <span class='hs-varid'>fd2</span><span class='hs-layout'>)</span>
<a name="line-116"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"dup"</span>
<a name="line-119"></a>   <span class='hs-varid'>c_dup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"dup2"</span>
<a name="line-122"></a>   <span class='hs-varid'>c_dup2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-125"></a><span class='hs-comment'>-- Opening and closing files</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="stdInput"></a><span class='hs-definition'>stdInput</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdOutput</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span>
<a name="line-128"></a><span class='hs-definition'>stdInput</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fd</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-129"></a><a name="stdOutput"></a><span class='hs-comment'>{-# LINE 128 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-130"></a><span class='hs-definition'>stdOutput</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fd</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-131"></a><a name="stdError"></a><span class='hs-comment'>{-# LINE 129 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-132"></a><span class='hs-definition'>stdError</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fd</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-comment'>{-# LINE 130 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="OpenMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>OpenMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadOnly</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WriteOnly</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ReadWrite</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="OpenFileFlags"></a><span class='hs-comment'>-- |Correspond to some of the int flags from C's fcntl.h.</span>
<a name="line-138"></a><a name="OpenFileFlags"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>OpenFileFlags</span> <span class='hs-keyglyph'>=</span>
<a name="line-139"></a> <span class='hs-conid'>OpenFileFlags</span> <span class='hs-layout'>{</span>
<a name="line-140"></a>    <span class='hs-varid'>append</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ O_APPEND</span>
<a name="line-141"></a>    <span class='hs-varid'>exclusive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ O_EXCL</span>
<a name="line-142"></a>    <span class='hs-varid'>noctty</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ O_NOCTTY</span>
<a name="line-143"></a>    <span class='hs-varid'>nonBlock</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ O_NONBLOCK</span>
<a name="line-144"></a>    <span class='hs-varid'>trunc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ O_TRUNC</span>
<a name="line-145"></a> <span class='hs-layout'>}</span>
<a name="line-146"></a>
<a name="line-147"></a>
<a name="line-148"></a><a name="defaultFileFlags"></a><span class='hs-comment'>-- |Default values for the 'OpenFileFlags' type. False for each of</span>
<a name="line-149"></a><span class='hs-comment'>-- append, exclusive, noctty, nonBlock, and trunc.</span>
<a name="line-150"></a><span class='hs-definition'>defaultFileFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OpenFileFlags</span>
<a name="line-151"></a><span class='hs-definition'>defaultFileFlags</span> <span class='hs-keyglyph'>=</span>
<a name="line-152"></a> <span class='hs-conid'>OpenFileFlags</span> <span class='hs-layout'>{</span>
<a name="line-153"></a>    <span class='hs-varid'>append</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-154"></a>    <span class='hs-varid'>exclusive</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-155"></a>    <span class='hs-varid'>noctty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-156"></a>    <span class='hs-varid'>nonBlock</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-157"></a>    <span class='hs-varid'>trunc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-158"></a>  <span class='hs-layout'>}</span>
<a name="line-159"></a>
<a name="line-160"></a>
<a name="line-161"></a><a name="open_"></a><span class='hs-comment'>-- |Open and optionally create this file.  See 'System.Posix.Files'</span>
<a name="line-162"></a><span class='hs-comment'>-- for information on how to use the 'FileMode' type.</span>
<a name="line-163"></a><span class='hs-definition'>open_</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CString</span>
<a name="line-164"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OpenMode</span>
<a name="line-165"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FileMode</span> <span class='hs-comment'>-- ^Just x =&gt; creates the file with the given modes, Nothing =&gt; the file must exist.</span>
<a name="line-166"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OpenFileFlags</span>
<a name="line-167"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Fd</span>
<a name="line-168"></a><span class='hs-definition'>open_</span> <span class='hs-varid'>str</span> <span class='hs-varid'>how</span> <span class='hs-varid'>maybe_mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpenFileFlags</span> <span class='hs-varid'>appendFlag</span> <span class='hs-varid'>exclusiveFlag</span> <span class='hs-varid'>nocttyFlag</span>
<a name="line-169"></a>                                <span class='hs-varid'>nonBlockFlag</span> <span class='hs-varid'>truncateFlag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-170"></a>    <span class='hs-varid'>fd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>c_open</span> <span class='hs-varid'>str</span> <span class='hs-varid'>all_flags</span> <span class='hs-varid'>mode_w</span>
<a name="line-171"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span>
<a name="line-172"></a>  <span class='hs-keyword'>where</span>
<a name="line-173"></a>    <span class='hs-varid'>all_flags</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>creat</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>flags</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>open_mode</span>
<a name="line-174"></a>
<a name="line-175"></a>    <span class='hs-varid'>flags</span> <span class='hs-keyglyph'>=</span>
<a name="line-176"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>appendFlag</span>    <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-num'>1024</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
<a name="line-177"></a><span class='hs-comment'>{-# LINE 173 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-178"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>exclusiveFlag</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-num'>128</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
<a name="line-179"></a><span class='hs-comment'>{-# LINE 174 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-180"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>nocttyFlag</span>    <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-num'>256</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
<a name="line-181"></a><span class='hs-comment'>{-# LINE 175 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-182"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>nonBlockFlag</span>  <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-num'>2048</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
<a name="line-183"></a><span class='hs-comment'>{-# LINE 176 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-184"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>truncateFlag</span>  <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-num'>512</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-185"></a><span class='hs-comment'>{-# LINE 177 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>creat</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_mode</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-189"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>64</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-190"></a><span class='hs-comment'>{-# LINE 181 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-191"></a>
<a name="line-192"></a>    <span class='hs-varid'>open_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>how</span> <span class='hs-keyword'>of</span>
<a name="line-193"></a>                   <span class='hs-conid'>ReadOnly</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-194"></a><span class='hs-comment'>{-# LINE 184 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-195"></a>                   <span class='hs-conid'>WriteOnly</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-196"></a><span class='hs-comment'>{-# LINE 185 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-197"></a>                   <span class='hs-conid'>ReadWrite</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-198"></a><span class='hs-comment'>{-# LINE 186 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-varid'>capi</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"HsUnix.h open"</span>
<a name="line-201"></a>   <span class='hs-varid'>c_open</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-202"></a>
<a name="line-203"></a><span class='hs-comment'>-- |Close this file descriptor.  May throw an exception if this is an</span>
<a name="line-204"></a><span class='hs-comment'>-- invalid descriptor.</span>
<a name="line-205"></a>
<a name="line-206"></a><a name="closeFd"></a><span class='hs-definition'>closeFd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-207"></a><span class='hs-definition'>closeFd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"closeFd"</span> <span class='hs-layout'>(</span><span class='hs-varid'>c_close</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span>
<a name="line-208"></a>
<a name="line-209"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"HsUnix.h close"</span>
<a name="line-210"></a>   <span class='hs-varid'>c_close</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-213"></a><span class='hs-comment'>-- Converting file descriptors to/from Handles</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="handleToFd"></a><span class='hs-comment'>-- | Extracts the 'Fd' from a 'Handle'.  This function has the side effect</span>
<a name="line-216"></a><span class='hs-comment'>-- of closing the 'Handle' and flushing its write buffer, if necessary.</span>
<a name="line-217"></a><span class='hs-definition'>handleToFd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Fd</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="fdToHandle"></a><span class='hs-comment'>-- | Converts an 'Fd' into a 'Handle' that can be used with the</span>
<a name="line-220"></a><span class='hs-comment'>-- standard Haskell IO library (see "System.IO").</span>
<a name="line-221"></a><span class='hs-definition'>fdToHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-222"></a><span class='hs-definition'>fdToHandle</span> <span class='hs-varid'>fd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FD.fdToHandle</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span>
<a name="line-223"></a>
<a name="line-224"></a><span class='hs-definition'>handleToFd</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-225"></a>  <span class='hs-varid'>withHandle'</span> <span class='hs-str'>"handleToFd"</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleToFd'</span> <span class='hs-varid'>h</span>
<a name="line-226"></a><span class='hs-definition'>handleToFd</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-227"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withHandle'</span> <span class='hs-str'>"handleToFd"</span> <span class='hs-varid'>h</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleToFd'</span> <span class='hs-varid'>h</span>
<a name="line-228"></a>  <span class='hs-varid'>withHandle'</span> <span class='hs-str'>"handleToFd"</span> <span class='hs-varid'>h</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleToFd'</span> <span class='hs-varid'>h</span>
<a name="line-229"></a>  <span class='hs-comment'>-- for a DuplexHandle, make sure we mark both sides as closed,</span>
<a name="line-230"></a>  <span class='hs-comment'>-- otherwise a finalizer will come along later and close the other</span>
<a name="line-231"></a>  <span class='hs-comment'>-- side. (#3914)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="handleToFd'"></a><span class='hs-definition'>handleToFd'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fd</span><span class='hs-layout'>)</span>
<a name="line-234"></a><span class='hs-definition'>handleToFd'</span> <span class='hs-varid'>h</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-varid'>haType</span><span class='hs-keyglyph'>=</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-235"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>cast</span> <span class='hs-varid'>haDevice</span> <span class='hs-keyword'>of</span>
<a name="line-236"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioError</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioeSetErrorString</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIOError</span> <span class='hs-conid'>IllegalOperation</span>
<a name="line-237"></a>                                           <span class='hs-str'>"handleToFd"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-238"></a>                        <span class='hs-str'>"handle is not a file descriptor"</span><span class='hs-layout'>)</span>
<a name="line-239"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-240"></a>     <span class='hs-comment'>-- converting a Handle into an Fd effectively means</span>
<a name="line-241"></a>     <span class='hs-comment'>-- letting go of the Handle; it is put into a closed</span>
<a name="line-242"></a>     <span class='hs-comment'>-- state as a result.</span>
<a name="line-243"></a>     <span class='hs-varid'>flushWriteBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-244"></a>     <span class='hs-conid'>FD.release</span> <span class='hs-varid'>fd</span>
<a name="line-245"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-varid'>haType</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>ClosedHandle</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fd</span> <span class='hs-layout'>(</span><span class='hs-conid'>FD.fdFD</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-249"></a><span class='hs-comment'>-- Fd options</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="FdOption"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FdOption</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppendOnWrite</span>     <span class='hs-comment'>-- ^O_APPEND</span>
<a name="line-252"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CloseOnExec</span>       <span class='hs-comment'>-- ^FD_CLOEXEC</span>
<a name="line-253"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonBlockingRead</span>   <span class='hs-comment'>-- ^O_NONBLOCK</span>
<a name="line-254"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SynchronousWrites</span> <span class='hs-comment'>-- ^O_SYNC</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="fdOption2Int"></a><span class='hs-definition'>fdOption2Int</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FdOption</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span>
<a name="line-257"></a><span class='hs-definition'>fdOption2Int</span> <span class='hs-conid'>CloseOnExec</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-258"></a><span class='hs-comment'>{-# LINE 245 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-259"></a><span class='hs-definition'>fdOption2Int</span> <span class='hs-conid'>AppendOnWrite</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1024</span><span class='hs-layout'>)</span>
<a name="line-260"></a><span class='hs-comment'>{-# LINE 246 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-261"></a><span class='hs-definition'>fdOption2Int</span> <span class='hs-conid'>NonBlockingRead</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>2048</span><span class='hs-layout'>)</span>
<a name="line-262"></a><span class='hs-comment'>{-# LINE 247 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-263"></a><span class='hs-definition'>fdOption2Int</span> <span class='hs-conid'>SynchronousWrites</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1052672</span><span class='hs-layout'>)</span>
<a name="line-264"></a><span class='hs-comment'>{-# LINE 248 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="queryFdOption"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-267"></a><span class='hs-definition'>queryFdOption</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FdOption</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-268"></a><span class='hs-definition'>queryFdOption</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>opt</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-269"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>throwErrnoIfMinus1</span> <span class='hs-str'>"queryFdOption"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_read</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-270"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>fdOption2Int</span> <span class='hs-varid'>opt</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-271"></a> <span class='hs-keyword'>where</span>
<a name="line-272"></a>  <span class='hs-varid'>flag</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>opt</span> <span class='hs-keyword'>of</span>
<a name="line-273"></a>              <span class='hs-conid'>CloseOnExec</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-274"></a><span class='hs-comment'>{-# LINE 257 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-275"></a>              <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-276"></a><span class='hs-comment'>{-# LINE 258 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="setFdOption"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-279"></a><span class='hs-definition'>setFdOption</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FdOption</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-280"></a><span class='hs-definition'>setFdOption</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>opt</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-281"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>throwErrnoIfMinus1</span> <span class='hs-str'>"setFdOption"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_read</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>getflag</span><span class='hs-layout'>)</span>
<a name="line-282"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>val</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>opt_val</span>
<a name="line-283"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-layout'>(</span><span class='hs-varid'>complement</span> <span class='hs-varid'>opt_val</span><span class='hs-layout'>)</span>
<a name="line-284"></a>  <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"setFdOption"</span>
<a name="line-285"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_write</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>setflag</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>r'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-286"></a> <span class='hs-keyword'>where</span>
<a name="line-287"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>getflag</span><span class='hs-layout'>,</span><span class='hs-varid'>setflag</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>opt</span> <span class='hs-keyword'>of</span>
<a name="line-288"></a>              <span class='hs-conid'>CloseOnExec</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-289"></a><span class='hs-comment'>{-# LINE 270 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-290"></a>              <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-num'>4</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-291"></a><span class='hs-comment'>{-# LINE 271 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-292"></a>  <span class='hs-varid'>opt_val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fdOption2Int</span> <span class='hs-varid'>opt</span>
<a name="line-293"></a>
<a name="line-294"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-295"></a><span class='hs-comment'>-- Seeking</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="mode2Int"></a><span class='hs-definition'>mode2Int</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SeekMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span>
<a name="line-298"></a><span class='hs-definition'>mode2Int</span> <span class='hs-conid'>AbsoluteSeek</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-299"></a><span class='hs-comment'>{-# LINE 278 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-300"></a><span class='hs-definition'>mode2Int</span> <span class='hs-conid'>RelativeSeek</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-301"></a><span class='hs-comment'>{-# LINE 279 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-302"></a><span class='hs-definition'>mode2Int</span> <span class='hs-conid'>SeekFromEnd</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-303"></a><span class='hs-comment'>{-# LINE 280 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="fdSeek"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-306"></a><span class='hs-definition'>fdSeek</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SeekMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FileOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FileOffset</span>
<a name="line-307"></a><span class='hs-definition'>fdSeek</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>off</span> <span class='hs-keyglyph'>=</span>
<a name="line-308"></a>  <span class='hs-varid'>throwErrnoIfMinus1</span> <span class='hs-str'>"fdSeek"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_lseek</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>off</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode2Int</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-309"></a>
<a name="line-310"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-311"></a><span class='hs-comment'>-- Locking</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="LockRequest"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LockRequest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadLock</span>
<a name="line-314"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WriteLock</span>
<a name="line-315"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Unlock</span>
<a name="line-316"></a>
<a name="line-317"></a><a name="FileLock"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FileLock</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>LockRequest</span><span class='hs-layout'>,</span> <span class='hs-conid'>SeekMode</span><span class='hs-layout'>,</span> <span class='hs-conid'>FileOffset</span><span class='hs-layout'>,</span> <span class='hs-conid'>FileOffset</span><span class='hs-layout'>)</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="getLock"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-320"></a><span class='hs-definition'>getLock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FileLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProcessID</span><span class='hs-layout'>,</span> <span class='hs-conid'>FileLock</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-321"></a><span class='hs-definition'>getLock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>lock</span> <span class='hs-keyglyph'>=</span>
<a name="line-322"></a>  <span class='hs-varid'>allocaLock</span> <span class='hs-varid'>lock</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p_flock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-323"></a>    <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"getLock"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_lock</span> <span class='hs-varid'>fd</span> <span class='hs-layout'>(</span><span class='hs-num'>5</span><span class='hs-layout'>)</span> <span class='hs-varid'>p_flock</span><span class='hs-layout'>)</span>
<a name="line-324"></a><span class='hs-comment'>{-# LINE 300 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-325"></a>    <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bytes2ProcessIDAndLock</span> <span class='hs-varid'>p_flock</span>
<a name="line-326"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeResult</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-327"></a>  <span class='hs-keyword'>where</span>
<a name="line-328"></a>    <span class='hs-varid'>maybeResult</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unlock</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-329"></a>    <span class='hs-varid'>maybeResult</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="allocaLock"></a><span class='hs-definition'>allocaLock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FileLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Base.CFLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-332"></a><span class='hs-definition'>allocaLock</span> <span class='hs-layout'>(</span><span class='hs-varid'>lockreq</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode</span><span class='hs-layout'>,</span> <span class='hs-varid'>start</span><span class='hs-layout'>,</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span>
<a name="line-333"></a>  <span class='hs-varid'>allocaBytes</span> <span class='hs-layout'>(</span><span class='hs-num'>32</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-334"></a><span class='hs-comment'>{-# LINE 309 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-335"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pokeByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>lockReq2Int</span> <span class='hs-varid'>lockreq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CShort</span><span class='hs-layout'>)</span>
<a name="line-336"></a><span class='hs-comment'>{-# LINE 310 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-337"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pokeByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode2Int</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CShort</span><span class='hs-layout'>)</span>
<a name="line-338"></a><span class='hs-comment'>{-# LINE 311 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-339"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pokeByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>8</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-varid'>p</span> <span class='hs-varid'>start</span>
<a name="line-340"></a><span class='hs-comment'>{-# LINE 312 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-341"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pokeByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>16</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-varid'>p</span> <span class='hs-varid'>len</span>
<a name="line-342"></a><span class='hs-comment'>{-# LINE 313 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-343"></a>    <span class='hs-varid'>io</span> <span class='hs-varid'>p</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="lockReq2Int"></a><span class='hs-definition'>lockReq2Int</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LockRequest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CShort</span>
<a name="line-346"></a><span class='hs-definition'>lockReq2Int</span> <span class='hs-conid'>ReadLock</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-347"></a><span class='hs-comment'>{-# LINE 317 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-348"></a><span class='hs-definition'>lockReq2Int</span> <span class='hs-conid'>WriteLock</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-349"></a><span class='hs-comment'>{-# LINE 318 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-350"></a><span class='hs-definition'>lockReq2Int</span> <span class='hs-conid'>Unlock</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-351"></a><span class='hs-comment'>{-# LINE 319 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-352"></a>
<a name="line-353"></a><a name="bytes2ProcessIDAndLock"></a><span class='hs-definition'>bytes2ProcessIDAndLock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Base.CFLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProcessID</span><span class='hs-layout'>,</span> <span class='hs-conid'>FileLock</span><span class='hs-layout'>)</span>
<a name="line-354"></a><span class='hs-definition'>bytes2ProcessIDAndLock</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-355"></a>  <span class='hs-varid'>req</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>p</span>
<a name="line-356"></a><span class='hs-comment'>{-# LINE 323 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-357"></a>  <span class='hs-varid'>mode</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span>
<a name="line-358"></a><span class='hs-comment'>{-# LINE 324 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-359"></a>  <span class='hs-varid'>start</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>8</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-varid'>p</span>
<a name="line-360"></a><span class='hs-comment'>{-# LINE 325 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-361"></a>  <span class='hs-varid'>len</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>16</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-varid'>p</span>
<a name="line-362"></a><span class='hs-comment'>{-# LINE 326 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-363"></a>  <span class='hs-varid'>pid</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>hsc_ptr</span> <span class='hs-num'>24</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-varid'>p</span>
<a name="line-364"></a><span class='hs-comment'>{-# LINE 327 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-365"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pid</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>int2req</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>int2mode</span> <span class='hs-varid'>mode</span><span class='hs-layout'>,</span> <span class='hs-varid'>start</span><span class='hs-layout'>,</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-366"></a> <span class='hs-keyword'>where</span>
<a name="line-367"></a>  <span class='hs-varid'>int2req</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CShort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LockRequest</span>
<a name="line-368"></a>  <span class='hs-varid'>int2req</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadLock</span>
<a name="line-369"></a><span class='hs-comment'>{-# LINE 331 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-370"></a>  <span class='hs-varid'>int2req</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WriteLock</span>
<a name="line-371"></a><span class='hs-comment'>{-# LINE 332 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-372"></a>  <span class='hs-varid'>int2req</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unlock</span>
<a name="line-373"></a><span class='hs-comment'>{-# LINE 333 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-374"></a>  <span class='hs-varid'>int2req</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"int2req: bad argument"</span>
<a name="line-375"></a>
<a name="line-376"></a>  <span class='hs-varid'>int2mode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CShort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SeekMode</span>
<a name="line-377"></a>  <span class='hs-varid'>int2mode</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AbsoluteSeek</span>
<a name="line-378"></a><span class='hs-comment'>{-# LINE 337 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-379"></a>  <span class='hs-varid'>int2mode</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RelativeSeek</span>
<a name="line-380"></a><span class='hs-comment'>{-# LINE 338 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-381"></a>  <span class='hs-varid'>int2mode</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SeekFromEnd</span>
<a name="line-382"></a><span class='hs-comment'>{-# LINE 339 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-383"></a>  <span class='hs-varid'>int2mode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"int2mode: bad argument"</span>
<a name="line-384"></a>
<a name="line-385"></a><a name="setLock"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-386"></a><span class='hs-definition'>setLock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FileLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-387"></a><span class='hs-definition'>setLock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>lock</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-388"></a>  <span class='hs-varid'>allocaLock</span> <span class='hs-varid'>lock</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p_flock</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-389"></a>    <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"setLock"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_lock</span> <span class='hs-varid'>fd</span> <span class='hs-layout'>(</span><span class='hs-num'>6</span><span class='hs-layout'>)</span> <span class='hs-varid'>p_flock</span><span class='hs-layout'>)</span>
<a name="line-390"></a><span class='hs-comment'>{-# LINE 346 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-391"></a>
<a name="line-392"></a><a name="waitToSetLock"></a><span class='hs-comment'>-- | May throw an exception if this is an invalid descriptor.</span>
<a name="line-393"></a><span class='hs-definition'>waitToSetLock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FileLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-394"></a><span class='hs-definition'>waitToSetLock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-varid'>lock</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-395"></a>  <span class='hs-varid'>allocaLock</span> <span class='hs-varid'>lock</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p_flock</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-396"></a>    <span class='hs-varid'>throwErrnoIfMinus1_</span> <span class='hs-str'>"waitToSetLock"</span>
<a name="line-397"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Base.c_fcntl_lock</span> <span class='hs-varid'>fd</span> <span class='hs-layout'>(</span><span class='hs-num'>7</span><span class='hs-layout'>)</span> <span class='hs-varid'>p_flock</span><span class='hs-layout'>)</span>
<a name="line-398"></a><span class='hs-comment'>{-# LINE 353 "libraries/unix/System/Posix/IO/Common.hsc" #-}</span>
<a name="line-399"></a>
<a name="line-400"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-401"></a><span class='hs-comment'>-- fd{Read,Write}</span>
<a name="line-402"></a>
<a name="line-403"></a><a name="fdRead"></a><span class='hs-comment'>-- | Read data from an 'Fd' and convert it to a 'String' using the locale encoding.</span>
<a name="line-404"></a><span class='hs-comment'>-- Throws an exception if this is an invalid descriptor, or EOF has been</span>
<a name="line-405"></a><span class='hs-comment'>-- reached.</span>
<a name="line-406"></a><span class='hs-definition'>fdRead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span>
<a name="line-407"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteCount</span> <span class='hs-comment'>-- ^How many bytes to read</span>
<a name="line-408"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteCount</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^The bytes read, how many bytes were read.</span>
<a name="line-409"></a><span class='hs-definition'>fdRead</span> <span class='hs-sel'>_fd</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-410"></a><span class='hs-definition'>fdRead</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>nbytes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-411"></a>    <span class='hs-varid'>allocaBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>nbytes</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-412"></a>    <span class='hs-varid'>rc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fdReadBuf</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>nbytes</span>
<a name="line-413"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>rc</span> <span class='hs-keyword'>of</span>
<a name="line-414"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioError</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioeSetErrorString</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIOError</span> <span class='hs-conid'>EOF</span> <span class='hs-str'>"fdRead"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-str'>"EOF"</span><span class='hs-layout'>)</span>
<a name="line-415"></a>      <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-416"></a>       <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peekCStringLen</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>buf</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-417"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="fdReadBuf"></a><span class='hs-comment'>-- | Read data from an 'Fd' into memory.  This is exactly equivalent</span>
<a name="line-420"></a><span class='hs-comment'>-- to the POSIX @read@ function.</span>
<a name="line-421"></a><span class='hs-definition'>fdReadBuf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span>
<a name="line-422"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-comment'>-- ^ Memory in which to put the data</span>
<a name="line-423"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteCount</span> <span class='hs-comment'>-- ^ Maximum number of bytes to read</span>
<a name="line-424"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteCount</span> <span class='hs-comment'>-- ^ Number of bytes read (zero for EOF)</span>
<a name="line-425"></a><span class='hs-definition'>fdReadBuf</span> <span class='hs-sel'>_fd</span> <span class='hs-sel'>_buf</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-num'>0</span>
<a name="line-426"></a><span class='hs-definition'>fdReadBuf</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>nbytes</span> <span class='hs-keyglyph'>=</span>
<a name="line-427"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span>
<a name="line-428"></a>    <span class='hs-varid'>throwErrnoIfMinus1Retry</span> <span class='hs-str'>"fdReadBuf"</span> <span class='hs-varop'>$</span>
<a name="line-429"></a>      <span class='hs-varid'>c_safe_read</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span> <span class='hs-varid'>nbytes</span>
<a name="line-430"></a>
<a name="line-431"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>safe</span> <span class='hs-str'>"read"</span>
<a name="line-432"></a>   <span class='hs-varid'>c_safe_read</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CChar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CSsize</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="fdWrite"></a><span class='hs-comment'>-- | Write a 'String' to an 'Fd' using the locale encoding.</span>
<a name="line-435"></a><span class='hs-definition'>fdWrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteCount</span>
<a name="line-436"></a><span class='hs-definition'>fdWrite</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-437"></a>  <span class='hs-varid'>withCStringLen</span> <span class='hs-varid'>str</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>buf</span><span class='hs-layout'>,</span><span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-438"></a>    <span class='hs-varid'>fdWriteBuf</span> <span class='hs-varid'>fd</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span>
<a name="line-439"></a>
<a name="line-440"></a><a name="fdWriteBuf"></a><span class='hs-comment'>-- | Write data from memory to an 'Fd'.  This is exactly equivalent</span>
<a name="line-441"></a><span class='hs-comment'>-- to the POSIX @write@ function.</span>
<a name="line-442"></a><span class='hs-definition'>fdWriteBuf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fd</span>
<a name="line-443"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span>    <span class='hs-comment'>-- ^ Memory containing the data to write</span>
<a name="line-444"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteCount</span>    <span class='hs-comment'>-- ^ Maximum number of bytes to write</span>
<a name="line-445"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteCount</span> <span class='hs-comment'>-- ^ Number of bytes written</span>
<a name="line-446"></a><span class='hs-definition'>fdWriteBuf</span> <span class='hs-varid'>fd</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span>
<a name="line-447"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>$</span>
<a name="line-448"></a>    <span class='hs-varid'>throwErrnoIfMinus1Retry</span> <span class='hs-str'>"fdWriteBuf"</span> <span class='hs-varop'>$</span>
<a name="line-449"></a>      <span class='hs-varid'>c_safe_write</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>fd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span> <span class='hs-varid'>len</span>
<a name="line-450"></a>
<a name="line-451"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>safe</span> <span class='hs-str'>"write"</span>
<a name="line-452"></a>   <span class='hs-varid'>c_safe_write</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CChar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CSsize</span>
</pre></body>
</html>
