<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Main</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Kernmantle.Error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">tryE</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS.ContentHashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ContentHashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS.ContentStore</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Content</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS.ContentStore</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CS</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS.RemoteCache</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RC</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Funflow</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Flow</span></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-identifier">RunFlowConfig</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-identifier">caching</span></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-identifier">dockerFlow</span></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="hs-identifier">ioFlow</span></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-identifier">pureFlow</span></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-identifier">runFlowWithConfig</span></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Funflow.Tasks.Docker</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DE</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Parse.html"><span class="hs-identifier">Parse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Parse.html#getValidMakeFile"><span class="hs-identifier">getValidMakeFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Abs</span></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-identifier">Dir</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-identifier">File</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-identifier">Path</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-identifier">Rel</span></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-identifier">absdir</span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-identifier">filename</span></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-identifier">fromAbsDir</span></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-identifier">fromAbsFile</span></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="hs-identifier">parseAbsDir</span></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="hs-identifier">parseRelFile</span></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-identifier">reldir</span></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="hs-identifier">relfile</span></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-identifier">toFilePath</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="hs-operator">(&lt;/&gt;)</span></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Path.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getCurrentDir</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Posix.Files</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">accessModes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">createLink</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">setFileMode</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Types.html"><span class="hs-identifier">Types</span></a></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">type</span><span> </span><span id="Set"><span class="annot"><a href="Main.html#Set"><span class="hs-identifier hs-var">Set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">type</span><span> </span><span id="Map"><span class="annot"><a href="Main.html#Map"><span class="hs-identifier hs-var">Map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">type</span><span> </span><span id="FileName"><span class="annot"><a href="Main.html#FileName"><span class="hs-identifier hs-var">FileName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">type</span><span> </span><span id="FileContent"><span class="annot"><a href="Main.html#FileContent"><span class="hs-identifier hs-var">FileContent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Main.html#main"><span class="hs-identifier hs-type">main</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span id="main"><span class="annot"><span class="annottext">main :: IO ()
</span><a href="Main.html#main"><span class="hs-identifier hs-var hs-var">main</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>  </span><span id="local-6989586621679142648"><span class="annot"><span class="annottext">Either MakeFile MFError
</span><a href="#local-6989586621679142648"><span class="hs-identifier hs-var">perhapsMakeFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath -&gt; IO (Either MakeFile MFError)
</span><a href="Parse.html#getValidMakeFile"><span class="hs-identifier hs-var">getValidMakeFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either MakeFile MFError
</span><a href="#local-6989586621679142648"><span class="hs-identifier hs-var">perhapsMakeFile</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Types.html#MFError"><span class="hs-identifier hs-type">MFError</span></a></span><span> </span><span id="local-6989586621679142646"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142646"><span class="hs-identifier hs-var">errMsg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Invalid make file:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142646"><span class="hs-identifier hs-var">errMsg</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679142644"><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142644"><span class="hs-identifier hs-var">mfile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>      </span><span id="local-6989586621679142643"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142643"><span class="hs-identifier hs-var">cwd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Path Abs Dir)
forall (m :: * -&gt; *). MonadIO m =&gt; m (Path Abs Dir)
</span><span class="hs-identifier hs-var">getCurrentDir</span></span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142642"><span class="annot"><span class="annottext">contentStore :: Path Abs Dir
</span><a href="#local-6989586621679142642"><span class="hs-identifier hs-var hs-var">contentStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142643"><span class="hs-identifier hs-var">cwd</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Path Rel Dir -&gt; Path Abs Dir
forall b t. Path b Dir -&gt; Path Rel t -&gt; Path b t
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="">[reldir|makefiletest/store|]</span></span><span>
</span><span id="line-72"></span><span>          </span><span id="local-6989586621679142640"><span class="annot"><span class="annottext">defGoalRule :: MakeRule
</span><a href="#local-6989586621679142640"><span class="hs-identifier hs-var hs-var">defGoalRule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeFile -&gt; MakeRule
</span><a href="Types.html#defaultGoal"><span class="hs-identifier hs-var hs-var">defaultGoal</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142644"><span class="hs-identifier hs-var">mfile</span></a></span><span>
</span><span id="line-73"></span><span>          </span><span id="local-6989586621679142638"><span class="annot"><span class="annottext">runCfg :: RunFlowConfig
</span><a href="#local-6989586621679142638"><span class="hs-identifier hs-var hs-var">runCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; RunFlowConfig
</span><a href="Main.html#getRunConfigWithoutFile"><span class="hs-identifier hs-var">getRunConfigWithoutFile</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142642"><span class="hs-identifier hs-var">contentStore</span></a></span><span>
</span><span id="line-74"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Attempting build:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142640"><span class="hs-identifier hs-var">defGoalRule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>      </span><span id="local-6989586621679142635"><span class="annot"><span class="annottext">Either SomeException (Path Abs File)
</span><a href="#local-6989586621679142635"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RunFlowConfig
-&gt; LooseRopeWith
     RequiredStrands
     (RequiredCore IO)
     ()
     (Either SomeException (Path Abs File))
-&gt; ()
-&gt; IO (Either SomeException (Path Abs File))
forall input output.
RunFlowConfig
-&gt; LooseRopeWith RequiredStrands (RequiredCore IO) input output
-&gt; input
-&gt; IO output
</span><span class="hs-identifier hs-var">runFlowWithConfig</span></span><span> </span><span class="annot"><span class="annottext">RunFlowConfig
</span><a href="#local-6989586621679142638"><span class="hs-identifier hs-var">runCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rope Rec mantle core () (Path Abs File)
-&gt; Rope Rec mantle core () (Either SomeException (Path Abs File))
forall ex (eff :: * -&gt; * -&gt; *) a b.
TryEffect ex eff =&gt;
eff a b -&gt; eff a (Either ex b)
</span><span class="hs-identifier hs-var">tryE</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir -&gt; MakeFile -&gt; MakeRule -&gt; Flow () (Path Abs File)
</span><a href="Main.html#buildTarget"><span class="hs-identifier hs-var">buildTarget</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142642"><span class="hs-identifier hs-var">contentStore</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142644"><span class="hs-identifier hs-var">mfile</span></a></span><span> </span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142640"><span class="hs-identifier hs-var">defGoalRule</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Build attempt complete&quot;</span></span><span>
</span><span id="line-77"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Path Abs File)
</span><a href="#local-6989586621679142635"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679142633"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679142633"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;\n\nFailed, target failed:\n\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679142633"><span class="hs-identifier hs-var">ex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679142632"><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142632"><span class="hs-identifier hs-var">execFile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>          </span><span class="hs-comment">-- Build succeeded; write executable to target location and set exec bit.</span><span>
</span><span id="line-81"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142631"><span class="annot"><span class="annottext">outpath :: FilePath
</span><a href="#local-6989586621679142631"><span class="hs-identifier hs-var hs-var">outpath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; FilePath
</span><span class="hs-identifier hs-var">fromAbsDir</span></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142643"><span class="hs-identifier hs-var">cwd</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; FilePath
</span><a href="Types.html#mkRuleTarNm"><span class="hs-identifier hs-var">mkRuleTarNm</span></a></span><span> </span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142640"><span class="hs-identifier hs-var">defGoalRule</span></a></span><span>
</span><span id="line-82"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BS.readFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs File -&gt; FilePath
</span><span class="hs-identifier hs-var">fromAbsFile</span></span><span> </span><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142632"><span class="hs-identifier hs-var">execFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; (ByteString -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BS.writeFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142631"><span class="hs-identifier hs-var">outpath</span></a></span><span>
</span><span id="line-83"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; FileMode -&gt; IO ()
</span><span class="hs-identifier hs-var">setFileMode</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142631"><span class="hs-identifier hs-var">outpath</span></a></span><span> </span><span class="annot"><span class="annottext">FileMode
</span><span class="hs-identifier hs-var">accessModes</span></span><span> </span><span class="hs-comment">-- chmod +x</span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;\n\nSuccess, target executable made.&quot;</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- | Building A Target</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- Note: assuming the makefile is valid at this point!</span><span>
</span><span id="line-90"></span><span class="annot"><a href="Main.html#buildTarget"><span class="hs-identifier hs-type">buildTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Types.html#MakeFile"><span class="hs-identifier hs-type">MakeFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Types.html#MakeRule"><span class="hs-identifier hs-type">MakeRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span id="buildTarget"><span class="annot"><span class="annottext">buildTarget :: Path Abs Dir -&gt; MakeFile -&gt; MakeRule -&gt; Flow () (Path Abs File)
</span><a href="Main.html#buildTarget"><span class="hs-identifier hs-var hs-var">buildTarget</span></a></span></span><span> </span><span id="local-6989586621679142627"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142627"><span class="hs-identifier hs-var">storeRoot</span></a></span></span><span> </span><span id="local-6989586621679142626"><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142626"><span class="hs-identifier hs-var">mkfile</span></a></span></span><span> </span><span id="local-6989586621679142625"><span class="annot"><span class="annottext">target :: MakeRule
</span><a href="#local-6989586621679142625"><span class="hs-identifier hs-var">target</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Types.html#MakeRule"><span class="hs-identifier hs-type">MakeRule</span></a></span><span> </span><span id="local-6989586621679142623"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142623"><span class="hs-identifier hs-var">targetNm</span></a></span></span><span> </span><span id="local-6989586621679142622"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142622"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span id="local-6989586621679142621"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142621"><span class="hs-identifier hs-var">cmd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142620"><span class="annot"><span class="annottext">srcfiles :: Set FilePath
</span><a href="#local-6989586621679142620"><span class="hs-identifier hs-var hs-var">srcfiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeFile -&gt; Set FilePath
</span><a href="Types.html#sourceFiles"><span class="hs-identifier hs-var hs-var">sourceFiles</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142626"><span class="hs-identifier hs-var">mkfile</span></a></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- What must be built is the collection of non-source dependencies.</span><span>
</span><span id="line-94"></span><span>      </span><span id="local-6989586621679142618"><span class="annot"><span class="annottext">neededTargets :: [FilePath]
</span><a href="#local-6989586621679142618"><span class="hs-identifier hs-var hs-var">neededTargets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set FilePath -&gt; [FilePath]) -&gt; Set FilePath -&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.difference</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142622"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142620"><span class="hs-identifier hs-var">srcfiles</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-comment">-- We only need the sources that are pertinent for the current rule's dependencies.</span><span>
</span><span id="line-96"></span><span>      </span><span id="local-6989586621679142615"><span class="annot"><span class="annottext">neededSources :: [FilePath]
</span><a href="#local-6989586621679142615"><span class="hs-identifier hs-var hs-var">neededSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set FilePath -&gt; [FilePath]) -&gt; Set FilePath -&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142622"><span class="hs-identifier hs-var">deps</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`Set.intersection`</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142620"><span class="hs-identifier hs-var">srcfiles</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span id="local-6989586621679142613"><span class="annot"><span class="annottext">maybeFindDepRules :: Maybe [MakeRule]
</span><a href="#local-6989586621679142613"><span class="hs-identifier hs-var hs-var">maybeFindDepRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeFile -&gt; [FilePath] -&gt; Maybe [MakeRule]
</span><a href="Main.html#findRules"><span class="hs-identifier hs-var">findRules</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142626"><span class="hs-identifier hs-var">mkfile</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142618"><span class="hs-identifier hs-var">neededTargets</span></a></span><span>
</span><span id="line-98"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [MakeRule]
</span><a href="#local-6989586621679142613"><span class="hs-identifier hs-var">maybeFindDepRules</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">Maybe [MakeRule]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rope r mantle core () (Path Abs File)
forall a. Flow () a
</span><a href="Main.html#failNow"><span class="hs-identifier hs-var">failNow</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679142610"><span class="annot"><span class="annottext">[MakeRule]
</span><a href="#local-6989586621679142610"><span class="hs-identifier hs-var">depRules</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Types.html#MakeRule"><span class="hs-identifier hs-type">MakeRule</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- found rules for dependencies to be built for current rule</span><span>
</span><span id="line-102"></span><span>              </span><span id="local-6989586621679142609"><span class="annot"><span class="annottext">grabSrcsActions :: [FilePath] -&gt; IO [FilePath]
</span><a href="#local-6989586621679142609"><span class="hs-identifier hs-var hs-var">grabSrcsActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO FilePath) -&gt; [FilePath] -&gt; IO [FilePath]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><span class="hs-identifier hs-var">readFile</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO FilePath)
-&gt; (FilePath -&gt; FilePath) -&gt; FilePath -&gt; IO FilePath
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;./&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; Flow () ()
</span><a href="Main.html#msgFlow"><span class="hs-identifier hs-var">msgFlow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Current rule: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142625"><span class="hs-identifier hs-var">target</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>                </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope r mantle core Bool ()
Flow Bool ()
</span><a href="Main.html#failGuardFlow"><span class="hs-identifier hs-var">failGuardFlow</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142625"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; Set MakeRule -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`Set.member`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MakeFile -&gt; Set MakeRule
</span><a href="Types.html#allrules"><span class="hs-identifier hs-var hs-var">allrules</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142626"><span class="hs-identifier hs-var">mkfile</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>                </span><span class="hs-comment">-- Read content from source files.</span><span>
</span><span id="line-107"></span><span>                </span><span id="local-6989586621679142601"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142601"><span class="hs-identifier hs-var">contentSrcFiles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([FilePath] -&gt; IO [FilePath]) -&gt; Flow [FilePath] [FilePath]
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO [FilePath]
</span><a href="#local-6989586621679142609"><span class="hs-identifier hs-var">grabSrcsActions</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142615"><span class="hs-identifier hs-var">neededSources</span></a></span><span>
</span><span id="line-108"></span><span>                </span><span class="hs-comment">-- Result from building each dependency.</span><span>
</span><span id="line-109"></span><span>                </span><span id="local-6989586621679142600"><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142600"><span class="hs-identifier hs-var">depFiles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id () (Path Abs File)] -&gt; Flow [()] [Path Abs File]
forall a b. [Id a b] -&gt; Flow [a] [b]
</span><a href="Main.html#flowJoin"><span class="hs-identifier hs-var">flowJoin</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id :: forall a b. Flow a b -&gt; Id a b
</span><a href="Main.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">unId :: Flow () (Path Abs File)
</span><a href="Main.html#unId"><span class="hs-identifier hs-var">unId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; MakeFile -&gt; MakeRule -&gt; Flow () (Path Abs File)
</span><a href="Main.html#buildTarget"><span class="hs-identifier hs-var">buildTarget</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142627"><span class="hs-identifier hs-var">storeRoot</span></a></span><span> </span><span class="annot"><span class="annottext">MakeFile
</span><a href="#local-6989586621679142626"><span class="hs-identifier hs-var">mkfile</span></a></span><span> </span><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142596"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679142596"><span class="annot"><span class="annottext">MakeRule
</span><a href="#local-6989586621679142596"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MakeRule]
</span><a href="#local-6989586621679142610"><span class="hs-identifier hs-var">depRules</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; () -&gt; [()]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MakeRule] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[MakeRule]
</span><a href="#local-6989586621679142610"><span class="hs-identifier hs-var">depRules</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142593"><span class="annot"><span class="annottext">fullSrcFiles :: Map FilePath FilePath
</span><a href="#local-6989586621679142593"><span class="hs-identifier hs-var hs-var">fullSrcFiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(FilePath, FilePath)] -&gt; Map FilePath FilePath
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(FilePath, FilePath)] -&gt; Map FilePath FilePath)
-&gt; [(FilePath, FilePath)] -&gt; Map FilePath FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [FilePath] -&gt; [(FilePath, FilePath)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142615"><span class="hs-identifier hs-var">neededSources</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142601"><span class="hs-identifier hs-var">contentSrcFiles</span></a></span><span>
</span><span id="line-111"></span><span>                </span><span class="hs-comment">-- Compile the target of the current rule.</span><span>
</span><span id="line-112"></span><span>                </span><span id="local-6989586621679142591"><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142591"><span class="hs-identifier hs-var">compFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; Rope
     r
     mantle
     core
     (FilePath, Map FilePath FilePath, [Path Abs File], FilePath)
     (Path Abs File)
-&gt; Rope
     r
     mantle
     core
     (FilePath, Map FilePath FilePath, [Path Abs File], FilePath)
     (Path Abs File)
forall (core :: * -&gt; * -&gt; *) ident a b (r :: RopeRec)
       (mantle :: [Strand]).
(Arrow core, ProvidesCaching core, ContentHashable IO ident,
 ContentHashable IO a, Store b) =&gt;
ident -&gt; Rope r mantle core a b -&gt; Rope r mantle core a b
</span><span class="hs-identifier hs-var">caching</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142623"><span class="hs-identifier hs-var">targetNm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; Flow
     (FilePath, Map FilePath FilePath, [Path Abs File], FilePath)
     (Path Abs File)
</span><a href="Main.html#compileFile"><span class="hs-identifier hs-var">compileFile</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142627"><span class="hs-identifier hs-var">storeRoot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142623"><span class="hs-identifier hs-var">targetNm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621679142593"><span class="hs-identifier hs-var">fullSrcFiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142600"><span class="hs-identifier hs-var">depFiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142621"><span class="hs-identifier hs-var">cmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>                </span><span class="annot"><span class="annottext">Rope r mantle core (Path Abs File) (Path Abs File)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142591"><span class="hs-identifier hs-var">compFile</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- | Compiles a C file in a docker container.</span><span>
</span><span id="line-116"></span><span class="annot"><a href="Main.html#compileFile"><span class="hs-identifier hs-type">compileFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Types.html#TargetFile"><span class="hs-identifier hs-type">TargetFile</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><a href="Types.html#SourceFile"><span class="hs-identifier hs-type">SourceFile</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Types.html#Command"><span class="hs-identifier hs-type">Command</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span id="compileFile"><span class="annot"><span class="annottext">compileFile :: Path Abs Dir
-&gt; Flow
     (FilePath, Map FilePath FilePath, [Path Abs File], FilePath)
     (Path Abs File)
</span><a href="Main.html#compileFile"><span class="hs-identifier hs-var hs-var">compileFile</span></a></span></span><span> </span><span id="local-6989586621679142585"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142585"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679142584"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142584"><span class="hs-identifier hs-var">tf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142583"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621679142583"><span class="hs-identifier hs-var">srcDeps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142582"><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142582"><span class="hs-identifier hs-var">tarDeps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142581"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142581"><span class="hs-identifier hs-var">cmd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621679142580"><span class="annot"><span class="annottext">Path Rel File
</span><a href="#local-6989586621679142580"><span class="hs-identifier hs-var">relpathCompiledFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; IO (Path Rel File)) -&gt; Flow FilePath (Path Rel File)
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Path Rel File)
forall (m :: * -&gt; *). MonadThrow m =&gt; FilePath -&gt; m (Path Rel File)
</span><span class="hs-identifier hs-var">parseRelFile</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142584"><span class="hs-identifier hs-var">tf</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621679142579"><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142579"><span class="hs-identifier hs-var">srcsInStore</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Flow (Map FilePath FilePath) [Path Abs File]
</span><a href="Main.html#write2Store"><span class="hs-identifier hs-var">write2Store</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142585"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621679142583"><span class="hs-identifier hs-var">srcDeps</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142577"><span class="annot"><span class="annottext">inputFilesInStore :: [Path Abs File]
</span><a href="#local-6989586621679142577"><span class="hs-identifier hs-var hs-var">inputFilesInStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142579"><span class="hs-identifier hs-var">srcsInStore</span></a></span><span> </span><span class="annot"><span class="annottext">[Path Abs File] -&gt; [Path Abs File] -&gt; [Path Abs File]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142582"><span class="hs-identifier hs-var">tarDeps</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621679142576"><span class="annot"><span class="annottext">Content Dir
</span><a href="#local-6989586621679142576"><span class="hs-identifier hs-var">inputDir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Flow [Path Abs File] (Content Dir)
</span><a href="Main.html#mergeFiles"><span class="hs-identifier hs-var">mergeFiles</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142585"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142577"><span class="hs-identifier hs-var">inputFilesInStore</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142574"><span class="annot"><span class="annottext">finalCmd :: FilePath
</span><a href="#local-6989586621679142574"><span class="hs-identifier hs-var hs-var">finalCmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142581"><span class="hs-identifier hs-var">cmd</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot; -o &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142584"><span class="hs-identifier hs-var">tf</span></a></span><span>
</span><span id="line-123"></span><span>      </span><span id="local-6989586621679142573"><span class="annot"><span class="annottext">scriptSrc :: FilePath
</span><a href="#local-6989586621679142573"><span class="hs-identifier hs-var hs-var">scriptSrc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;#!/usr/bin/env bash\n\
        \cp $1/*.* $PWD\n&quot;</span></span><span>
</span><span id="line-126"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142574"><span class="hs-identifier hs-var">finalCmd</span></a></span><span>
</span><span id="line-127"></span><span>          </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; Flow FilePath ()
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142572"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142572"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Current command: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142572"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142574"><span class="hs-identifier hs-var">finalCmd</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679142571"><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142571"><span class="hs-identifier hs-var">compItem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Content File
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Flow (FilePath, Path Rel File) (Item, Content File)
</span><a href="Main.html#writeExecutableString"><span class="hs-identifier hs-var">writeExecutableString</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142585"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142573"><span class="hs-identifier hs-var">scriptSrc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[relfile|script.sh|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>  </span><span id="local-6989586621679142569"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142569"><span class="hs-identifier hs-var">inMnt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO (Path Abs Dir)) -&gt; Flow FilePath (Path Abs Dir)
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO (Path Abs Dir)
forall (m :: * -&gt; *). MonadThrow m =&gt; FilePath -&gt; m (Path Abs Dir)
</span><span class="hs-identifier hs-var">parseAbsDir</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;/sandbox&quot;</span></span><span>
</span><span id="line-131"></span><span>  </span><span id="local-6989586621679142568"><span class="annot"><span class="annottext">DockerTaskInput
</span><a href="#local-6989586621679142568"><span class="hs-identifier hs-var">taskIn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Content Dir, Item, Path Abs Dir) -&gt; DockerTaskInput)
-&gt; Flow (Content Dir, Item, Path Abs Dir) DockerTaskInput
forall i o. (i -&gt; o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">pureFlow</span></span><span> </span><span class="annot"><span class="annottext">(Content Dir, Item, Path Abs Dir) -&gt; DockerTaskInput
forall t. (Content t, Item, Path Abs Dir) -&gt; DockerTaskInput
</span><a href="#local-6989586621679142567"><span class="hs-identifier hs-var">buildTaskInput</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Content Dir
</span><a href="#local-6989586621679142576"><span class="hs-identifier hs-var">inputDir</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142571"><span class="hs-identifier hs-var">compItem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142569"><span class="hs-identifier hs-var">inMnt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621679142566"><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142566"><span class="hs-identifier hs-var">resDir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DockerTaskConfig -&gt; Flow DockerTaskInput Item
</span><span class="hs-identifier hs-var">dockerFlow</span></span><span> </span><span class="annot"><span class="annottext">DockerTaskConfig
</span><a href="#local-6989586621679142565"><span class="hs-identifier hs-var">dockConf</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">DockerTaskInput
</span><a href="#local-6989586621679142568"><span class="hs-identifier hs-var">taskIn</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span id="local-6989586621679142564"><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142564"><span class="hs-identifier hs-var">resFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Content File -&gt; IO (Path Abs File))
-&gt; Flow (Content File) (Path Abs File)
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Content File -&gt; IO (Path Abs File)
forall t. Path Abs Dir -&gt; Content t -&gt; IO (Path Abs t)
</span><a href="Main.html#ioContentPath"><span class="hs-identifier hs-var">ioContentPath</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142585"><span class="hs-identifier hs-var">root</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142566"><span class="hs-identifier hs-var">resDir</span></a></span><span> </span><span class="annot"><span class="annottext">Item -&gt; Path Rel File -&gt; Content File
forall t. Item -&gt; Path Rel t -&gt; Content t
</span><span class="hs-operator hs-var">CS.:&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Path Rel File
</span><a href="#local-6989586621679142580"><span class="hs-identifier hs-var">relpathCompiledFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="annottext">Rope r mantle core (Path Abs File) (Path Abs File)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142564"><span class="hs-identifier hs-var">resFile</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621679142565"><span class="annot"><span class="annottext">dockConf :: DockerTaskConfig
</span><a href="#local-6989586621679142565"><span class="hs-identifier hs-var hs-var">dockConf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DockerTaskConfig :: Text -&gt; Text -&gt; [Arg] -&gt; DockerTaskConfig
</span><span class="hs-identifier hs-type">DE.DockerTaskConfig</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">image :: Text
</span><span class="hs-identifier hs-var">DE.image</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;gcc:7.3.0&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">command :: Text
</span><span class="hs-identifier hs-var">DE.command</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/script/script.sh&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">args :: [Arg]
</span><span class="hs-identifier hs-var">DE.args</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Arg
</span><span class="hs-string">&quot;/sandbox&quot;</span></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-137"></span><span>    </span><span id="local-6989586621679142567"><span class="annot"><span class="annottext">buildTaskInput :: (Content t, Item, Path Abs Dir) -&gt; DockerTaskInput
</span><a href="#local-6989586621679142567"><span class="hs-identifier hs-var hs-var">buildTaskInput</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679142557"><span class="annot"><span class="annottext">Content t
</span><a href="#local-6989586621679142557"><span class="hs-identifier hs-var">indir</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142556"><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142556"><span class="hs-identifier hs-var">compItem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142555"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142555"><span class="hs-identifier hs-var">mnt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="annottext">DockerTaskInput :: [VolumeBinding] -&gt; Map FilePath Text -&gt; DockerTaskInput
</span><span class="hs-identifier hs-type">DE.DockerTaskInput</span></span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inputBindings :: [VolumeBinding]
</span><span class="hs-identifier hs-var">DE.inputBindings</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-140"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VolumeBinding :: Item -&gt; Path Abs Dir -&gt; VolumeBinding
</span><span class="hs-identifier hs-type">DE.VolumeBinding</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">item :: Item
</span><span class="hs-identifier hs-var">DE.item</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142556"><span class="hs-identifier hs-var">compItem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mount :: Path Abs Dir
</span><span class="hs-identifier hs-var">DE.mount</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[absdir|/script/|]</span></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>              </span><span class="annot"><span class="annottext">VolumeBinding :: Item -&gt; Path Abs Dir -&gt; VolumeBinding
</span><span class="hs-identifier hs-type">DE.VolumeBinding</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">item :: Item
</span><span class="hs-identifier hs-var">DE.item</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Content t -&gt; Item
forall t. Content t -&gt; Item
</span><span class="hs-identifier hs-var">CS.contentItem</span></span><span> </span><span class="annot"><span class="annottext">Content t
</span><a href="#local-6989586621679142557"><span class="hs-identifier hs-var">indir</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mount :: Path Abs Dir
</span><span class="hs-identifier hs-var">DE.mount</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142555"><span class="hs-identifier hs-var">mnt</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>            </span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>          </span><span class="annot"><span class="annottext">argsVals :: Map FilePath Text
</span><span class="hs-identifier hs-var">DE.argsVals</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map FilePath Text
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">----------------------------------------------------------------------------------------</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- These are helpers for overcoming challenge of typelevel polymorphism in kernmantle.</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- In particular, this is for beating &quot;illegal polymorphic type...&quot;</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- related to impredicative polymorphism</span><span>
</span><span id="line-150"></span><span class="hs-comment">----------------------------------------------------------------------------------------</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- Wrap a flow so that we can overcome impredicative polymporphism.</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- See SO (answer by Jon Purdy): https://stackoverflow.com/a/56449258</span><span>
</span><span id="line-154"></span><span class="hs-keyword">newtype</span><span> </span><span id="Id"><span class="annot"><a href="Main.html#Id"><span class="hs-identifier hs-var">Id</span></a></span></span><span> </span><span id="local-6989586621679142805"><span class="annot"><a href="#local-6989586621679142805"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679142804"><span class="annot"><a href="#local-6989586621679142804"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Id"><span class="annot"><a href="Main.html#Id"><span class="hs-identifier hs-var">Id</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unId"><span class="annot"><span class="annottext">Id a b
-&gt; forall (m :: * -&gt; *).
   MonadIO m =&gt;
   AnyRopeWith ('[] ++ RequiredStrands) (RequiredCore m) a b
</span><a href="Main.html#unId"><span class="hs-identifier hs-var hs-var">unId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="annot"><a href="#local-6989586621679142805"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142804"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- &quot;Merge&quot; a a collection of &quot;atomic&quot; flows into a single flow from one collection to another.</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- Note that order should not matter, else the result should be reversed.</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- In particular, we process the flow/input pairs left-to-right, but build the result right-to-left.</span><span>
</span><span id="line-159"></span><span id="local-6989586621679142806"><span id="local-6989586621679142807"><span class="annot"><a href="Main.html#flowJoin"><span class="hs-identifier hs-type">flowJoin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Main.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142807"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142806"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679142807"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679142806"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-160"></span><span id="flowJoin"><span class="annot"><span class="annottext">flowJoin :: [Id a b] -&gt; Flow [a] [b]
</span><a href="Main.html#flowJoin"><span class="hs-identifier hs-var hs-var">flowJoin</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; [b]) -&gt; Flow [a] [b]
forall i o. (i -&gt; o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">pureFlow</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span class="annot"><a href="Main.html#flowJoin"><span class="hs-identifier hs-var">flowJoin</span></a></span><span> </span><span id="local-6989586621679142547"><span class="annot"><span class="annottext">ff :: [Id a b]
</span><a href="#local-6989586621679142547"><span class="hs-identifier hs-var">ff</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679142546"><span class="annot"><span class="annottext">Id a b
</span><a href="#local-6989586621679142546"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679142545"><span class="annot"><span class="annottext">[Id a b]
</span><a href="#local-6989586621679142545"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span id="local-6989586621679142544"><span class="annot"><span class="annottext">aa :: [a]
</span><a href="#local-6989586621679142544"><span class="hs-identifier hs-var">aa</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679142543"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142543"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679142542"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679142542"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-comment">-- Enforce dimensional match between flows and inputs.</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope r mantle core Bool ()
Flow Bool ()
</span><a href="Main.html#failGuardFlow"><span class="hs-identifier hs-var">failGuardFlow</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id a b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Id a b]
</span><a href="#local-6989586621679142547"><span class="hs-identifier hs-var">ff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679142544"><span class="hs-identifier hs-var">aa</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-comment">-- &quot;Run&quot; the &quot;current&quot; flow</span><span>
</span><span id="line-165"></span><span>  </span><span id="local-6989586621679142541"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679142541"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id a b
-&gt; forall (m :: * -&gt; *).
   MonadIO m =&gt;
   AnyRopeWith ('[] ++ RequiredStrands) (RequiredCore m) a b
forall a b. Id a b -&gt; Flow a b
</span><a href="Main.html#unId"><span class="hs-identifier hs-var hs-var">unId</span></a></span><span> </span><span class="annot"><span class="annottext">Id a b
</span><a href="#local-6989586621679142546"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142543"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-comment">-- Recurse on the remaining flows and inputs.</span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621679142540"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679142540"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id a b] -&gt; Flow [a] [b]
forall a b. [Id a b] -&gt; Flow [a] [b]
</span><a href="Main.html#flowJoin"><span class="hs-identifier hs-var">flowJoin</span></a></span><span> </span><span class="annot"><span class="annottext">[Id a b]
</span><a href="#local-6989586621679142545"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679142542"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><span class="annottext">Rope r mantle core [b] [b]
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679142541"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; [b] -&gt; [b]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679142540"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- Application-related</span><span>
</span><span id="line-172"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- For each of a collection of files, create a link in the store root.</span><span>
</span><span id="line-175"></span><span class="annot"><a href="Main.html#mergeFilesRaw"><span class="hs-identifier hs-type">mergeFilesRaw</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Content</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span id="mergeFilesRaw"><span class="annot"><span class="annottext">mergeFilesRaw :: Path Abs Dir -&gt; [Path Abs File] -&gt; IO (Content Dir)
</span><a href="Main.html#mergeFilesRaw"><span class="hs-identifier hs-var hs-var">mergeFilesRaw</span></a></span></span><span> </span><span id="local-6989586621679142538"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142538"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621679142537"><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142537"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; (ContentStore -&gt; IO (Content Dir)) -&gt; IO (Content Dir)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
Path Abs Dir -&gt; (ContentStore -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">CS.withStore</span></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142538"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142535"><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142535"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContentStore -&gt; [Path Abs File] -&gt; IO (Content Dir)
forall (t :: * -&gt; *) b.
(ContentHashable IO (t (Path b File)), Foldable t) =&gt;
ContentStore -&gt; t (Path b File) -&gt; IO (Content Dir)
</span><a href="#local-6989586621679142534"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142535"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[Path Abs File]
</span><a href="#local-6989586621679142537"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621679142534"><span class="annot"><span class="annottext">merge :: ContentStore -&gt; t (Path b File) -&gt; IO (Content Dir)
</span><a href="#local-6989586621679142534"><span class="hs-identifier hs-var hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621679142533"><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142533"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679142532"><span class="annot"><span class="annottext">t (Path b File)
</span><a href="#local-6989586621679142532"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142531"><span class="annot"><span class="annottext">linkIn :: Path b Dir -&gt; t (Path b File) -&gt; IO ()
</span><a href="#local-6989586621679142531"><span class="hs-identifier hs-var hs-var">linkIn</span></a></span></span><span> </span><span id="local-6989586621679142530"><span class="annot"><span class="annottext">Path b Dir
</span><a href="#local-6989586621679142530"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Path b File -&gt; IO ()) -&gt; t (Path b File) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142528"><span class="annot"><span class="annottext">Path b File
</span><a href="#local-6989586621679142528"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">createLink</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path b File -&gt; FilePath
forall b t. Path b t -&gt; FilePath
</span><span class="hs-identifier hs-var">toFilePath</span></span><span> </span><span class="annot"><span class="annottext">Path b File
</span><a href="#local-6989586621679142528"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path b File -&gt; FilePath
forall b t. Path b t -&gt; FilePath
</span><span class="hs-identifier hs-var">toFilePath</span></span><span> </span><span class="annot"><span class="annottext">(Path b File -&gt; FilePath) -&gt; Path b File -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Path b Dir
</span><a href="#local-6989586621679142530"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Path b Dir -&gt; Path Rel File -&gt; Path b File
forall b t. Path b Dir -&gt; Path Rel t -&gt; Path b t
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Path b File -&gt; Path Rel File
forall b. Path b File -&gt; Path Rel File
</span><span class="hs-identifier hs-var">filename</span></span><span> </span><span class="annot"><span class="annottext">Path b File
</span><a href="#local-6989586621679142528"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Item -&gt; Content Dir
</span><span class="hs-identifier hs-var">CS.All</span></span><span> </span><span class="annot"><span class="annottext">(Item -&gt; Content Dir) -&gt; IO Item -&gt; IO (Content Dir)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ContentStore
-&gt; NoCache
-&gt; (ContentHash -&gt; IO ())
-&gt; (Path Abs Dir -&gt; t (Path b File) -&gt; IO ())
-&gt; t (Path b File)
-&gt; IO Item
forall (m :: * -&gt; *) remoteCacher t.
(MonadIO m, MonadMask m, MonadUnliftIO m, Cacher m remoteCacher,
 ContentHashable IO t) =&gt;
ContentStore
-&gt; remoteCacher
-&gt; (ContentHash -&gt; m ())
-&gt; (Path Abs Dir -&gt; t -&gt; m ())
-&gt; t
-&gt; m Item
</span><span class="hs-identifier hs-var">CS.putInStore</span></span><span> </span><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142533"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">NoCache
</span><span class="hs-identifier hs-var">RC.NoCache</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ContentHash
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; ()
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;uh-oh!&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; t (Path b File) -&gt; IO ()
forall (t :: * -&gt; *) b b.
Foldable t =&gt;
Path b Dir -&gt; t (Path b File) -&gt; IO ()
</span><a href="#local-6989586621679142531"><span class="hs-identifier hs-var">linkIn</span></a></span><span> </span><span class="annot"><span class="annottext">t (Path b File)
</span><a href="#local-6989586621679142532"><span class="hs-identifier hs-var">files</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- Flow version of linking a collection of files into the store root</span><span>
</span><span id="line-183"></span><span class="annot"><a href="Main.html#mergeFiles"><span class="hs-identifier hs-type">mergeFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Content</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="mergeFiles"><span class="annot"><span class="annottext">mergeFiles :: Path Abs Dir -&gt; Flow [Path Abs File] (Content Dir)
</span><a href="Main.html#mergeFiles"><span class="hs-identifier hs-var hs-var">mergeFiles</span></a></span></span><span> </span><span id="local-6989586621679142522"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142522"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Path Abs File] -&gt; IO (Content Dir))
-&gt; Flow [Path Abs File] (Content Dir)
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir -&gt; [Path Abs File] -&gt; IO (Content Dir)
</span><a href="Main.html#mergeFilesRaw"><span class="hs-identifier hs-var">mergeFilesRaw</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142522"><span class="hs-identifier hs-var">root</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- Write to a file at given relpath, in the store at the given root.</span><span>
</span><span id="line-187"></span><span class="annot"><a href="Main.html#writeExecutableString"><span class="hs-identifier hs-type">writeExecutableString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rel</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CS.Item</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Content</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span id="writeExecutableString"><span class="annot"><span class="annottext">writeExecutableString :: Path Abs Dir -&gt; Flow (FilePath, Path Rel File) (Item, Content File)
</span><a href="Main.html#writeExecutableString"><span class="hs-identifier hs-var hs-var">writeExecutableString</span></a></span></span><span> </span><span id="local-6989586621679142521"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142521"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FilePath, Path Rel File) -&gt; IO (Item, Content File))
-&gt; Flow (FilePath, Path Rel File) (Item, Content File)
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; (Path Abs File -&gt; FilePath -&gt; IO ())
-&gt; (FilePath, Path Rel File)
-&gt; IO (Item, Content File)
forall a t.
(ContentHashable IO a, Typeable t) =&gt;
Path Abs Dir
-&gt; (Path Abs t -&gt; a -&gt; IO ())
-&gt; (a, Path Rel t)
-&gt; IO (Item, Content t)
</span><a href="Main.html#putInStoreAt"><span class="hs-identifier hs-var">putInStoreAt</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142521"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142519"><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142519"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679142518"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142518"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142517"><span class="annot"><span class="annottext">p' :: FilePath
</span><a href="#local-6989586621679142517"><span class="hs-identifier hs-var hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs File -&gt; FilePath
</span><span class="hs-identifier hs-var">fromAbsFile</span></span><span> </span><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142519"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142517"><span class="hs-identifier hs-var">p'</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142518"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FileMode -&gt; IO ()
</span><span class="hs-identifier hs-var">setFileMode</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142517"><span class="hs-identifier hs-var">p'</span></a></span><span> </span><span class="annot"><span class="annottext">FileMode
</span><span class="hs-identifier hs-var">accessModes</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- Find the collection of rules in the given makefile for the given collection of targets.</span><span>
</span><span id="line-191"></span><span class="annot"><a href="Main.html#findRules"><span class="hs-identifier hs-type">findRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Types.html#MakeFile"><span class="hs-identifier hs-type">MakeFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Types.html#TargetFile"><span class="hs-identifier hs-type">TargetFile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Types.html#MakeRule"><span class="hs-identifier hs-type">MakeRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-192"></span><span id="findRules"><span class="annot"><span class="annottext">findRules :: MakeFile -&gt; [FilePath] -&gt; Maybe [MakeRule]
</span><a href="Main.html#findRules"><span class="hs-identifier hs-var hs-var">findRules</span></a></span></span><span> </span><span class="annot"><a href="Types.html#MakeFile"><span class="hs-identifier hs-type">MakeFile</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">allrules :: MakeFile -&gt; Set MakeRule
</span><a href="Types.html#allrules"><span class="hs-identifier hs-var">allrules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679142514"><span class="annot"><span class="annottext">Set MakeRule
</span><a href="#local-6989586621679142514"><span class="hs-identifier hs-var">rules</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679142513"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142513"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ())
-&gt; (Set FilePath -&gt; Bool) -&gt; Set FilePath -&gt; Maybe ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">(Set FilePath -&gt; Maybe ()) -&gt; Set FilePath -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.difference</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142511"><span class="hs-identifier hs-var">tfileSet</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142510"><span class="hs-identifier hs-var">ruleTarNmSet</span></a></span><span> </span><span class="hs-comment">-- check that each each target has a rule.</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-comment">-- We're only interested in the rules for the given set of targets</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142509"><span class="annot"><span class="annottext">targetRules :: Set MakeRule
</span><a href="#local-6989586621679142509"><span class="hs-identifier hs-var hs-var">targetRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MakeRule -&gt; Bool) -&gt; Set MakeRule -&gt; Set MakeRule
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Set FilePath -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`Set.member`</span></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621679142511"><span class="hs-identifier hs-var">tfileSet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool) -&gt; (MakeRule -&gt; FilePath) -&gt; MakeRule -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; FilePath
</span><a href="Types.html#mkRuleTarNm"><span class="hs-identifier hs-var">mkRuleTarNm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set MakeRule
</span><a href="#local-6989586621679142514"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><span class="annottext">[MakeRule] -&gt; Maybe [MakeRule]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([MakeRule] -&gt; Maybe [MakeRule]) -&gt; [MakeRule] -&gt; Maybe [MakeRule]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set MakeRule -&gt; [MakeRule]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set MakeRule
</span><a href="#local-6989586621679142509"><span class="hs-identifier hs-var">targetRules</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679142510"><span class="annot"><span class="annottext">ruleTarNmSet :: Set FilePath
</span><a href="#local-6989586621679142510"><span class="hs-identifier hs-var hs-var">ruleTarNmSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MakeRule -&gt; FilePath) -&gt; Set MakeRule -&gt; Set FilePath
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">MakeRule -&gt; FilePath
</span><a href="Types.html#mkRuleTarNm"><span class="hs-identifier hs-var">mkRuleTarNm</span></a></span><span> </span><span class="annot"><span class="annottext">Set MakeRule
</span><a href="#local-6989586621679142514"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621679142511"><span class="annot"><span class="annottext">tfileSet :: Set FilePath
</span><a href="#local-6989586621679142511"><span class="hs-identifier hs-var hs-var">tfileSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; Set FilePath
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679142513"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- Storage-related</span><span>
</span><span id="line-203"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- Use a given function to store a given value at given relative path, within store rooted at given path.</span><span>
</span><span id="line-205"></span><span id="local-6989586621679142714"><span id="local-6989586621679142715"><span class="annot"><a href="Main.html#putInStoreAt"><span class="hs-identifier hs-type">putInStoreAt</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContentHashable</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679142715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679142714"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><a href="#local-6989586621679142714"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679142715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rel</span></span><span> </span><span class="annot"><a href="#local-6989586621679142714"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CS.Item</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CS.Content</span></span><span> </span><span class="annot"><a href="#local-6989586621679142714"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-211"></span><span id="putInStoreAt"><span class="annot"><span class="annottext">putInStoreAt :: Path Abs Dir
-&gt; (Path Abs t -&gt; a -&gt; IO ())
-&gt; (a, Path Rel t)
-&gt; IO (Item, Content t)
</span><a href="Main.html#putInStoreAt"><span class="hs-identifier hs-var hs-var">putInStoreAt</span></a></span></span><span> </span><span id="local-6989586621679142505"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142505"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621679142504"><span class="annot"><span class="annottext">Path Abs t -&gt; a -&gt; IO ()
</span><a href="#local-6989586621679142504"><span class="hs-identifier hs-var">put</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679142503"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142503"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142502"><span class="annot"><span class="annottext">Path Rel t
</span><a href="#local-6989586621679142502"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; (ContentStore -&gt; IO (Item, Content t)) -&gt; IO (Item, Content t)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
Path Abs Dir -&gt; (ContentStore -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">CS.withStore</span></span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142505"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679142501"><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142501"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679142500"><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142500"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContentStore
-&gt; NoCache
-&gt; (ContentHash -&gt; IO ())
-&gt; (Path Abs Dir -&gt; a -&gt; IO ())
-&gt; a
-&gt; IO Item
forall (m :: * -&gt; *) remoteCacher t.
(MonadIO m, MonadMask m, MonadUnliftIO m, Cacher m remoteCacher,
 ContentHashable IO t) =&gt;
ContentStore
-&gt; remoteCacher
-&gt; (ContentHash -&gt; m ())
-&gt; (Path Abs Dir -&gt; t -&gt; m ())
-&gt; t
-&gt; m Item
</span><span class="hs-identifier hs-var">CS.putInStore</span></span><span> </span><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142501"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">NoCache
</span><span class="hs-identifier hs-var">RC.NoCache</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ContentHash
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142499"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142499"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679142498"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142498"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Path Abs t -&gt; a -&gt; IO ()
</span><a href="#local-6989586621679142504"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142499"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Path Rel t -&gt; Path Abs t
forall b t. Path b Dir -&gt; Path Rel t -&gt; Path b t
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Path Rel t
</span><a href="#local-6989586621679142502"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142498"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142503"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">(Item, Content t) -&gt; IO (Item, Content t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142500"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Item
</span><a href="#local-6989586621679142500"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="annot"><span class="annottext">Item -&gt; Path Rel t -&gt; Content t
forall t. Item -&gt; Path Rel t -&gt; Content t
</span><span class="hs-operator hs-var">CS.:&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Path Rel t
</span><a href="#local-6989586621679142502"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">-- Write each content to file with associated name, within store rooted at given path.</span><span>
</span><span id="line-220"></span><span class="annot"><a href="Main.html#write2Store"><span class="hs-identifier hs-type">write2Store</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><a href="Main.html#FileName"><span class="hs-identifier hs-type">FileName</span></a></span><span> </span><span class="annot"><a href="Main.html#FileContent"><span class="hs-identifier hs-type">FileContent</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">File</span></span><span class="hs-special">]</span><span>
</span><span id="line-221"></span><span id="write2Store"><span class="annot"><span class="annottext">write2Store :: Path Abs Dir -&gt; Flow (Map FilePath FilePath) [Path Abs File]
</span><a href="Main.html#write2Store"><span class="hs-identifier hs-var hs-var">write2Store</span></a></span></span><span> </span><span id="local-6989586621679142497"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142497"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679142496"><span class="annot"><span class="annottext">ioFixSrcFileData :: (FilePath, a) -&gt; f (a, Path Rel File)
</span><a href="#local-6989586621679142496"><span class="hs-identifier hs-var hs-var">ioFixSrcFileData</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679142495"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142495"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142494"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142494"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142493"><span class="annot"><span class="annottext">Path Rel File
</span><a href="#local-6989586621679142493"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679142494"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Path Rel File
</span><a href="#local-6989586621679142493"><span class="hs-identifier hs-var">y'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Path Rel File -&gt; (a, Path Rel File))
-&gt; f (Path Rel File) -&gt; f (a, Path Rel File)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; f (Path Rel File)
forall (m :: * -&gt; *). MonadThrow m =&gt; FilePath -&gt; m (Path Rel File)
</span><span class="hs-identifier hs-var">parseRelFile</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142495"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-223"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Map FilePath FilePath -&gt; IO [Path Abs File])
-&gt; Flow (Map FilePath FilePath) [Path Abs File]
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679142492"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621679142492"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>            </span><span class="annot"><span class="annottext">((FilePath, FilePath) -&gt; IO (Path Abs File))
-&gt; [(FilePath, FilePath)] -&gt; IO [Path Abs File]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-226"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679142491"><span class="annot"><span class="annottext">(FilePath, FilePath)
</span><a href="#local-6989586621679142491"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>                  </span><span id="local-6989586621679142490"><span class="annot"><span class="annottext">(FilePath, Path Rel File)
</span><a href="#local-6989586621679142490"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath, FilePath) -&gt; IO (FilePath, Path Rel File)
forall (f :: * -&gt; *) a.
MonadThrow f =&gt;
(FilePath, a) -&gt; f (a, Path Rel File)
</span><a href="#local-6989586621679142496"><span class="hs-identifier hs-var">ioFixSrcFileData</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath, FilePath)
</span><a href="#local-6989586621679142491"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-228"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Item
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142489"><span class="annot"><span class="annottext">Content File
</span><a href="#local-6989586621679142489"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; (Path Abs File -&gt; FilePath -&gt; IO ())
-&gt; (FilePath, Path Rel File)
-&gt; IO (Item, Content File)
forall a t.
(ContentHashable IO a, Typeable t) =&gt;
Path Abs Dir
-&gt; (Path Abs t -&gt; a -&gt; IO ())
-&gt; (a, Path Rel t)
-&gt; IO (Item, Content t)
</span><a href="Main.html#putInStoreAt"><span class="hs-identifier hs-var">putInStoreAt</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142497"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">writeFile</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; FilePath -&gt; IO ())
-&gt; (Path Abs File -&gt; FilePath)
-&gt; Path Abs File
-&gt; FilePath
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Path Abs File -&gt; FilePath
</span><span class="hs-identifier hs-var">fromAbsFile</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FilePath, Path Rel File)
</span><a href="#local-6989586621679142490"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-229"></span><span>                  </span><span id="local-6989586621679142488"><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142488"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir -&gt; Content File -&gt; IO (Path Abs File)
forall t. Path Abs Dir -&gt; Content t -&gt; IO (Path Abs t)
</span><a href="Main.html#ioContentPath"><span class="hs-identifier hs-var">ioContentPath</span></a></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142497"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">Content File
</span><a href="#local-6989586621679142489"><span class="hs-identifier hs-var">z</span></a></span><span>
</span><span id="line-230"></span><span>                  </span><span class="annot"><span class="annottext">Path Abs File -&gt; IO (Path Abs File)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Path Abs File
</span><a href="#local-6989586621679142488"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-231"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map FilePath FilePath -&gt; [(FilePath, FilePath)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621679142492"><span class="hs-identifier hs-var">files</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- Get the path to content in the store.</span><span>
</span><span id="line-236"></span><span id="local-6989586621679142769"><span class="annot"><a href="Main.html#ioContentPath"><span class="hs-identifier hs-type">ioContentPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Content</span></span><span> </span><span class="annot"><a href="#local-6989586621679142769"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><a href="#local-6989586621679142769"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-237"></span><span id="ioContentPath"><span class="annot"><span class="annottext">ioContentPath :: Path Abs Dir -&gt; Content t -&gt; IO (Path Abs t)
</span><a href="Main.html#ioContentPath"><span class="hs-identifier hs-var hs-var">ioContentPath</span></a></span></span><span> </span><span id="local-6989586621679142486"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142486"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span id="local-6989586621679142485"><span class="annot"><span class="annottext">Content t
</span><a href="#local-6989586621679142485"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
-&gt; (ContentStore -&gt; IO (Path Abs t)) -&gt; IO (Path Abs t)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadMask m) =&gt;
Path Abs Dir -&gt; (ContentStore -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">CS.withStore</span></span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142486"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142484"><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142484"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Path Abs t -&gt; IO (Path Abs t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContentStore -&gt; Content t -&gt; Path Abs t
forall t. ContentStore -&gt; Content t -&gt; Path Abs t
</span><span class="hs-identifier hs-var">CS.contentPath</span></span><span> </span><span class="annot"><span class="annottext">ContentStore
</span><a href="#local-6989586621679142484"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Content t
</span><a href="#local-6989586621679142485"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- General flow-related</span><span>
</span><span id="line-241"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-242"></span><span class="annot"><a href="Main.html#getRunConfigWithoutFile"><span class="hs-identifier hs-type">getRunConfigWithoutFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Abs</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dir</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RunFlowConfig</span></span><span>
</span><span id="line-243"></span><span id="getRunConfigWithoutFile"><span class="annot"><span class="annottext">getRunConfigWithoutFile :: Path Abs Dir -&gt; RunFlowConfig
</span><a href="Main.html#getRunConfigWithoutFile"><span class="hs-identifier hs-var hs-var">getRunConfigWithoutFile</span></a></span></span><span> </span><span id="local-6989586621679142482"><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142482"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunFlowConfig :: Path Abs Dir -&gt; Maybe (Path Abs File) -&gt; RunFlowConfig
</span><span class="hs-identifier hs-type">RunFlowConfig</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">storePath :: Path Abs Dir
</span><span class="hs-identifier hs-var">storePath</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path Abs Dir
</span><a href="#local-6989586621679142482"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">configFile :: Maybe (Path Abs File)
</span><span class="hs-identifier hs-var">configFile</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Path Abs File)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">}</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">-- Flow that fails iff given flag is False.</span><span>
</span><span id="line-246"></span><span class="annot"><a href="Main.html#failGuardFlow"><span class="hs-identifier hs-type">failGuardFlow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="failGuardFlow"><span class="annot"><span class="annottext">failGuardFlow :: AnyRopeWith ('[] ++ RequiredStrands) (RequiredCore m) Bool ()
</span><a href="Main.html#failGuardFlow"><span class="hs-identifier hs-var hs-var">failGuardFlow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span id="local-6989586621679142478"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679142478"><span class="hs-identifier hs-var">test</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679142478"><span class="hs-identifier hs-var">test</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rope r mantle core () ()
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope r mantle core () ()
forall a. Flow () a
</span><a href="Main.html#failNow"><span class="hs-identifier hs-var">failNow</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>      </span><span class="annot"><span class="annottext">Rope r mantle core () ()
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><span class="hs-identifier hs-var">returnA</span></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- Degenerate flow failing with fixed, basic error message</span><span>
</span><span id="line-255"></span><span id="local-6989586621679142819"><span class="annot"><a href="Main.html#failNow"><span class="hs-identifier hs-type">failNow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679142819"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-256"></span><span id="failNow"><span class="annot"><span class="annottext">failNow :: AnyRopeWith ('[] ++ RequiredStrands) (RequiredCore m) () a
</span><a href="Main.html#failNow"><span class="hs-identifier hs-var hs-var">failNow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">(() -&gt; IO a) -&gt; Flow () a
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO a
forall a. () -&gt; a
</span><a href="#local-6989586621679142477"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621679142477"><span class="annot"><span class="annottext">err :: () -&gt; a
</span><a href="#local-6989586621679142477"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; a
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;error&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-comment">-- Flow that accepts message and fails with that as the error message</span><span>
</span><span id="line-262"></span><span id="local-6989586621679142476"><span class="annot"><a href="Main.html#failWith"><span class="hs-identifier hs-type">failWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="#local-6989586621679142476"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-263"></span><span id="failWith"><span class="annot"><span class="annottext">failWith :: AnyRopeWith ('[] ++ RequiredStrands) (RequiredCore m) FilePath a
</span><a href="Main.html#failWith"><span class="hs-identifier hs-var hs-var">failWith</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO a) -&gt; Flow FilePath a
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679142474"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142474"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO a
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142474"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- Degenerate flow that prints the given message</span><span>
</span><span id="line-266"></span><span class="annot"><a href="Main.html#msgFlow"><span class="hs-identifier hs-type">msgFlow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Flow</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span id="msgFlow"><span class="annot"><span class="annottext">msgFlow :: FilePath -&gt; Flow () ()
</span><a href="Main.html#msgFlow"><span class="hs-identifier hs-var hs-var">msgFlow</span></a></span></span><span> </span><span id="local-6989586621679142473"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142473"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() -&gt; IO ()) -&gt; Flow () ()
forall i o. (i -&gt; IO o) -&gt; Flow i o
</span><span class="hs-identifier hs-var">ioFlow</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679142473"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span></pre></body></html>