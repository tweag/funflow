<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns
           , CPP
           , ExistentialQuantification
           , NoImplicitPrelude
           , RecordWildCards
           , TypeSynonymInstances
           , FlexibleInstances
  #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- The event manager supports event notification on fds. Each fd may</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- have multiple callbacks registered, each listening for a different</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- set of events. Registrations may be automatically deactivated after</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- the occurrence of an event (&quot;one-shot mode&quot;) or active until</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- explicitly unregistered.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- If an fd has only one-shot registrations then we use one-shot</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- polling if available. Otherwise we use multi-shot polling.</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Event.Manager</span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Types</span></span><span>
</span><span id="line-23"></span><span>      </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier">EventManager</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Creation</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#new"><span class="hs-identifier">new</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier">newWith</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier">newDefaultBackend</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Running</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#finished"><span class="hs-identifier">finished</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier">loop</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#step"><span class="hs-identifier">step</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#shutdown"><span class="hs-identifier">shutdown</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#release"><span class="hs-identifier">release</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier">cleanup</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier">wakeManager</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>      </span><span class="annot"><span class="hs-comment">-- * State</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier">callbackTableVar</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier">emControl</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Registering interest in I/O events</span></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier">Lifetime</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier">Event</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier">evtRead</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier">evtWrite</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier">IOCallback</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier">FdKey</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#keyFd"><span class="hs-identifier">keyFd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier">FdData</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier">registerFd</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier">unregisterFd_</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#unregisterFd"><span class="hs-identifier">unregisterFd</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#closeFd"><span class="hs-identifier">closeFd</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier">closeFd_</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span class="hs-cpp">

#include &quot;EventConfig.h&quot;
</span><span>
</span><span id="line-60"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- Imports</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.MVar.html#MVar"><span class="hs-identifier">MVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.MVar.html#newMVar"><span class="hs-identifier">newMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.MVar.html#putMVar"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>                                </span><span class="annot"><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier">tryPutMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier">takeMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier">withMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Exception.Base.html#onException"><span class="hs-identifier">onException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Bits.html"><span class="hs-identifier">Data.Bits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Bits.html#.%26."><span class="hs-operator">(.&amp;.)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Foldable.html#forM_"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Functor.html#void"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier">IORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier">atomicModifyIORef'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.IORef.html#mkWeakIORef"><span class="hs-identifier">mkWeakIORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.IORef.html#newIORef"><span class="hs-identifier">newIORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.IORef.html#readIORef"><span class="hs-identifier">readIORef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                   </span><span class="annot"><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier">writeIORef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Maybe.html#maybe"><span class="hs-identifier">maybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.OldList.html"><span class="hs-identifier">Data.OldList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.OldList.html#partition"><span class="hs-identifier">partition</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Arr.html"><span class="hs-identifier">GHC.Arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Arr.html#Array"><span class="hs-identifier">Array</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Arr.html#listArray"><span class="hs-identifier">listArray</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Conc.Sync.html"><span class="hs-identifier">GHC.Conc.Sync</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier">yield</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.List.html"><span class="hs-identifier">GHC.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.List.html#filter"><span class="hs-identifier">filter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.List.html#replicate"><span class="hs-identifier">replicate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Num.html"><span class="hs-identifier">GHC.Num</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Num.html#Num"><span class="hs-identifier">Num</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Real.html"><span class="hs-identifier">GHC.Real</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier">fromIntegral</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Show.html"><span class="hs-identifier">GHC.Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Show.html#Show"><span class="hs-identifier">Show</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Event.Control.html"><span class="hs-identifier">GHC.Event.Control</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Event.IntTable.html"><span class="hs-identifier">GHC.Event.IntTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier">IntTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html"><span class="hs-identifier">GHC.Event.Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier">Backend</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier">Event</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier">evtClose</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier">evtRead</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#evtWrite"><span class="hs-identifier">evtWrite</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>                           </span><span class="annot"><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier">Lifetime</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier">EventLifetime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Timeout"><span class="hs-identifier">Timeout</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Event.Unique.html"><span class="hs-identifier">GHC.Event.Unique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Unique.html#Unique"><span class="hs-identifier">Unique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Unique.html#UniqueSource"><span class="hs-identifier">UniqueSource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Unique.html#newSource"><span class="hs-identifier">newSource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Unique.html#newUnique"><span class="hs-identifier">newUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.Posix.Types.html"><span class="hs-identifier">System.Posix.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier">Fd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Event.IntTable.html"><span class="hs-identifier">GHC.Event.IntTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IT</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html"><span class="hs-identifier">GHC.Event.Internal</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span class="hs-cpp">

#if defined(HAVE_KQUEUE)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Event.KQueue</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">KQueue</span><span class="hs-cpp">
#elif defined(HAVE_EPOLL)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Event.EPoll.html"><span class="hs-identifier">GHC.Event.EPoll</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EPoll</span></span><span class="hs-cpp">
#elif defined(HAVE_POLL)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Event.Poll</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Poll</span><span class="hs-cpp">
#else
</span><span class="hs-cpp"># error not implemented for this operating system
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-100"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- Types</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">data</span><span> </span><span id="FdData"><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FdData"><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-104"></span><span>      </span><span id="fdKey"><span class="annot"><span class="annottext">FdData -&gt; FdKey
</span><a href="GHC.Event.Manager.html#fdKey"><span class="hs-identifier hs-var hs-var">fdKey</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="fdEvents"><span class="annot"><span class="annottext">FdData -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier hs-var hs-var">fdEvents</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_fdCallback"><span class="annot"><span class="annottext">FdData -&gt; IOCallback
</span><a href="GHC.Event.Manager.html#_fdCallback"><span class="hs-identifier hs-var hs-var">_fdCallback</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- | A file descriptor registration cookie.</span><span>
</span><span id="line-110"></span><span class="hs-keyword">data</span><span> </span><span id="FdKey"><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-var">FdKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FdKey"><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-var">FdKey</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-111"></span><span>      </span><span id="keyFd"><span class="annot"><span class="annottext">FdKey -&gt; Fd
</span><a href="GHC.Event.Manager.html#keyFd"><span class="hs-identifier hs-var hs-var">keyFd</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="keyUnique"><span class="annot"><span class="annottext">FdKey -&gt; Unique
</span><a href="GHC.Event.Manager.html#keyUnique"><span class="hs-identifier hs-var hs-var">keyUnique</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span id="local-6989586621679525208"><span id="local-6989586621679525210"><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#Eq/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span>   </span><span class="hs-comment">-- ^ @since 4.4.0.0</span></span></span><span>
</span><span id="line-114"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525201"><span id="local-6989586621679525203"><span id="local-6989586621679525205"><span class="annot"><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-comment">-- ^ @since 4.4.0.0</span></span></span></span><span>
</span><span id="line-115"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-comment">-- | Callback invoked on I/O events.</span><span>
</span><span id="line-118"></span><span class="hs-keyword">type</span><span> </span><span id="IOCallback"><span class="annot"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-var">IOCallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="GHC.Event.Manager.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Created"><span class="annot"><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a></span></span><span>
</span><span id="line-121"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="Running"><span class="annot"><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span></span><span>
</span><span id="line-122"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="Dying"><span class="annot"><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier hs-var">Dying</span></a></span></span><span>
</span><span id="line-123"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="Releasing"><span class="annot"><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a></span></span><span>
</span><span id="line-124"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span id="Finished"><span class="annot"><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span></span><span>
</span><span id="line-125"></span><span>             </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span id="local-6989586621679525191"><span id="local-6989586621679525193"><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#Eq/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span>   </span><span class="hs-comment">-- ^ @since 4.4.0.0</span></span></span><span>
</span><span id="line-126"></span><span>                      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525185"><span id="local-6989586621679525187"><span id="local-6989586621679525189"><span class="annot"><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-comment">-- ^ @since 4.4.0.0</span></span></span></span><span>
</span><span id="line-127"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | The event manager state.</span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="EventManager"><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventManager"><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-var">EventManager</span></a></span></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="emBackend"><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emFds"><span class="annot"><span class="annottext">EventManager -&gt; Array Int (MVar (IntTable [FdData]))
</span><a href="GHC.Event.Manager.html#emFds"><span class="hs-identifier hs-var hs-var">emFds</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Arr.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emState"><span class="annot"><span class="annottext">EventManager -&gt; IORef State
</span><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier hs-var hs-var">emState</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emUniqueSource"><span class="annot"><span class="annottext">EventManager -&gt; UniqueSource
</span><a href="GHC.Event.Manager.html#emUniqueSource"><span class="hs-identifier hs-var hs-var">emUniqueSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Unique.html#UniqueSource"><span class="hs-identifier hs-type">UniqueSource</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emControl"><span class="annot"><span class="annottext">EventManager -&gt; Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var hs-var">emControl</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Event.Control.html#Control"><span class="hs-identifier hs-type">Control</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emLock"><span class="annot"><span class="annottext">EventManager -&gt; MVar ()
</span><a href="GHC.Event.Manager.html#emLock"><span class="hs-identifier hs-var hs-var">emLock</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- must be power of 2</span><span>
</span><span id="line-140"></span><span class="annot"><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-type">callbackArraySize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-141"></span><span id="callbackArraySize"><span class="annot"><span class="annottext">callbackArraySize :: Int
</span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var hs-var">callbackArraySize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="annot"><a href="GHC.Event.Manager.html#hashFd"><span class="hs-identifier hs-type">hashFd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-144"></span><span id="hashFd"><span class="annot"><span class="annottext">hashFd :: Fd -&gt; Int
</span><a href="GHC.Event.Manager.html#hashFd"><span class="hs-identifier hs-var hs-var">hashFd</span></a></span></span><span> </span><span id="local-6989586621679525176"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525176"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525176"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="Data.Bits.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#hashFd"><span class="hs-pragma hs-type">hashFd</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="annot"><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-type">callbackTableVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span id="callbackTableVar"><span class="annot"><span class="annottext">callbackTableVar :: EventManager -&gt; Fd -&gt; MVar (IntTable [FdData])
</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var hs-var">callbackTableVar</span></a></span></span><span> </span><span id="local-6989586621679525175"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525175"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525174"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525174"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; Array Int (MVar (IntTable [FdData]))
</span><a href="GHC.Event.Manager.html#emFds"><span class="hs-identifier hs-var hs-var">emFds</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525175"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Array Int (MVar (IntTable [FdData]))
-&gt; Int -&gt; MVar (IntTable [FdData])
forall i e. Ix i =&gt; Array i e -&gt; i -&gt; e
</span><a href="GHC.Arr.html#%21"><span class="hs-glyph hs-var">!</span></a></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Int
</span><a href="GHC.Event.Manager.html#hashFd"><span class="hs-identifier hs-var">hashFd</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525174"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-149"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-pragma hs-type">callbackTableVar</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-type">haveOneShot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-152"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-pragma hs-type">haveOneShot</span></a></span><span> </span><span class="hs-pragma">#-}</span><span class="hs-cpp">
#if defined(darwin_HOST_OS) || defined(ios_HOST_OS)
</span><span class="hs-identifier">haveOneShot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#elif defined(HAVE_EPOLL) || defined(HAVE_KQUEUE)
</span><span id="haveOneShot"><span class="annot"><span class="annottext">haveOneShot :: Bool
</span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var hs-var">haveOneShot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">haveOneShot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span class="hs-cpp">
#endif
</span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- Creation</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="annot"><a href="GHC.Event.Manager.html#handleControlEvent"><span class="hs-identifier hs-type">handleControlEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span id="handleControlEvent"><span class="annot"><span class="annottext">handleControlEvent :: EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#handleControlEvent"><span class="hs-identifier hs-var hs-var">handleControlEvent</span></a></span></span><span> </span><span id="local-6989586621679525171"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525171"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525170"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525170"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525169"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525169"><span class="hs-identifier hs-var">_evt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>  </span><span id="local-6989586621679525168"><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621679525168"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Control -&gt; Fd -&gt; IO ControlMessage
</span><a href="GHC.Event.Control.html#readControlMessage"><span class="hs-identifier hs-var">readControlMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var hs-var">emControl</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525171"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525170"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621679525168"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="GHC.Event.Control.html#CMsgWakeup"><span class="hs-identifier hs-var">CMsgWakeup</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="GHC.Event.Control.html#CMsgDie"><span class="hs-identifier hs-var">CMsgDie</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; State -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; IORef State
</span><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier hs-var hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525171"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">ControlMessage
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="annot"><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier hs-type">newDefaultBackend</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span class="hs-cpp">
#if defined(HAVE_KQUEUE)
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">KQueue.new</span><span class="hs-cpp">
#elif defined(HAVE_EPOLL)
</span><span id="newDefaultBackend"><span class="annot"><span class="annottext">newDefaultBackend :: IO Backend
</span><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier hs-var hs-var">newDefaultBackend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Backend
</span><a href="GHC.Event.EPoll.html#new"><span class="hs-identifier hs-var">EPoll.new</span></a></span><span class="hs-cpp">
#elif defined(HAVE_POLL)
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Poll.new</span><span class="hs-cpp">
#else
</span><span class="hs-identifier">newDefaultBackend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">errorWithoutStackTrace</span><span> </span><span class="hs-string">&quot;no back end for this platform&quot;</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Create a new event manager.</span><span>
</span><span id="line-183"></span><span class="annot"><a href="GHC.Event.Manager.html#new"><span class="hs-identifier hs-type">new</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span>
</span><span id="line-184"></span><span id="new"><span class="annot"><span class="annottext">new :: IO EventManager
</span><a href="GHC.Event.Manager.html#new"><span class="hs-identifier hs-var hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; IO EventManager
</span><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier hs-var">newWith</span></a></span><span> </span><span class="annot"><span class="annottext">(Backend -&gt; IO EventManager) -&gt; IO Backend -&gt; IO EventManager
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO Backend
</span><a href="GHC.Event.Manager.html#newDefaultBackend"><span class="hs-identifier hs-var">newDefaultBackend</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Create a new 'EventManager' with the given polling backend.</span><span>
</span><span id="line-187"></span><span class="annot"><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier hs-type">newWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Backend"><span class="hs-identifier hs-type">Backend</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span>
</span><span id="line-188"></span><span id="newWith"><span class="annot"><span class="annottext">newWith :: Backend -&gt; IO EventManager
</span><a href="GHC.Event.Manager.html#newWith"><span class="hs-identifier hs-var hs-var">newWith</span></a></span></span><span> </span><span id="local-6989586621679525162"><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525162"><span class="hs-identifier hs-var">be</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>  </span><span id="local-6989586621679525161"><span class="annot"><span class="annottext">Array Int (MVar (IntTable [FdData]))
</span><a href="#local-6989586621679525161"><span class="hs-identifier hs-var">iofds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([MVar (IntTable [FdData])]
 -&gt; Array Int (MVar (IntTable [FdData])))
-&gt; IO [MVar (IntTable [FdData])]
-&gt; IO (Array Int (MVar (IntTable [FdData])))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int, Int)
-&gt; [MVar (IntTable [FdData])]
-&gt; Array Int (MVar (IntTable [FdData]))
forall i e. Ix i =&gt; (i, i) -&gt; [e] -&gt; Array i e
</span><a href="GHC.Arr.html#listArray"><span class="hs-identifier hs-var">listArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO [MVar (IntTable [FdData])]
 -&gt; IO (Array Int (MVar (IntTable [FdData]))))
-&gt; IO [MVar (IntTable [FdData])]
-&gt; IO (Array Int (MVar (IntTable [FdData])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-190"></span><span>           </span><span class="annot"><span class="annottext">Int
-&gt; IO (MVar (IntTable [FdData])) -&gt; IO [MVar (IntTable [FdData])]
forall (m :: * -&gt; *) a. Monad m =&gt; Int -&gt; m a -&gt; m [a]
</span><a href="#local-6989586621679525160"><span class="hs-identifier hs-var">replicateM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="GHC.Event.Manager.html#callbackArraySize"><span class="hs-identifier hs-var">callbackArraySize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntTable [FdData] -&gt; IO (MVar (IntTable [FdData]))
forall a. a -&gt; IO (MVar a)
</span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">(IntTable [FdData] -&gt; IO (MVar (IntTable [FdData])))
-&gt; IO (IntTable [FdData]) -&gt; IO (MVar (IntTable [FdData]))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IntTable [FdData])
forall a. Int -&gt; IO (IntTable a)
</span><a href="GHC.Event.IntTable.html#new"><span class="hs-identifier hs-var">IT.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span id="local-6989586621679525158"><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">ctrl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Control
</span><a href="GHC.Event.Control.html#newControl"><span class="hs-identifier hs-var">newControl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621679525156"><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525156"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State -&gt; IO (IORef State)
forall a. a -&gt; IO (IORef a)
</span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621679525155"><span class="annot"><span class="annottext">UniqueSource
</span><a href="#local-6989586621679525155"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UniqueSource
</span><a href="GHC.Event.Unique.html#newSource"><span class="hs-identifier hs-var">newSource</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="annottext">Weak (IORef State)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO () -&gt; IO (Weak (IORef State))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><a href="Data.IORef.html#mkWeakIORef"><span class="hs-identifier hs-var">mkWeakIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525156"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Weak (IORef State)))
-&gt; IO () -&gt; IO (Weak (IORef State))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>               </span><span id="local-6989586621679525154"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525154"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525156"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, State)) -&gt; IO State)
-&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525153"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525153"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525153"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>               </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525154"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; State -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>                 </span><span class="annot"><span class="annottext">Backend -&gt; IO ()
</span><a href="GHC.Event.Internal.html#delete"><span class="hs-identifier hs-var">I.delete</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525162"><span class="hs-identifier hs-var">be</span></a></span><span>
</span><span id="line-198"></span><span>                 </span><span class="annot"><span class="annottext">Control -&gt; IO ()
</span><a href="GHC.Event.Control.html#closeControl"><span class="hs-identifier hs-var">closeControl</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">ctrl</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span id="local-6989586621679525148"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679525148"><span class="hs-identifier hs-var">lockVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO (MVar ())
forall a. a -&gt; IO (MVar a)
</span><a href="GHC.MVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525147"><span class="annot"><span class="annottext">mgr :: EventManager
</span><a href="#local-6989586621679525147"><span class="hs-identifier hs-var hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventManager :: Backend
-&gt; Array Int (MVar (IntTable [FdData]))
-&gt; IORef State
-&gt; UniqueSource
-&gt; Control
-&gt; MVar ()
-&gt; EventManager
</span><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">emBackend :: Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525162"><span class="hs-identifier hs-var">be</span></a></span><span>
</span><span id="line-201"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">emFds :: Array Int (MVar (IntTable [FdData]))
</span><a href="GHC.Event.Manager.html#emFds"><span class="hs-identifier hs-var">emFds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array Int (MVar (IntTable [FdData]))
</span><a href="#local-6989586621679525161"><span class="hs-identifier hs-var">iofds</span></a></span><span>
</span><span id="line-202"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">emState :: IORef State
</span><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier hs-var">emState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525156"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-203"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">emUniqueSource :: UniqueSource
</span><a href="GHC.Event.Manager.html#emUniqueSource"><span class="hs-identifier hs-var">emUniqueSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqueSource
</span><a href="#local-6989586621679525155"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-204"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">emControl :: Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var">emControl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">ctrl</span></a></span><span>
</span><span id="line-205"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">emLock :: MVar ()
</span><a href="GHC.Event.Manager.html#emLock"><span class="hs-identifier hs-var">emLock</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679525148"><span class="hs-identifier hs-var">lockVar</span></a></span><span>
</span><span id="line-206"></span><span>                         </span><span class="hs-special">}</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-var">registerControlFd</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525147"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Control -&gt; Fd
</span><a href="GHC.Event.Control.html#controlReadFd"><span class="hs-identifier hs-var hs-var">controlReadFd</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">ctrl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-var">registerControlFd</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525147"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Control -&gt; Fd
</span><a href="GHC.Event.Control.html#wakeupReadFd"><span class="hs-identifier hs-var">wakeupReadFd</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">ctrl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="GHC.Event.Internal.html#evtRead"><span class="hs-identifier hs-var">evtRead</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="annottext">EventManager -&gt; IO EventManager
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525147"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679525160"><span class="annot"><span class="annottext">replicateM :: Int -&gt; m a -&gt; m [a]
</span><a href="#local-6989586621679525160"><span class="hs-identifier hs-var hs-var">replicateM</span></a></span></span><span> </span><span id="local-6989586621679525143"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525143"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679525142"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679525142"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[m a] -&gt; m [a]
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><a href="GHC.Base.html#sequence"><span class="hs-identifier hs-var">sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; m a -&gt; [m a]
forall a. Int -&gt; a -&gt; [a]
</span><a href="GHC.List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525143"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679525142"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-type">failOnInvalidFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span id="failOnInvalidFile"><span class="annot"><span class="annottext">failOnInvalidFile :: String -&gt; Fd -&gt; IO Bool -&gt; IO ()
</span><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-var hs-var">failOnInvalidFile</span></a></span></span><span> </span><span id="local-6989586621679525139"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679525139"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621679525138"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525138"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525137"><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679525137"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621679525136"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525136"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679525137"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#not/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525136"><span class="hs-identifier hs-var">ok</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525134"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679525134"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Failed while attempting to modify registration of file &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-218"></span><span>              </span><span class="annot"><span class="annottext">Fd -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525138"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; at location &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679525139"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679525134"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-type">registerControlFd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span id="registerControlFd"><span class="annot"><span class="annottext">registerControlFd :: EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#registerControlFd"><span class="hs-identifier hs-var hs-var">registerControlFd</span></a></span></span><span> </span><span id="local-6989586621679525131"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525131"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525130"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525130"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525129"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525129"><span class="hs-identifier hs-var">evs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Fd -&gt; IO Bool -&gt; IO ()
</span><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-var">failOnInvalidFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;registerControlFd&quot;</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525130"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525131"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525130"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525129"><span class="hs-identifier hs-var">evs</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | Asynchronously shuts down the event manager, if running.</span><span>
</span><span id="line-227"></span><span class="annot"><a href="GHC.Event.Manager.html#shutdown"><span class="hs-identifier hs-type">shutdown</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span id="shutdown"><span class="annot"><span class="annottext">shutdown :: EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#shutdown"><span class="hs-identifier hs-var hs-var">shutdown</span></a></span></span><span> </span><span id="local-6989586621679525127"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525127"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621679525126"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525126"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; IORef State
</span><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier hs-var hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525127"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, State)) -&gt; IO State)
-&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525125"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525125"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier hs-var">Dying</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525125"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525126"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; State -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Control -&gt; IO ()
</span><a href="GHC.Event.Control.html#sendDie"><span class="hs-identifier hs-var">sendDie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var hs-var">emControl</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525127"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- | Asynchronously tell the thread executing the event</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- manager loop to exit.</span><span>
</span><span id="line-234"></span><span class="annot"><a href="GHC.Event.Manager.html#release"><span class="hs-identifier hs-type">release</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span id="release"><span class="annot"><span class="annottext">release :: EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#release"><span class="hs-identifier hs-var hs-var">release</span></a></span></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525118"><span id="local-6989586621679525119"><span id="local-6989586621679525120"><span id="local-6989586621679525121"><span id="local-6989586621679525122"><span id="local-6989586621679525123"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525118"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621679525117"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525117"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525121"><span class="hs-identifier hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, State)) -&gt; IO State)
-&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525116"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525116"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525116"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525117"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; State -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Control -&gt; IO ()
</span><a href="GHC.Event.Control.html#sendWakeup"><span class="hs-identifier hs-var">sendWakeup</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525119"><span class="hs-identifier hs-var">emControl</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="GHC.Event.Manager.html#finished"><span class="hs-identifier hs-type">finished</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-240"></span><span id="finished"><span class="annot"><span class="annottext">finished :: EventManager -&gt; IO Bool
</span><a href="GHC.Event.Manager.html#finished"><span class="hs-identifier hs-var hs-var">finished</span></a></span></span><span> </span><span id="local-6989586621679525114"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525114"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State -&gt; State -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; Bool) -&gt; IO State -&gt; IO Bool
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><a href="GHC.Base.html#liftM"><span class="hs-operator hs-var">`liftM`</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO State
forall a. IORef a -&gt; IO a
</span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; IORef State
</span><a href="GHC.Event.Manager.html#emState"><span class="hs-identifier hs-var hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525114"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="annot"><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-type">cleanup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span id="cleanup"><span class="annot"><span class="annottext">cleanup :: EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525107"><span id="local-6989586621679525108"><span id="local-6989586621679525109"><span id="local-6989586621679525110"><span id="local-6989586621679525111"><span id="local-6989586621679525112"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525107"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">IORef State -&gt; State -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525110"><span class="hs-identifier hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO Bool
forall a. MVar a -&gt; a -&gt; IO Bool
</span><a href="GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679525107"><span class="hs-identifier hs-var">emLock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><span class="annottext">Backend -&gt; IO ()
</span><a href="GHC.Event.Internal.html#delete"><span class="hs-identifier hs-var">I.delete</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525112"><span class="hs-identifier hs-var">emBackend</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><span class="annottext">Control -&gt; IO ()
</span><a href="GHC.Event.Control.html#closeControl"><span class="hs-identifier hs-var">closeControl</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679525108"><span class="hs-identifier hs-var">emControl</span></a></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- Event loop</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | Start handling events.  This function loops until told to stop,</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- using 'shutdown'.</span><span>
</span><span id="line-254"></span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- /Note/: This loop can only be run once per 'EventManager', as it</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- closes all of its control resources when it finishes.</span><span>
</span><span id="line-257"></span><span class="annot"><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span id="loop"><span class="annot"><span class="annottext">loop :: EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#loop"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679525106"><span class="annot"><span class="annottext">mgr :: EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525100"><span id="local-6989586621679525101"><span id="local-6989586621679525102"><span id="local-6989586621679525103"><span id="local-6989586621679525104"><span id="local-6989586621679525105"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525100"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><a href="GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679525100"><span class="hs-identifier hs-var">emLock</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621679525099"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525099"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525103"><span class="hs-identifier hs-var">emState</span></a></span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, State)) -&gt; IO State)
-&gt; (State -&gt; (State, State)) -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525098"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="annottext">State
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525098"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525099"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Created"><span class="hs-identifier hs-var">Created</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679525097"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="Control.Exception.Base.html#onException"><span class="hs-operator hs-var">`onException`</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679525097"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="Control.Exception.Base.html#onException"><span class="hs-operator hs-var">`onException`</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Dying"><span class="hs-identifier hs-var">Dying</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- While a poll loop is never forked when the event manager is in the</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- 'Finished' state, its state could read 'Finished' once the new thread</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-comment">-- actually runs.  This is not an error, just an unfortunate race condition</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-comment">-- in Thread.restartPollLoop.  See #8235</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">State
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-274"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.Event.Manager.loop: state is already &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-275"></span><span>                            </span><span class="annot"><span class="annottext">State -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525099"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-276"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-277"></span><span>  </span><span id="local-6989586621679525097"><span class="annot"><span class="annottext">go :: IO ()
</span><a href="#local-6989586621679525097"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679525096"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525096"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO State
</span><a href="GHC.Event.Manager.html#step"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-278"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525096"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier hs-var">yield</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679525097"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-280"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="GHC.Event.Manager.html#Releasing"><span class="hs-identifier hs-var">Releasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679525100"><span class="hs-identifier hs-var">emLock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>            </span><span class="annot"><span class="annottext">State
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525106"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">-- | To make a step, we first do a non-blocking poll, in case</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- there are already events ready to handle. This improves performance</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- because we can make an unsafe foreign C call, thereby avoiding</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- forcing the current Task to release the Capability and forcing a context switch.</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- If the poll fails to find events, we yield, putting the poll loop thread at</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- end of the Haskell run queue. When it comes back around, we do one more</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- non-blocking poll, in case we get lucky and have ready events.</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- If that also returns no events, then we do a blocking poll.</span><span>
</span><span id="line-291"></span><span class="annot"><a href="GHC.Event.Manager.html#step"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#State"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-292"></span><span id="step"><span class="annot"><span class="annottext">step :: EventManager -&gt; IO State
</span><a href="GHC.Event.Manager.html#step"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679525095"><span class="annot"><span class="annottext">mgr :: EventManager
</span><a href="#local-6989586621679525095"><span class="hs-identifier hs-var">mgr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525089"><span id="local-6989586621679525090"><span id="local-6989586621679525091"><span id="local-6989586621679525092"><span id="local-6989586621679525093"><span id="local-6989586621679525094"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525089"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679525088"><span class="hs-identifier hs-var">waitForIO</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621679525087"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525087"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO State
forall a. IORef a -&gt; IO a
</span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679525092"><span class="hs-identifier hs-var">emState</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525087"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; IO State -&gt; IO State
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#seq/GHC.Prim.html#seq"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; IO State
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679525087"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621679525088"><span class="annot"><span class="annottext">waitForIO :: IO ()
</span><a href="#local-6989586621679525088"><span class="hs-identifier hs-var hs-var">waitForIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>      </span><span id="local-6989586621679525086"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525086"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Maybe Timeout -&gt; (Fd -&gt; Event -&gt; IO ()) -&gt; IO Int
</span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525094"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Timeout
forall a. Maybe a
</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525095"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525086"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C%3D/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="GHC.Conc.Sync.html#yield"><span class="hs-identifier hs-var">yield</span></a></span><span>
</span><span id="line-301"></span><span>        </span><span id="local-6989586621679525082"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525082"><span class="hs-identifier hs-var">n2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Maybe Timeout -&gt; (Fd -&gt; Event -&gt; IO ()) -&gt; IO Int
</span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525094"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Timeout
forall a. Maybe a
</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525095"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525082"><span class="hs-identifier hs-var">n2</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C%3D/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Maybe Timeout -&gt; (Fd -&gt; Event -&gt; IO ()) -&gt; IO Int
</span><a href="GHC.Event.Internal.html#poll"><span class="hs-identifier hs-var">I.poll</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525094"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Timeout -&gt; Maybe Timeout
forall a. a -&gt; Maybe a
</span><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Timeout
</span><a href="GHC.Event.Internal.html#Forever"><span class="hs-identifier hs-var">Forever</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var">onFdEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525095"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- Registering interest in I/O events</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-- | Register interest in the given events, without waking the event</span><span>
</span><span id="line-310"></span><span class="hs-comment">-- manager thread.  The 'Bool' return value indicates whether the</span><span>
</span><span id="line-311"></span><span class="hs-comment">-- event manager ought to be woken.</span><span>
</span><span id="line-312"></span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- Note that the event manager is generally implemented in terms of the</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- platform's @select@ or @epoll@ system call, which tend to vary in</span><span>
</span><span id="line-315"></span><span class="hs-comment">-- what sort of fds are permitted. For instance, waiting on regular files</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- is not allowed on many platforms.</span><span>
</span><span id="line-317"></span><span class="annot"><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-identifier hs-type">registerFd_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a></span><span>
</span><span id="line-318"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span id="registerFd_"><span class="annot"><span class="annottext">registerFd_ :: EventManager
-&gt; IOCallback -&gt; Fd -&gt; Event -&gt; Lifetime -&gt; IO (FdKey, Bool)
</span><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-identifier hs-var hs-var">registerFd_</span></a></span></span><span> </span><span id="local-6989586621679525079"><span class="annot"><span class="annottext">mgr :: EventManager
</span><a href="#local-6989586621679525079"><span class="hs-identifier hs-var">mgr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525073"><span id="local-6989586621679525074"><span id="local-6989586621679525075"><span id="local-6989586621679525076"><span id="local-6989586621679525077"><span id="local-6989586621679525078"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525073"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679525072"><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679525072"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span id="local-6989586621679525071"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525070"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525070"><span class="hs-identifier hs-var">evs</span></a></span></span><span> </span><span id="local-6989586621679525069"><span class="annot"><span class="annottext">Lifetime
</span><a href="#local-6989586621679525069"><span class="hs-identifier hs-var">lt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621679525068"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621679525068"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqueSource -&gt; IO Unique
</span><a href="GHC.Event.Unique.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a></span><span> </span><span class="annot"><span class="annottext">UniqueSource
</span><a href="#local-6989586621679525075"><span class="hs-identifier hs-var">emUniqueSource</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525067"><span class="annot"><span class="annottext">fd' :: Int
</span><a href="#local-6989586621679525067"><span class="hs-identifier hs-var hs-var">fd'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621679525066"><span class="annot"><span class="annottext">reg :: FdKey
</span><a href="#local-6989586621679525066"><span class="hs-identifier hs-var hs-var">reg</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Unique -&gt; FdKey
</span><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-var">FdKey</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621679525068"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621679525065"><span class="annot"><span class="annottext">el :: EventLifetime
</span><a href="#local-6989586621679525065"><span class="hs-identifier hs-var hs-var">el</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event -&gt; Lifetime -&gt; EventLifetime
</span><a href="GHC.Event.Internal.html#eventLifetime"><span class="hs-identifier hs-var">I.eventLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525070"><span class="hs-identifier hs-var">evs</span></a></span><span> </span><span class="annot"><span class="annottext">Lifetime
</span><a href="#local-6989586621679525069"><span class="hs-identifier hs-var">lt</span></a></span><span>
</span><span id="line-324"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621679525063"><span class="annot"><span class="annottext">fdd :: FdData
</span><a href="#local-6989586621679525063"><span class="hs-identifier hs-var hs-var">fdd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FdKey -&gt; EventLifetime -&gt; IOCallback -&gt; FdData
</span><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-var">FdData</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525066"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525065"><span class="hs-identifier hs-var">el</span></a></span><span> </span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679525072"><span class="hs-identifier hs-var">cb</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679525062"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525062"><span class="hs-identifier hs-var">modify</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679525061"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525061"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (IntTable [FdData])
-&gt; (IntTable [FdData] -&gt; IO (Bool, Bool)) -&gt; IO (Bool, Bool)
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; MVar (IntTable [FdData])
</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525079"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((IntTable [FdData] -&gt; IO (Bool, Bool)) -&gt; IO (Bool, Bool))
-&gt; (IntTable [FdData] -&gt; IO (Bool, Bool)) -&gt; IO (Bool, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525060"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525060"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679525059"><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525059"><span class="hs-identifier hs-var">oldFdd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([FdData] -&gt; [FdData] -&gt; [FdData])
-&gt; Int -&gt; [FdData] -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. (a -&gt; a -&gt; a) -&gt; Int -&gt; a -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#insertWith"><span class="hs-identifier hs-var">IT.insertWith</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; [FdData] -&gt; [FdData]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">(++)</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525067"><span class="hs-identifier hs-var">fd'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679525063"><span class="hs-identifier hs-var">fdd</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525060"><span class="hs-identifier hs-var">tbl</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679525057"><span class="hs-identifier hs-type">prevEvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span>
</span><span id="line-328"></span><span>        </span><span id="local-6989586621679525057"><span class="annot"><span class="annottext">prevEvs :: EventLifetime
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var hs-var">prevEvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime
-&gt; ([FdData] -&gt; EventLifetime) -&gt; Maybe [FdData] -&gt; EventLifetime
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525059"><span class="hs-identifier hs-var">oldFdd</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><a href="#local-6989586621679525055"><span class="hs-identifier hs-type">el'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span id="local-6989586621679525055"><span class="annot"><span class="annottext">el' :: EventLifetime
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var hs-var">el'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">prevEvs</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; EventLifetime -&gt; EventLifetime
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><a href="GHC.Base.html#mappend"><span class="hs-operator hs-var">`mappend`</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525065"><span class="hs-identifier hs-var">el</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var">el'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>      </span><span class="hs-comment">-- All registrations want one-shot semantics and this is supported</span><span>
</span><span id="line-334"></span><span>      </span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>        </span><span id="local-6989586621679525052"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525052"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525078"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var">el'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525052"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-337"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe [FdData] -&gt; IntTable [FdData] -&gt; IO ()
forall a. Int -&gt; Maybe a -&gt; IntTable a -&gt; IO ()
</span><a href="GHC.Event.IntTable.html#reset"><span class="hs-identifier hs-var">IT.reset</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525067"><span class="hs-identifier hs-var">fd'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525059"><span class="hs-identifier hs-var">oldFdd</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525060"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-comment">-- We don't want or don't support one-shot semantics</span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="annottext">Lifetime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525048"><span class="annot"><span class="annottext">modify :: Bool
</span><a href="#local-6989586621679525048"><span class="hs-identifier hs-var hs-var">modify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">prevEvs</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; EventLifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var">el'</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span id="local-6989586621679525047"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525047"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525048"><span class="hs-identifier hs-var">modify</span></a></span><span>
</span><span id="line-344"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525046"><span class="annot"><span class="annottext">newEvs :: Event
</span><a href="#local-6989586621679525046"><span class="hs-identifier hs-var hs-var">newEvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var">el'</span></a></span><span>
</span><span id="line-345"></span><span>                       </span><span id="local-6989586621679525045"><span class="annot"><span class="annottext">oldEvs :: Event
</span><a href="#local-6989586621679525045"><span class="hs-identifier hs-var hs-var">oldEvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">prevEvs</span></a></span><span>
</span><span id="line-346"></span><span>                   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525078"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525045"><span class="hs-identifier hs-var">oldEvs</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525046"><span class="hs-identifier hs-var">newEvs</span></a></span><span>
</span><span id="line-347"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525047"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525048"><span class="hs-identifier hs-var">modify</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe [FdData] -&gt; IntTable [FdData] -&gt; IO ()
forall a. Int -&gt; Maybe a -&gt; IntTable a -&gt; IO ()
</span><a href="GHC.Event.IntTable.html#reset"><span class="hs-identifier hs-var">IT.reset</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525067"><span class="hs-identifier hs-var">fd'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525059"><span class="hs-identifier hs-var">oldFdd</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525060"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, Bool) -&gt; IO (Bool, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-comment">-- this simulates behavior of old IO manager:</span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-comment">-- i.e. just call the callback if the registration fails.</span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#not/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525061"><span class="hs-identifier hs-var">ok</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679525072"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525066"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525070"><span class="hs-identifier hs-var">evs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><span class="annottext">(FdKey, Bool) -&gt; IO (FdKey, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525066"><span class="hs-identifier hs-var">reg</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525062"><span class="hs-identifier hs-var">modify</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-pragma hs-type">registerFd_</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">-- | @registerFd mgr cb fd evs lt@ registers interest in the events @evs@</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- on the file descriptor @fd@ for lifetime @lt@. @cb@ is called for</span><span>
</span><span id="line-359"></span><span class="hs-comment">-- each event that occurs.  Returns a cookie that can be handed to</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- 'unregisterFd'.</span><span>
</span><span id="line-361"></span><span class="annot"><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-type">registerFd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#IOCallback"><span class="hs-identifier hs-type">IOCallback</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Lifetime"><span class="hs-identifier hs-type">Lifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span>
</span><span id="line-362"></span><span id="registerFd"><span class="annot"><span class="annottext">registerFd :: EventManager -&gt; IOCallback -&gt; Fd -&gt; Event -&gt; Lifetime -&gt; IO FdKey
</span><a href="GHC.Event.Manager.html#registerFd"><span class="hs-identifier hs-var hs-var">registerFd</span></a></span></span><span> </span><span id="local-6989586621679525044"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525044"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525043"><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679525043"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span id="local-6989586621679525042"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525042"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525041"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525041"><span class="hs-identifier hs-var">evs</span></a></span></span><span> </span><span id="local-6989586621679525040"><span class="annot"><span class="annottext">Lifetime
</span><a href="#local-6989586621679525040"><span class="hs-identifier hs-var">lt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679525039"><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525039"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525038"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525038"><span class="hs-identifier hs-var">wake</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EventManager
-&gt; IOCallback -&gt; Fd -&gt; Event -&gt; Lifetime -&gt; IO (FdKey, Bool)
</span><a href="GHC.Event.Manager.html#registerFd_"><span class="hs-identifier hs-var">registerFd_</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525044"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679525043"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525042"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679525041"><span class="hs-identifier hs-var">evs</span></a></span><span> </span><span class="annot"><span class="annottext">Lifetime
</span><a href="#local-6989586621679525040"><span class="hs-identifier hs-var">lt</span></a></span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525038"><span class="hs-identifier hs-var">wake</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525044"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-365"></span><span>  </span><span class="annot"><span class="annottext">FdKey -&gt; IO FdKey
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525039"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-366"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#registerFd"><span class="hs-pragma hs-type">registerFd</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-comment">{-
    Building GHC with parallel IO manager on Mac freezes when
    compiling the dph libraries in the phase 2. As workaround, we
    don't use oneshot and we wake up an IO manager on Mac every time
    when we register an event.

    For more information, please read:
        https://gitlab.haskell.org/ghc/ghc/issues/7651
-}</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- | Wake up the event manager.</span><span>
</span><span id="line-378"></span><span class="annot"><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-type">wakeManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#if defined(darwin_HOST_OS) || defined(ios_HOST_OS)
</span><span class="hs-identifier">wakeManager</span><span> </span><span class="hs-identifier">mgr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sendWakeup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><span class="hs-identifier">mgr</span><span class="hs-special">)</span><span class="hs-cpp">
#elif defined(HAVE_EPOLL) || defined(HAVE_KQUEUE)
</span><span id="wakeManager"><span class="annot"><span class="annottext">wakeManager :: EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var hs-var">wakeManager</span></a></span></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-identifier">wakeManager</span><span> </span><span class="hs-identifier">mgr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sendWakeup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">emControl</span><span> </span><span class="hs-identifier">mgr</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-387"></span><span class="annot"><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-type">eventsOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span>
</span><span id="line-388"></span><span id="eventsOf"><span class="annot"><span class="annottext">eventsOf :: [FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var hs-var">eventsOf</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679525037"><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679525037"><span class="hs-identifier hs-var">fdd</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FdData -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier hs-var hs-var">fdEvents</span></a></span><span> </span><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679525037"><span class="hs-identifier hs-var">fdd</span></a></span><span>
</span><span id="line-389"></span><span class="annot"><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span id="local-6989586621679525036"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525036"><span class="hs-identifier hs-var">fdds</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EventLifetime] -&gt; EventLifetime
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="annot"><span class="annottext">([EventLifetime] -&gt; EventLifetime)
-&gt; [EventLifetime] -&gt; EventLifetime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(FdData -&gt; EventLifetime) -&gt; [FdData] -&gt; [EventLifetime]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">FdData -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier hs-var hs-var">fdEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525036"><span class="hs-identifier hs-var">fdds</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span class="hs-comment">-- | Drop a previous file descriptor registration, without waking the</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- event manager thread.  The return value indicates whether the event</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- manager ought to be woken.</span><span>
</span><span id="line-394"></span><span class="annot"><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-type">unregisterFd_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-395"></span><span id="unregisterFd_"><span class="annot"><span class="annottext">unregisterFd_ :: EventManager -&gt; FdKey -&gt; IO Bool
</span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var hs-var">unregisterFd_</span></a></span></span><span> </span><span id="local-6989586621679525035"><span class="annot"><span class="annottext">mgr :: EventManager
</span><a href="#local-6989586621679525035"><span class="hs-identifier hs-var">mgr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span class="hs-special">{</span><span id="local-6989586621679525029"><span id="local-6989586621679525030"><span id="local-6989586621679525031"><span id="local-6989586621679525032"><span id="local-6989586621679525033"><span id="local-6989586621679525034"><span class="annot"><span class="annottext">MVar ()
UniqueSource
Array Int (MVar (IntTable [FdData]))
IORef State
Backend
Control
emLock :: MVar ()
emControl :: Control
emUniqueSource :: UniqueSource
emState :: IORef State
emFds :: Array Int (MVar (IntTable [FdData]))
emBackend :: Backend
emLock :: EventManager -&gt; MVar ()
emUniqueSource :: EventManager -&gt; UniqueSource
emState :: EventManager -&gt; IORef State
emFds :: EventManager -&gt; Array Int (MVar (IntTable [FdData]))
emBackend :: EventManager -&gt; Backend
emControl :: EventManager -&gt; Control
</span><a href="#local-6989586621679525029"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span> </span><span id="local-6989586621679525028"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679525027"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621679525027"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="annottext">MVar (IntTable [FdData])
-&gt; (IntTable [FdData] -&gt; IO Bool) -&gt; IO Bool
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; MVar (IntTable [FdData])
</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525035"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((IntTable [FdData] -&gt; IO Bool) -&gt; IO Bool)
-&gt; (IntTable [FdData] -&gt; IO Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525026"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525026"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525025"><span class="annot"><span class="annottext">dropReg :: [FdData] -&gt; Maybe [FdData]
</span><a href="#local-6989586621679525025"><span class="hs-identifier hs-var hs-var">dropReg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; Maybe [FdData]
forall a. [a] -&gt; Maybe [a]
</span><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier hs-var">nullToNothing</span></a></span><span> </span><span class="annot"><span class="annottext">([FdData] -&gt; Maybe [FdData])
-&gt; ([FdData] -&gt; [FdData]) -&gt; [FdData] -&gt; Maybe [FdData]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(FdData -&gt; Bool) -&gt; [FdData] -&gt; [FdData]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621679525027"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Bool) -&gt; (FdData -&gt; Unique) -&gt; FdData -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey -&gt; Unique
</span><a href="GHC.Event.Manager.html#keyUnique"><span class="hs-identifier hs-var hs-var">keyUnique</span></a></span><span> </span><span class="annot"><span class="annottext">(FdKey -&gt; Unique) -&gt; (FdData -&gt; FdKey) -&gt; FdData -&gt; Unique
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FdData -&gt; FdKey
</span><a href="GHC.Event.Manager.html#fdKey"><span class="hs-identifier hs-var hs-var">fdKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>        </span><span id="local-6989586621679525022"><span class="annot"><span class="annottext">fd' :: Int
</span><a href="#local-6989586621679525022"><span class="hs-identifier hs-var hs-var">fd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><a href="#local-6989586621679525021"><span class="hs-identifier hs-type">pairEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#EventLifetime"><span class="hs-identifier hs-type">EventLifetime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>        </span><span id="local-6989586621679525021"><span class="annot"><span class="annottext">pairEvents :: [FdData] -&gt; IO (EventLifetime, EventLifetime)
</span><a href="#local-6989586621679525021"><span class="hs-identifier hs-var hs-var">pairEvents</span></a></span></span><span> </span><span id="local-6989586621679525020"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525020"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>          </span><span id="local-6989586621679525019"><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525019"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EventLifetime
-&gt; ([FdData] -&gt; EventLifetime) -&gt; Maybe [FdData] -&gt; EventLifetime
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe [FdData] -&gt; EventLifetime)
-&gt; IO (Maybe [FdData]) -&gt; IO EventLifetime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="GHC.Base.html#fmap"><span class="hs-operator hs-var">`fmap`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. Int -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#lookup"><span class="hs-identifier hs-var">IT.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525022"><span class="hs-identifier hs-var">fd'</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525026"><span class="hs-identifier hs-var">tbl</span></a></span><span>
</span><span id="line-402"></span><span>          </span><span class="annot"><span class="annottext">(EventLifetime, EventLifetime) -&gt; IO (EventLifetime, EventLifetime)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525020"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525019"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679525017"><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525017"><span class="hs-identifier hs-var">oldEls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525016"><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([FdData] -&gt; Maybe [FdData])
-&gt; Int -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. (a -&gt; Maybe a) -&gt; Int -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#updateWith"><span class="hs-identifier hs-var">IT.updateWith</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; Maybe [FdData]
</span><a href="#local-6989586621679525025"><span class="hs-identifier hs-var">dropReg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525022"><span class="hs-identifier hs-var">fd'</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525026"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe [FdData])
-&gt; (Maybe [FdData] -&gt; IO (EventLifetime, EventLifetime))
-&gt; IO (EventLifetime, EventLifetime)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span>
</span><span id="line-404"></span><span>                        </span><span class="annot"><span class="annottext">IO (EventLifetime, EventLifetime)
-&gt; ([FdData] -&gt; IO (EventLifetime, EventLifetime))
-&gt; Maybe [FdData]
-&gt; IO (EventLifetime, EventLifetime)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EventLifetime, EventLifetime) -&gt; IO (EventLifetime, EventLifetime)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EventLifetime
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; IO (EventLifetime, EventLifetime)
</span><a href="#local-6989586621679525021"><span class="hs-identifier hs-var">pairEvents</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525014"><span class="annot"><span class="annottext">modify :: Bool
</span><a href="#local-6989586621679525014"><span class="hs-identifier hs-var hs-var">modify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525017"><span class="hs-identifier hs-var">oldEls</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; EventLifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525014"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Fd -&gt; IO Bool -&gt; IO ()
</span><a href="GHC.Event.Manager.html#failOnInvalidFile"><span class="hs-identifier hs-var">failOnInvalidFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unregisterFd_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-409"></span><span>          </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525034"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">Lifetime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-411"></span><span>          </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="annot"><span class="annottext">Backend
</span><a href="#local-6989586621679525034"><span class="hs-identifier hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525028"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525017"><span class="hs-identifier hs-var">oldEls</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">newEls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525014"><span class="hs-identifier hs-var">modify</span></a></span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="hs-comment">-- | Drop a previous file descriptor registration.</span><span>
</span><span id="line-415"></span><span class="annot"><a href="GHC.Event.Manager.html#unregisterFd"><span class="hs-identifier hs-type">unregisterFd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdKey"><span class="hs-identifier hs-type">FdKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span id="unregisterFd"><span class="annot"><span class="annottext">unregisterFd :: EventManager -&gt; FdKey -&gt; IO ()
</span><a href="GHC.Event.Manager.html#unregisterFd"><span class="hs-identifier hs-var hs-var">unregisterFd</span></a></span></span><span> </span><span id="local-6989586621679525013"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525013"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525012"><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525012"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621679525011"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525011"><span class="hs-identifier hs-var">wake</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; FdKey -&gt; IO Bool
</span><a href="GHC.Event.Manager.html#unregisterFd_"><span class="hs-identifier hs-var">unregisterFd_</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525013"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525012"><span class="hs-identifier hs-var">reg</span></a></span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679525011"><span class="hs-identifier hs-var">wake</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525013"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- | Close a file descriptor in a race-safe way.</span><span>
</span><span id="line-421"></span><span class="annot"><a href="GHC.Event.Manager.html#closeFd"><span class="hs-identifier hs-type">closeFd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span id="closeFd"><span class="annot"><span class="annottext">closeFd :: EventManager -&gt; (Fd -&gt; IO ()) -&gt; Fd -&gt; IO ()
</span><a href="GHC.Event.Manager.html#closeFd"><span class="hs-identifier hs-var hs-var">closeFd</span></a></span></span><span> </span><span id="local-6989586621679525010"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525010"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679525009"><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="#local-6989586621679525009"><span class="hs-identifier hs-var">close</span></a></span></span><span> </span><span id="local-6989586621679525008"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>  </span><span id="local-6989586621679525007"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525007"><span class="hs-identifier hs-var">fds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (IntTable [FdData])
-&gt; (IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData]
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; MVar (IntTable [FdData])
</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525010"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData])
-&gt; (IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525006"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525006"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621679525005"><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525005"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. Int -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679525006"><span class="hs-identifier hs-var">tbl</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679525005"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-426"></span><span>      </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="#local-6989586621679525009"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO [FdData] -&gt; IO [FdData]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; IO [FdData]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-427"></span><span>      </span><span class="annot"><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679525003"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525003"><span class="hs-identifier hs-var">fds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525002"><span class="annot"><span class="annottext">oldEls :: EventLifetime
</span><a href="#local-6989586621679525002"><span class="hs-identifier hs-var hs-var">oldEls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525003"><span class="hs-identifier hs-var">fds</span></a></span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525002"><span class="hs-identifier hs-var">oldEls</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525010"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525002"><span class="hs-identifier hs-var">oldEls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-431"></span><span>          </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679525010"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-432"></span><span>        </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="#local-6989586621679525009"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="annottext">[FdData] -&gt; IO [FdData]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525003"><span class="hs-identifier hs-var">fds</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span class="annot"><span class="annottext">[FdData] -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679525007"><span class="hs-identifier hs-var">fds</span></a></span><span> </span><span class="annot"><span class="annottext">((FdData -&gt; IO ()) -&gt; IO ()) -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span> </span><span id="local-6989586621679525001"><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525001"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621679525000"><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525000"><span class="hs-identifier hs-var">el</span></a></span></span><span> </span><span id="local-6989586621679524999"><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524999"><span class="hs-identifier hs-var">cb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524999"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679525001"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679525000"><span class="hs-identifier hs-var">el</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Event
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><a href="GHC.Base.html#mappend"><span class="hs-operator hs-var">`mappend`</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="hs-comment">-- | Close a file descriptor in a race-safe way.</span><span>
</span><span id="line-437"></span><span class="hs-comment">-- It assumes the caller will update the callback tables and that the caller</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- holds the callback table lock for the fd. It must hold this lock because</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- this command executes a backend command on the fd.</span><span>
</span><span id="line-440"></span><span class="annot"><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier hs-type">closeFd_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span>
</span><span id="line-441"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-442"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span>
</span><span id="line-443"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span id="closeFd_"><span class="annot"><span class="annottext">closeFd_ :: EventManager -&gt; IntTable [FdData] -&gt; Fd -&gt; IO (IO ())
</span><a href="GHC.Event.Manager.html#closeFd_"><span class="hs-identifier hs-var hs-var">closeFd_</span></a></span></span><span> </span><span id="local-6989586621679524998"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524998"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679524997"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524997"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span id="local-6989586621679524996"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524996"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>  </span><span id="local-6989586621679524995"><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679524995"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. Int -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524996"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524997"><span class="hs-identifier hs-var">tbl</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="#local-6989586621679524995"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679524994"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524994"><span class="hs-identifier hs-var">fds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524993"><span class="annot"><span class="annottext">oldEls :: EventLifetime
</span><a href="#local-6989586621679524993"><span class="hs-identifier hs-var hs-var">oldEls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524994"><span class="hs-identifier hs-var">fds</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524993"><span class="hs-identifier hs-var">oldEls</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; EventLifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%2F%3D/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524998"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524996"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524993"><span class="hs-identifier hs-var">oldEls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="annottext">EventManager -&gt; IO ()
</span><a href="GHC.Event.Manager.html#wakeManager"><span class="hs-identifier hs-var">wakeManager</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524998"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; IO (IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (IO ())) -&gt; IO () -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">[FdData] -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524994"><span class="hs-identifier hs-var">fds</span></a></span><span> </span><span class="annot"><span class="annottext">((FdData -&gt; IO ()) -&gt; IO ()) -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span> </span><span id="local-6989586621679524992"><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679524992"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span id="local-6989586621679524991"><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524991"><span class="hs-identifier hs-var">el</span></a></span></span><span> </span><span id="local-6989586621679524990"><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524990"><span class="hs-identifier hs-var">cb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-455"></span><span>          </span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524990"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679524992"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524991"><span class="hs-identifier hs-var">el</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Event
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><a href="GHC.Base.html#mappend"><span class="hs-operator hs-var">`mappend`</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="GHC.Event.Internal.html#evtClose"><span class="hs-identifier hs-var">evtClose</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">-- | Call the callbacks corresponding to the given file descriptor.</span><span>
</span><span id="line-461"></span><span class="annot"><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-type">onFdEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#EventManager"><span class="hs-identifier hs-type">EventManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Posix.Types.html#Fd"><span class="hs-identifier hs-type">Fd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Event.Internal.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span id="onFdEvent"><span class="annot"><span class="annottext">onFdEvent :: EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#onFdEvent"><span class="hs-identifier hs-var hs-var">onFdEvent</span></a></span></span><span> </span><span id="local-6989586621679524989"><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span id="local-6989586621679524988"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679524987"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">evs</span></a></span></span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Fd -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Control -&gt; Fd
</span><a href="GHC.Event.Control.html#controlReadFd"><span class="hs-identifier hs-var hs-var">controlReadFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var hs-var">emControl</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%7C%7C/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Fd -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Control -&gt; Fd
</span><a href="GHC.Event.Control.html#wakeupReadFd"><span class="hs-identifier hs-var">wakeupReadFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Control
</span><a href="GHC.Event.Manager.html#emControl"><span class="hs-identifier hs-var hs-var">emControl</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; Event -&gt; IO ()
</span><a href="GHC.Event.Manager.html#handleControlEvent"><span class="hs-identifier hs-var">handleControlEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">evs</span></a></span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621679524985"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524985"><span class="hs-identifier hs-var">fdds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (IntTable [FdData])
-&gt; (IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData]
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><a href="Control.Concurrent.MVar.html#withMVar"><span class="hs-identifier hs-var">withMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Fd -&gt; MVar (IntTable [FdData])
</span><a href="GHC.Event.Manager.html#callbackTableVar"><span class="hs-identifier hs-var">callbackTableVar</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData])
-&gt; (IntTable [FdData] -&gt; IO [FdData]) -&gt; IO [FdData]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679524984"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-468"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. Int -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#delete"><span class="hs-identifier hs-var">IT.delete</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe [FdData])
-&gt; (Maybe [FdData] -&gt; IO [FdData]) -&gt; IO [FdData]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IO [FdData]
-&gt; ([FdData] -&gt; IO [FdData]) -&gt; Maybe [FdData] -&gt; IO [FdData]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FdData] -&gt; IO [FdData]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntTable [FdData] -&gt; [FdData] -&gt; IO [FdData]
</span><a href="#local-6989586621679524983"><span class="hs-identifier hs-var">selectCallbacks</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><span class="annottext">[FdData] -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524985"><span class="hs-identifier hs-var">fdds</span></a></span><span> </span><span class="annot"><span class="annottext">((FdData -&gt; IO ()) -&gt; IO ()) -&gt; (FdData -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span> </span><span id="local-6989586621679524982"><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679524982"><span class="hs-identifier hs-var">reg</span></a></span></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679524981"><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524981"><span class="hs-identifier hs-var">cb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOCallback
</span><a href="#local-6989586621679524981"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">FdKey
</span><a href="#local-6989586621679524982"><span class="hs-identifier hs-var">reg</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">evs</span></a></span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-comment">-- | Here we look through the list of registrations for the fd of interest</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-comment">-- and sort out which match the events that were triggered. We,</span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-comment">--   1. re-arm the fd as appropriate</span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-comment">--   2. reinsert registrations that weren't triggered and multishot</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-comment">--      registrations</span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-comment">--   3. return a list containing the callbacks that should be invoked.</span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><a href="#local-6989586621679524983"><span class="hs-identifier hs-type">selectCallbacks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.IntTable.html#IntTable"><span class="hs-identifier hs-type">IntTable</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621679524983"><span class="annot"><span class="annottext">selectCallbacks :: IntTable [FdData] -&gt; [FdData] -&gt; IO [FdData]
</span><a href="#local-6989586621679524983"><span class="hs-identifier hs-var hs-var">selectCallbacks</span></a></span></span><span> </span><span id="local-6989586621679524980"><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524980"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span id="local-6989586621679524979"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524979"><span class="hs-identifier hs-var">fdds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- figure out which registrations have been triggered</span><span>
</span><span id="line-481"></span><span>            </span><span class="annot"><a href="#local-6989586621679524978"><span class="hs-identifier hs-type">matches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-482"></span><span>            </span><span id="local-6989586621679524978"><span class="annot"><span class="annottext">matches :: FdData -&gt; Bool
</span><a href="#local-6989586621679524978"><span class="hs-identifier hs-var hs-var">matches</span></a></span></span><span> </span><span id="local-6989586621679524977"><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679524977"><span class="hs-identifier hs-var">fd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">evs</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Bool
</span><a href="GHC.Event.Internal.html#eventIs"><span class="hs-operator hs-var">`I.eventIs`</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FdData -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier hs-var hs-var">fdEvents</span></a></span><span> </span><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679524977"><span class="hs-identifier hs-var">fd'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679524975"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524975"><span class="hs-identifier hs-var">triggered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524974"><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524974"><span class="hs-identifier hs-var">notTriggered</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FdData -&gt; Bool) -&gt; [FdData] -&gt; ([FdData], [FdData])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a></span><span> </span><span class="annot"><span class="annottext">FdData -&gt; Bool
</span><a href="#local-6989586621679524978"><span class="hs-identifier hs-var">matches</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524979"><span class="hs-identifier hs-var">fdds</span></a></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>            </span><span class="hs-comment">-- sort out which registrations we need to retain</span><span>
</span><span id="line-486"></span><span>            </span><span class="annot"><a href="#local-6989586621679524973"><span class="hs-identifier hs-type">isMultishot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Event.Manager.html#FdData"><span class="hs-identifier hs-type">FdData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-487"></span><span>            </span><span id="local-6989586621679524973"><span class="annot"><span class="annottext">isMultishot :: FdData -&gt; Bool
</span><a href="#local-6989586621679524973"><span class="hs-identifier hs-var hs-var">isMultishot</span></a></span></span><span> </span><span id="local-6989586621679524972"><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679524972"><span class="hs-identifier hs-var">fd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FdData -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#fdEvents"><span class="hs-identifier hs-var hs-var">fdEvents</span></a></span><span> </span><span class="annot"><span class="annottext">FdData
</span><a href="#local-6989586621679524972"><span class="hs-identifier hs-var">fd'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lifetime -&gt; Lifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#MultiShot"><span class="hs-identifier hs-var">MultiShot</span></a></span><span>
</span><span id="line-488"></span><span>            </span><span id="local-6989586621679524970"><span class="annot"><span class="annottext">saved :: [FdData]
</span><a href="#local-6989586621679524970"><span class="hs-identifier hs-var hs-var">saved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524974"><span class="hs-identifier hs-var">notTriggered</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; [FdData] -&gt; [FdData]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">(FdData -&gt; Bool) -&gt; [FdData] -&gt; [FdData]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">FdData -&gt; Bool
</span><a href="#local-6989586621679524973"><span class="hs-identifier hs-var">isMultishot</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524975"><span class="hs-identifier hs-var">triggered</span></a></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span>            </span><span id="local-6989586621679524969"><span class="annot"><span class="annottext">savedEls :: EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var hs-var">savedEls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524970"><span class="hs-identifier hs-var">saved</span></a></span><span>
</span><span id="line-491"></span><span>            </span><span id="local-6989586621679524968"><span class="annot"><span class="annottext">allEls :: EventLifetime
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var hs-var">allEls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FdData] -&gt; EventLifetime
</span><a href="GHC.Event.Manager.html#eventsOf"><span class="hs-identifier hs-var">eventsOf</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524979"><span class="hs-identifier hs-var">fdds</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-comment">-- Reinsert multishot registrations.</span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-comment">-- We deleted the table entry for this fd above so we there isn't a preexisting entry</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">Maybe [FdData]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([FdData] -&gt; [FdData] -&gt; [FdData])
-&gt; Int -&gt; [FdData] -&gt; IntTable [FdData] -&gt; IO (Maybe [FdData])
forall a. (a -&gt; a -&gt; a) -&gt; Int -&gt; a -&gt; IntTable a -&gt; IO (Maybe a)
</span><a href="GHC.Event.IntTable.html#insertWith"><span class="hs-identifier hs-var">IT.insertWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[FdData]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524970"><span class="hs-identifier hs-var">saved</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fd -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524970"><span class="hs-identifier hs-var">saved</span></a></span><span> </span><span class="annot"><span class="annottext">IntTable [FdData]
</span><a href="#local-6989586621679524980"><span class="hs-identifier hs-var">tbl</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var">allEls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-498"></span><span>          </span><span class="hs-comment">-- we previously armed the fd for multiple shots, no need to rearm</span><span>
</span><span id="line-499"></span><span>          </span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#MultiShot"><span class="hs-identifier hs-var">MultiShot</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var">allEls</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; EventLifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var">savedEls</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-500"></span><span>            </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span>          </span><span class="hs-comment">-- either we previously registered for one shot or the</span><span>
</span><span id="line-503"></span><span>          </span><span class="hs-comment">-- events of interest have changed, we must re-arm</span><span>
</span><span id="line-504"></span><span>          </span><span class="annot"><span class="annottext">Lifetime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-505"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var">savedEls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-506"></span><span>              </span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Event.Manager.html#haveOneShot"><span class="hs-identifier hs-var">haveOneShot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-507"></span><span>                </span><span class="hs-comment">-- if there are no saved events and we registered with one-shot</span><span>
</span><span id="line-508"></span><span>                </span><span class="hs-comment">-- semantics then there is no need to re-arm</span><span>
</span><span id="line-509"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *). Monad m =&gt; Bool -&gt; m () -&gt; m ()
</span><a href="GHC.Event.Manager.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lifetime
</span><a href="GHC.Event.Internal.html#OneShot"><span class="hs-identifier hs-var">OneShot</span></a></span><span> </span><span class="annot"><span class="annottext">Lifetime -&gt; Lifetime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Lifetime
</span><a href="GHC.Event.Internal.html#elLifetime"><span class="hs-identifier hs-var">I.elLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var">allEls</span></a></span><span>
</span><span id="line-510"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%26%26/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Event
forall a. Monoid a =&gt; a
</span><a href="GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Event -&gt; Event -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var">savedEls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>                  </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFdOnce"><span class="hs-identifier hs-var">I.modifyFdOnce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var">savedEls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>              </span><span class="annot"><span class="annottext">Lifetime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-513"></span><span>                </span><span class="hs-comment">-- we need to re-arm with multi-shot semantics</span><span>
</span><span id="line-514"></span><span>                </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Backend -&gt; Fd -&gt; Event -&gt; Event -&gt; IO Bool
</span><a href="GHC.Event.Internal.html#modifyFd"><span class="hs-identifier hs-var">I.modifyFd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventManager -&gt; Backend
</span><a href="GHC.Event.Manager.html#emBackend"><span class="hs-identifier hs-var hs-var">emBackend</span></a></span><span> </span><span class="annot"><span class="annottext">EventManager
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">mgr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-515"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var">allEls</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventLifetime -&gt; Event
</span><a href="GHC.Event.Internal.html#elEvent"><span class="hs-identifier hs-var">I.elEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventLifetime
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var">savedEls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>        </span><span class="annot"><span class="annottext">[FdData] -&gt; IO [FdData]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[FdData]
</span><a href="#local-6989586621679524975"><span class="hs-identifier hs-var">triggered</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span id="local-6989586621679525277"><span class="annot"><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier hs-type">nullToNothing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679525277"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679525277"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-520"></span><span id="nullToNothing"><span class="annot"><span class="annottext">nullToNothing :: [a] -&gt; Maybe [a]
</span><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier hs-var hs-var">nullToNothing</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [a]
forall a. Maybe a
</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-521"></span><span class="annot"><a href="GHC.Event.Manager.html#nullToNothing"><span class="hs-identifier hs-var">nullToNothing</span></a></span><span> </span><span id="local-6989586621679524965"><span class="annot"><span class="annottext">xs :: [a]
</span><a href="#local-6989586621679524965"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#%3A/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Maybe [a]
forall a. a -&gt; Maybe a
</span><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679524965"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span id="local-6989586621679525263"><span class="annot"><a href="GHC.Event.Manager.html#unless"><span class="hs-identifier hs-type">unless</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525263"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525263"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525263"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-524"></span><span id="unless"><span class="annot"><span class="annottext">unless :: Bool -&gt; m () -&gt; m ()
</span><a href="GHC.Event.Manager.html#unless"><span class="hs-identifier hs-var hs-var">unless</span></a></span></span><span> </span><span id="local-6989586621679524964"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679524964"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#not/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679524964"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span></pre></body></html>