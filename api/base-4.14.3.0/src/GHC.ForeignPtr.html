<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Unsafe #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude
           , BangPatterns
           , MagicHash
           , UnboxedTuples
  #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# OPTIONS_HADDOCK not-home #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Module      :  GHC.ForeignPtr</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow, 1992-2003</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- Maintainer  :  cvs-ghc@haskell.org</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- Stability   :  internal</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- Portability :  non-portable (GHC extensions)</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- GHC's implementation of the 'ForeignPtr' data type.</span><span>
</span><span id="line-21"></span><span class="hs-comment">--</span><span>
</span><span id="line-22"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.ForeignPtr</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">(</span><span>
</span><span id="line-26"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier">ForeignPtr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtrContents"><span class="hs-identifier">ForeignPtrContents</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier">Finalizers</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerPtr"><span class="hs-identifier">FinalizerPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerEnvPtr"><span class="hs-identifier">FinalizerEnvPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#newForeignPtr_"><span class="hs-identifier">newForeignPtr_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtr"><span class="hs-identifier">mallocForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtr"><span class="hs-identifier">mallocPlainForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier">mallocForeignPtrBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrBytes"><span class="hs-identifier">mallocPlainForeignPtrBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrAlignedBytes"><span class="hs-identifier">mallocForeignPtrAlignedBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrAlignedBytes"><span class="hs-identifier">mallocPlainForeignPtrAlignedBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrFinalizer"><span class="hs-identifier">addForeignPtrFinalizer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrFinalizerEnv"><span class="hs-identifier">addForeignPtrFinalizerEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#touchForeignPtr"><span class="hs-identifier">touchForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier">unsafeForeignPtrToPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#castForeignPtr"><span class="hs-identifier">castForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#plusForeignPtr"><span class="hs-identifier">plusForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#newConcForeignPtr"><span class="hs-identifier">newConcForeignPtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer"><span class="hs-identifier">addForeignPtrConcFinalizer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>        </span><span class="annot"><a href="GHC.ForeignPtr.html#finalizeForeignPtr"><span class="hs-identifier">finalizeForeignPtr</span></a></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Foreign.Storable.html"><span class="hs-identifier">Foreign.Storable</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Foldable.html#sequence_"><span class="hs-identifier">sequence_</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Show.html"><span class="hs-identifier">GHC.Show</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.IORef.html"><span class="hs-identifier">GHC.IORef</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.STRef.html"><span class="hs-identifier">GHC.STRef</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.STRef.html#STRef"><span class="hs-identifier">STRef</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Ptr.html"><span class="hs-identifier">GHC.Ptr</span></a></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier">Ptr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Ptr.html#FunPtr"><span class="hs-identifier">FunPtr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- |The type 'ForeignPtr' represents references to objects that are</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- maintained in a foreign language, i.e., that are not part of the</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- data structures usually managed by the Haskell storage manager.</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- The essential difference between 'ForeignPtr's and vanilla memory</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- references of type @Ptr a@ is that the former may be associated</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- with /finalizers/. A finalizer is a routine that is invoked when</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- the Haskell storage manager detects that - within the Haskell heap</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- and stack - there are no more references left that are pointing to</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- the 'ForeignPtr'.  Typically, the finalizer will, then, invoke</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- routines in the foreign language that free the resources bound by</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- the foreign object.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- The 'ForeignPtr' is parameterised in the same way as 'Ptr'.  The</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- type argument of 'ForeignPtr' should normally be an instance of</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- class 'Storable'.</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-keyword">data</span><span> </span><span id="ForeignPtr"><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span></span><span> </span><span id="local-6989586621679512622"><span class="annot"><a href="#local-6989586621679512622"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ForeignPtr"><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Addr%23/GHC.Prim.html#Addr%23"><span class="hs-identifier hs-type">Addr#</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtrContents"><span class="hs-identifier hs-type">ForeignPtrContents</span></a></span><span>
</span><span id="line-75"></span><span>        </span><span class="hs-comment">-- The Addr# in the ForeignPtr object is intentionally stored</span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-comment">-- separately from the finalizer. The primary aim of the</span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-comment">-- representation is to make withForeignPtr efficient; in fact,</span><span>
</span><span id="line-78"></span><span>        </span><span class="hs-comment">-- withForeignPtr should be just as efficient as unpacking a</span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-comment">-- Ptr, and multiple withForeignPtrs can share an unpacked</span><span>
</span><span id="line-80"></span><span>        </span><span class="hs-comment">-- ForeignPtr. As a secondary benefit, this representation</span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-comment">-- allows pointers to subregions within the same overall block</span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-comment">-- to share the same finalizer (see 'plusForeignPtr'). Note</span><span>
</span><span id="line-83"></span><span>        </span><span class="hs-comment">-- that touchForeignPtr only has to touch the ForeignPtrContents</span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-comment">-- object, because that ensures that whatever the finalizer is</span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-comment">-- attached to is kept alive.</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">data</span><span> </span><span id="Finalizers"><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-var">Finalizers</span></a></span></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoFinalizers"><span class="annot"><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CFinalizers"><span class="annot"><a href="GHC.ForeignPtr.html#CFinalizers"><span class="hs-identifier hs-var">CFinalizers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Weak%23/GHC.Prim.html#Weak%23"><span class="hs-identifier hs-type">Weak#</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="HaskellFinalizers"><span class="annot"><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-var">HaskellFinalizers</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-keyword">data</span><span> </span><span id="ForeignPtrContents"><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtrContents"><span class="hs-identifier hs-var">ForeignPtrContents</span></a></span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="PlainForeignPtr"><span class="annot"><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-var">PlainForeignPtr</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MallocPtr"><span class="annot"><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-var">MallocPtr</span></a></span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#MutableByteArray%23/GHC.Prim.html#MutableByteArray%23"><span class="hs-identifier hs-type">MutableByteArray#</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#RealWorld/GHC.Prim.html#RealWorld"><span class="hs-identifier hs-type">RealWorld</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PlainPtr"><span class="annot"><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-var">PlainPtr</span></a></span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#MutableByteArray%23/GHC.Prim.html#MutableByteArray%23"><span class="hs-identifier hs-type">MutableByteArray#</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#RealWorld/GHC.Prim.html#RealWorld"><span class="hs-identifier hs-type">RealWorld</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | @since 2.01</span><span>
</span><span id="line-98"></span><span id="local-6989586621679512551"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679512548"><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#Eq/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512551"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621679512546"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512546"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512545"><span class="annot"><span class="annottext">== :: ForeignPtr a -&gt; ForeignPtr a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span id="local-6989586621679512544"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512544"><span class="hs-identifier hs-var">q</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; Ptr a
forall a. ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512546"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Ptr a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3D%3D/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; Ptr a
forall a. ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512544"><span class="hs-identifier hs-var">q</span></a></span></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | @since 2.01</span><span>
</span><span id="line-102"></span><span id="local-6989586621679512543"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679512529"><span id="local-6989586621679512531"><span id="local-6989586621679512533"><span id="local-6989586621679512535"><span id="local-6989586621679512537"><span id="local-6989586621679512539"><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#Ord/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512543"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621679512527"><span class="annot"><span class="annottext">compare :: ForeignPtr a -&gt; ForeignPtr a -&gt; Ordering
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#compare/GHC.Classes.html#compare"><span class="hs-identifier hs-var hs-var hs-var hs-var">compare</span></a></span></span><span> </span><span id="local-6989586621679512525"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512525"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512524"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512524"><span class="hs-identifier hs-var">q</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Ptr a -&gt; Ptr a -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#compare/GHC.Classes.html#compare"><span class="hs-identifier hs-var">compare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignPtr a -&gt; Ptr a
forall a. ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512525"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignPtr a -&gt; Ptr a
forall a. ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512524"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | @since 2.01</span><span>
</span><span id="line-106"></span><span id="local-6989586621679512523"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679512518"><span id="local-6989586621679512520"><span class="annot"><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512523"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621679512516"><span class="annot"><span class="annottext">showsPrec :: Int -&gt; ForeignPtr a -&gt; ShowS
</span><a href="GHC.Show.html#showsPrec"><span class="hs-identifier hs-var hs-var hs-var hs-var">showsPrec</span></a></span></span><span> </span><span id="local-6989586621679512514"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512514"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512513"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512513"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ptr a -&gt; ShowS
forall a. Show a =&gt; Int -&gt; a -&gt; ShowS
</span><a href="GHC.Show.html#showsPrec"><span class="hs-identifier hs-var">showsPrec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512514"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignPtr a -&gt; Ptr a
forall a. ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512513"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-comment">-- |A finalizer is represented as a pointer to a foreign function that, at</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- finalisation time, gets as an argument a plain pointer variant of the</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- foreign pointer that the finalizer is associated with.</span><span>
</span><span id="line-113"></span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- Note that the foreign function /must/ use the @ccall@ calling convention.</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-keyword">type</span><span> </span><span id="FinalizerPtr"><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerPtr"><span class="hs-identifier hs-var">FinalizerPtr</span></a></span></span><span> </span><span id="local-6989586621679512512"><span class="annot"><a href="#local-6989586621679512512"><span class="hs-identifier hs-type">a</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Ptr.html#FunPtr"><span class="hs-identifier hs-type">FunPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512512"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">type</span><span> </span><span id="FinalizerEnvPtr"><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerEnvPtr"><span class="hs-identifier hs-var">FinalizerEnvPtr</span></a></span></span><span> </span><span id="local-6989586621679512511"><span class="annot"><a href="#local-6989586621679512511"><span class="hs-identifier hs-type">env</span></a></span></span><span> </span><span id="local-6989586621679512510"><span class="annot"><a href="#local-6989586621679512510"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Ptr.html#FunPtr"><span class="hs-identifier hs-type">FunPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512511"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512510"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span id="local-6989586621679512509"><span class="annot"><a href="GHC.ForeignPtr.html#newConcForeignPtr"><span class="hs-identifier hs-type">newConcForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512509"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512509"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-120"></span><span class="hs-comment">--</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- ^Turns a plain memory reference into a foreign object by</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- associating a finalizer - given by the monadic operation - with the</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- reference.  The storage manager will start the finalizer, in a</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- separate thread, some time after the last reference to the</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- @ForeignPtr@ is dropped.  There is no guarantee of promptness, and</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- in fact there is no guarantee that the finalizer will eventually</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- run at all.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- Note that references from a finalizer do not necessarily prevent</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- another object from being finalized.  If A's finalizer refers to B</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- (perhaps using 'touchForeignPtr', then the only guarantee is that</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- B's finalizer will never be started before A's.  If both A and B</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- are unreachable, then both finalizers will start together.  See</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- 'touchForeignPtr' for more on finalizer ordering.</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span id="newConcForeignPtr"><span class="annot"><span class="annottext">newConcForeignPtr :: Ptr a -&gt; IO () -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#newConcForeignPtr"><span class="hs-identifier hs-var hs-var">newConcForeignPtr</span></a></span></span><span> </span><span id="local-6989586621679512508"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679512508"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512507"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512507"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679512506"><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512506"><span class="hs-identifier hs-var">fObj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO (ForeignPtr a)
forall a. Ptr a -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#newForeignPtr_"><span class="hs-identifier hs-var">newForeignPtr_</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679512508"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-138"></span><span>       </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; IO () -&gt; IO ()
forall a. ForeignPtr a -&gt; IO () -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer"><span class="hs-identifier hs-var">addForeignPtrConcFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512506"><span class="hs-identifier hs-var">fObj</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512507"><span class="hs-identifier hs-var">finalizer</span></a></span><span>
</span><span id="line-139"></span><span>       </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; IO (ForeignPtr a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679512506"><span class="hs-identifier hs-var">fObj</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="local-6989586621679512505"><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtr"><span class="hs-identifier hs-type">mallocForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.Storable.html#Storable"><span class="hs-identifier hs-type">Storable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512505"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512505"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- ^ Allocate some memory and return a 'ForeignPtr' to it.  The memory</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- will be released automatically when the 'ForeignPtr' is discarded.</span><span>
</span><span id="line-144"></span><span class="hs-comment">--</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- 'mallocForeignPtr' is equivalent to</span><span>
</span><span id="line-146"></span><span class="hs-comment">--</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- &gt;    do { p &lt;- malloc; newForeignPtr finalizerFree p }</span><span>
</span><span id="line-148"></span><span class="hs-comment">--</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- although it may be implemented differently internally: you may not</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- assume that the memory returned by 'mallocForeignPtr' has been</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- allocated with 'Foreign.Marshal.Alloc.malloc'.</span><span>
</span><span id="line-152"></span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- GHC notes: 'mallocForeignPtr' has a heavily optimised</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- implementation in GHC.  It uses pinned memory in the garbage</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- collected heap, so the 'ForeignPtr' does not require a finalizer to</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- free the memory.  Use of 'mallocForeignPtr' and associated</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- functions is strongly recommended in preference to</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- 'Foreign.ForeignPtr.newForeignPtr' with a finalizer.</span><span>
</span><span id="line-159"></span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span id="mallocForeignPtr"><span class="annot"><span class="annottext">mallocForeignPtr :: IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocForeignPtr"><span class="hs-identifier hs-var hs-var">mallocForeignPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO (ForeignPtr a)
forall b. Storable b =&gt; b -&gt; IO (ForeignPtr b)
</span><a href="#local-6989586621679512504"><span class="hs-identifier hs-var">doMalloc</span></a></span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="GHC.Err.html#undefined"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679512639"><span class="annot"><a href="#local-6989586621679512504"><span class="hs-identifier hs-type">doMalloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.Storable.html#Storable"><span class="hs-identifier hs-type">Storable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512639"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679512639"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512639"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-162"></span><span>        </span><span id="local-6989586621679512504"><span class="annot"><span class="annottext">doMalloc :: b -&gt; IO (ForeignPtr b)
</span><a href="#local-6989586621679512504"><span class="hs-identifier hs-var hs-var">doMalloc</span></a></span></span><span> </span><span id="local-6989586621679512502"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512502"><span class="hs-identifier hs-var">a</span></a></span></span><span>
</span><span id="line-163"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int# -&gt; Int
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-var">I#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512501"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr b)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocForeignPtr: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-164"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>          </span><span id="local-6989586621679512498"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512498"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Finalizers -&gt; IO (IORef Finalizers)
forall a. a -&gt; IO (IORef a)
</span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
-&gt; IO (ForeignPtr b)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
 -&gt; IO (ForeignPtr b))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
-&gt; IO (ForeignPtr b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512496"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512496"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d.
Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newAlignedPinnedByteArray%23/GHC.Prim.html#newAlignedPinnedByteArray%23"><span class="hs-identifier hs-var">newAlignedPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512501"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512495"><span class="hs-identifier hs-var">align</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512496"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512494"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512494"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512493"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512493"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>             </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512494"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr b
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512493"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
-&gt; IORef Finalizers -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-var">MallocPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512493"><span class="hs-identifier hs-var">mbarr#</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512498"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-170"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>            </span><span class="hs-keyword">where</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512501"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512501"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><a href="Foreign.Storable.html#sizeOf"><span class="hs-identifier hs-var">sizeOf</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512502"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-172"></span><span>                  </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512495"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512495"><span class="hs-identifier hs-var">align</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><a href="Foreign.Storable.html#alignment"><span class="hs-identifier hs-var">alignment</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512502"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | This function is similar to 'mallocForeignPtr', except that the</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- size of the memory required is given explicitly as a number of bytes.</span><span>
</span><span id="line-176"></span><span id="local-6989586621679512490"><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-type">mallocForeignPtrBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512490"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-177"></span><span id="mallocForeignPtrBytes"><span class="annot"><span class="annottext">mallocForeignPtrBytes :: Int -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-var hs-var">mallocForeignPtrBytes</span></a></span></span><span> </span><span id="local-6989586621679512489"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512489"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512489"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr a)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocForeignPtrBytes: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-179"></span><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-var">mallocForeignPtrBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512488"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512488"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>  </span><span id="local-6989586621679512487"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512487"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Finalizers -&gt; IO (IORef Finalizers)
forall a. a -&gt; IO (IORef a)
</span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
 -&gt; IO (ForeignPtr a))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512486"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512486"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>     </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d. Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newPinnedByteArray%23/GHC.Prim.html#newPinnedByteArray%23"><span class="hs-identifier hs-var">newPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512488"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512486"><span class="hs-identifier hs-var">s</span></a></span><span>      </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512485"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512485"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512484"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512484"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>       </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512485"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512484"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
-&gt; IORef Finalizers -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-var">MallocPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512484"><span class="hs-identifier hs-var">mbarr#</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512487"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-185"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">-- | This function is similar to 'mallocForeignPtrBytes', except that the</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- size and alignment of the memory required is given explicitly as numbers of</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- bytes.</span><span>
</span><span id="line-190"></span><span id="local-6989586621679512483"><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrAlignedBytes"><span class="hs-identifier hs-type">mallocForeignPtrAlignedBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-191"></span><span id="mallocForeignPtrAlignedBytes"><span class="annot"><span class="annottext">mallocForeignPtrAlignedBytes :: Int -&gt; Int -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocForeignPtrAlignedBytes"><span class="hs-identifier hs-var hs-var">mallocForeignPtrAlignedBytes</span></a></span></span><span> </span><span id="local-6989586621679512482"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512482"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621679512481"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512481"><span class="hs-identifier hs-var">_align</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512482"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr a)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocForeignPtrAlignedBytes: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-193"></span><span class="annot"><a href="GHC.ForeignPtr.html#mallocForeignPtrAlignedBytes"><span class="hs-identifier hs-var">mallocForeignPtrAlignedBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512480"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512480"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512479"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512479"><span class="hs-identifier hs-var">align</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621679512478"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512478"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Finalizers -&gt; IO (IORef Finalizers)
forall a. a -&gt; IO (IORef a)
</span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
 -&gt; IO (ForeignPtr a))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512477"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512477"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>     </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d.
Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newAlignedPinnedByteArray%23/GHC.Prim.html#newAlignedPinnedByteArray%23"><span class="hs-identifier hs-var">newAlignedPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512480"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512479"><span class="hs-identifier hs-var">align</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512477"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512476"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512476"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512475"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512475"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>       </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512476"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512475"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
-&gt; IORef Finalizers -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-var">MallocPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512475"><span class="hs-identifier hs-var">mbarr#</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512478"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-199"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-- | Allocate some memory and return a 'ForeignPtr' to it.  The memory</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- will be released automatically when the 'ForeignPtr' is discarded.</span><span>
</span><span id="line-203"></span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- GHC notes: 'mallocPlainForeignPtr' has a heavily optimised</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- implementation in GHC.  It uses pinned memory in the garbage</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- collected heap, as for mallocForeignPtr. Unlike mallocForeignPtr, a</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- ForeignPtr created with mallocPlainForeignPtr carries no finalizers.</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- It is not possible to add a finalizer to a ForeignPtr created with</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- mallocPlainForeignPtr. This is useful for ForeignPtrs that will live</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- only inside Haskell (such as those created for packed strings).</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- Attempts to add a finalizer to a ForeignPtr created this way, or to</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- finalize such a pointer, will throw an exception.</span><span>
</span><span id="line-213"></span><span class="hs-comment">--</span><span>
</span><span id="line-214"></span><span id="local-6989586621679512474"><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtr"><span class="hs-identifier hs-type">mallocPlainForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.Storable.html#Storable"><span class="hs-identifier hs-type">Storable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512474"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512474"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-215"></span><span id="mallocPlainForeignPtr"><span class="annot"><span class="annottext">mallocPlainForeignPtr :: IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocPlainForeignPtr"><span class="hs-identifier hs-var hs-var">mallocPlainForeignPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO (ForeignPtr a)
forall b. Storable b =&gt; b -&gt; IO (ForeignPtr b)
</span><a href="#local-6989586621679512473"><span class="hs-identifier hs-var">doMalloc</span></a></span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="GHC.Err.html#undefined"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679512472"><span class="annot"><a href="#local-6989586621679512473"><span class="hs-identifier hs-type">doMalloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.Storable.html#Storable"><span class="hs-identifier hs-type">Storable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512472"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679512472"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512472"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-217"></span><span>        </span><span id="local-6989586621679512473"><span class="annot"><span class="annottext">doMalloc :: b -&gt; IO (ForeignPtr b)
</span><a href="#local-6989586621679512473"><span class="hs-identifier hs-var hs-var">doMalloc</span></a></span></span><span> </span><span id="local-6989586621679512471"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512471"><span class="hs-identifier hs-var">a</span></a></span></span><span>
</span><span id="line-218"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int# -&gt; Int
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-var">I#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512470"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr b)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocForeignPtr: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-219"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
-&gt; IO (ForeignPtr b)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
 -&gt; IO (ForeignPtr b))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr b #))
-&gt; IO (ForeignPtr b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512469"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512469"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d.
Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newAlignedPinnedByteArray%23/GHC.Prim.html#newAlignedPinnedByteArray%23"><span class="hs-identifier hs-var">newAlignedPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512470"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512468"><span class="hs-identifier hs-var">align</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512469"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512467"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512467"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512466"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512466"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>             </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512467"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr b
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512466"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-var">PlainPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512466"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-223"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-224"></span><span>            </span><span class="hs-keyword">where</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512470"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512470"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><a href="Foreign.Storable.html#sizeOf"><span class="hs-identifier hs-var">sizeOf</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512471"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-225"></span><span>                  </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512468"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512468"><span class="hs-identifier hs-var">align</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Int
forall a. Storable a =&gt; a -&gt; Int
</span><a href="Foreign.Storable.html#alignment"><span class="hs-identifier hs-var">alignment</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679512471"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- | This function is similar to 'mallocForeignPtrBytes', except that</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- the internally an optimised ForeignPtr representation with no</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- finalizer is used. Attempts to add a finalizer will cause an</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- exception to be thrown.</span><span>
</span><span id="line-231"></span><span id="local-6989586621679512465"><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrBytes"><span class="hs-identifier hs-type">mallocPlainForeignPtrBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512465"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-232"></span><span id="mallocPlainForeignPtrBytes"><span class="annot"><span class="annottext">mallocPlainForeignPtrBytes :: Int -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrBytes"><span class="hs-identifier hs-var hs-var">mallocPlainForeignPtrBytes</span></a></span></span><span> </span><span id="local-6989586621679512464"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512464"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512464"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr a)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocPlainForeignPtrBytes: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-234"></span><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrBytes"><span class="hs-identifier hs-var">mallocPlainForeignPtrBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512463"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512463"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
 -&gt; IO (ForeignPtr a))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512462"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512462"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d. Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newPinnedByteArray%23/GHC.Prim.html#newPinnedByteArray%23"><span class="hs-identifier hs-var">newPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512463"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512462"><span class="hs-identifier hs-var">s</span></a></span><span>      </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512461"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512461"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512460"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512460"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>       </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512461"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512460"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-var">PlainPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512460"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-238"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-comment">-- | This function is similar to 'mallocForeignPtrAlignedBytes', except that</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- the internally an optimised ForeignPtr representation with no</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- finalizer is used. Attempts to add a finalizer will cause an</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- exception to be thrown.</span><span>
</span><span id="line-244"></span><span id="local-6989586621679512459"><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrAlignedBytes"><span class="hs-identifier hs-type">mallocPlainForeignPtrAlignedBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512459"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-245"></span><span id="mallocPlainForeignPtrAlignedBytes"><span class="annot"><span class="annottext">mallocPlainForeignPtrAlignedBytes :: Int -&gt; Int -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrAlignedBytes"><span class="hs-identifier hs-var hs-var">mallocPlainForeignPtrAlignedBytes</span></a></span></span><span> </span><span id="local-6989586621679512458"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512458"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621679512457"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512457"><span class="hs-identifier hs-var">_align</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679512458"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Classes.html#%3C/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (ForeignPtr a)
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mallocPlainForeignPtrAlignedBytes: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-247"></span><span class="annot"><a href="GHC.ForeignPtr.html#mallocPlainForeignPtrAlignedBytes"><span class="hs-identifier hs-var">mallocPlainForeignPtrAlignedBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512456"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512456"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512455"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512455"><span class="hs-identifier hs-var">align</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
 -&gt; IO (ForeignPtr a))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, ForeignPtr a #))
-&gt; IO (ForeignPtr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512454"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512454"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int#
-&gt; Int#
-&gt; State# RealWorld
-&gt; (# State# RealWorld, MutableByteArray# RealWorld #)
forall d.
Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#newAlignedPinnedByteArray%23/GHC.Prim.html#newAlignedPinnedByteArray%23"><span class="hs-identifier hs-var">newAlignedPinnedByteArray#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512456"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512455"><span class="hs-identifier hs-var">align</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512454"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512453"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512453"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512452"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512452"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>       </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512453"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#byteArrayContents%23/GHC.Prim.html#byteArrayContents%23"><span class="hs-identifier hs-var">byteArrayContents#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ByteArray#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512452"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-var">PlainPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512452"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-251"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621679512451"><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrFinalizer"><span class="hs-identifier hs-type">addForeignPtrFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerPtr"><span class="hs-identifier hs-type">FinalizerPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512451"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512451"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- ^ This function adds a finalizer to the given foreign object.  The</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- finalizer will run /before/ all other finalizers for the same</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- object which have already been registered.</span><span>
</span><span id="line-257"></span><span id="addForeignPtrFinalizer"><span class="annot"><span class="annottext">addForeignPtrFinalizer :: FinalizerPtr a -&gt; ForeignPtr a -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrFinalizer"><span class="hs-identifier hs-var hs-var">addForeignPtrFinalizer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#FunPtr"><span class="hs-identifier hs-type">FunPtr</span></a></span><span> </span><span id="local-6989586621679512449"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512449"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span id="local-6989586621679512448"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512448"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512447"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512447"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512447"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-type">PlainForeignPtr</span></a></span><span> </span><span id="local-6989586621679512446"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512446"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; () -&gt; IO ()
forall value.
IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var">insertCFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512446"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512449"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">0#</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#nullAddr%23/GHC.Prim.html#nullAddr%23"><span class="hs-identifier hs-var">nullAddr#</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512448"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-type">MallocPtr</span></a></span><span>     </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512444"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512444"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; ForeignPtrContents -&gt; IO ()
forall value.
IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var">insertCFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512444"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512449"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">0#</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#nullAddr%23/GHC.Prim.html#nullAddr%23"><span class="hs-identifier hs-var">nullAddr#</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512448"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512447"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.ForeignPtr: attempt to add a finalizer to a plain pointer&quot;</span></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- Note [MallocPtr finalizers] (#10904)</span><span>
</span><span id="line-263"></span><span class="hs-comment">--</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- When we have C finalizers for a MallocPtr, the memory is</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- heap-resident and would normally be recovered by the GC before the</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- finalizers run.  To prevent the memory from being reused too early,</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- we attach the MallocPtr constructor to the &quot;value&quot; field of the</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- weak pointer when we call mkWeak# in ensureCFinalizerWeak below.</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- The GC will keep this field alive until the finalizers have run.</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span id="local-6989586621679512442"><span id="local-6989586621679512443"><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrFinalizerEnv"><span class="hs-identifier hs-type">addForeignPtrFinalizerEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#FinalizerEnvPtr"><span class="hs-identifier hs-type">FinalizerEnvPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512443"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512442"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512443"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512442"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- ^ Like 'addForeignPtrFinalizer' but the finalizer is passed an additional</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- environment parameter.</span><span>
</span><span id="line-275"></span><span id="addForeignPtrFinalizerEnv"><span class="annot"><span class="annottext">addForeignPtrFinalizerEnv :: FinalizerEnvPtr env a -&gt; Ptr env -&gt; ForeignPtr a -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrFinalizerEnv"><span class="hs-identifier hs-var hs-var">addForeignPtrFinalizerEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#FunPtr"><span class="hs-identifier hs-type">FunPtr</span></a></span><span> </span><span id="local-6989586621679512441"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512441"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span id="local-6989586621679512439"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512439"><span class="hs-identifier hs-var">ep</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span id="local-6989586621679512438"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512438"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512437"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512437"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512437"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-type">PlainForeignPtr</span></a></span><span> </span><span id="local-6989586621679512436"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512436"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; () -&gt; IO ()
forall value.
IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var">insertCFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512436"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512441"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">1#</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512439"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512438"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-type">MallocPtr</span></a></span><span>     </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512435"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512435"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; ForeignPtrContents -&gt; IO ()
forall value.
IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var">insertCFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512435"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512441"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">1#</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512439"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512438"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512437"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.ForeignPtr: attempt to add a finalizer to a plain pointer&quot;</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span id="local-6989586621679512643"><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer"><span class="hs-identifier hs-type">addForeignPtrConcFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512643"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- ^This function adds a finalizer to the given @ForeignPtr@.  The</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- finalizer will run /before/ all other finalizers for the same</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- object which have already been registered.</span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- This is a variant of @addForeignPtrFinalizer@, where the finalizer</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- is an arbitrary @IO@ action.  When it is invoked, the finalizer</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- will run in a new thread.</span><span>
</span><span id="line-288"></span><span class="hs-comment">--</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- NB. Be very careful with these finalizers.  One common trap is that</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- if a finalizer references another finalized value, it does not</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- prevent that value from being finalized.  In particular, 'System.IO.Handle's</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- are finalized objects, so a finalizer should not refer to a</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- 'System.IO.Handle' (including 'System.IO.stdout', 'System.IO.stdin', or</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- 'System.IO.stderr').</span><span>
</span><span id="line-295"></span><span class="hs-comment">--</span><span>
</span><span id="line-296"></span><span id="addForeignPtrConcFinalizer"><span class="annot"><span class="annottext">addForeignPtrConcFinalizer :: ForeignPtr a -&gt; IO () -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer"><span class="hs-identifier hs-var hs-var">addForeignPtrConcFinalizer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512434"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512434"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679512433"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512433"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="annottext">ForeignPtrContents -&gt; IO () -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer_"><span class="hs-identifier hs-var">addForeignPtrConcFinalizer_</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512434"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512433"><span class="hs-identifier hs-var">finalizer</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer_"><span class="hs-identifier hs-type">addForeignPtrConcFinalizer_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtrContents"><span class="hs-identifier hs-type">ForeignPtrContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span id="addForeignPtrConcFinalizer_"><span class="annot"><span class="annottext">addForeignPtrConcFinalizer_ :: ForeignPtrContents -&gt; IO () -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer_"><span class="hs-identifier hs-var hs-var">addForeignPtrConcFinalizer_</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-type">PlainForeignPtr</span></a></span><span> </span><span id="local-6989586621679512431"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512431"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679512430"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512430"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>  </span><span id="local-6989586621679512429"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512429"><span class="hs-identifier hs-var">noFinalizers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO () -&gt; IO Bool
</span><a href="GHC.ForeignPtr.html#insertHaskellFinalizer"><span class="hs-identifier hs-var">insertHaskellFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512431"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512430"><span class="hs-identifier hs-var">finalizer</span></a></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512429"><span class="hs-identifier hs-var">noFinalizers</span></a></span><span>
</span><span id="line-303"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ())
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512427"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512427"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512431"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.STRef.html#STRef"><span class="hs-identifier hs-type">STRef</span></a></span><span> </span><span id="local-6989586621679512424"><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
</span><a href="#local-6989586621679512424"><span class="hs-identifier hs-var">r#</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
-&gt; ()
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# () #)
forall k1 a b.
k1
-&gt; a
-&gt; (State# RealWorld -&gt; (# State# RealWorld, b #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# a #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#mkWeak%23/GHC.Prim.html#mkWeak%23"><span class="hs-identifier hs-var">mkWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
</span><a href="#local-6989586621679512424"><span class="hs-identifier hs-var">r#</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; State# RealWorld -&gt; (# State# RealWorld, () #)
forall a. IO a -&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
</span><a href="GHC.Base.html#unIO"><span class="hs-identifier hs-var">unIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; State# RealWorld -&gt; (# State# RealWorld, () #))
-&gt; IO () -&gt; State# RealWorld -&gt; (# State# RealWorld, () #)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#foreignPtrFinalizer"><span class="hs-identifier hs-var">foreignPtrFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512431"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512427"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-306"></span><span>                </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512421"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512421"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512421"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-307"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer_"><span class="hs-identifier hs-var">addForeignPtrConcFinalizer_</span></a></span><span> </span><span id="local-6989586621679512420"><span class="annot"><span class="annottext">f :: ForeignPtrContents
</span><a href="#local-6989586621679512420"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-type">MallocPtr</span></a></span><span> </span><span id="local-6989586621679512419"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512419"><span class="hs-identifier hs-var">fo</span></a></span></span><span> </span><span id="local-6989586621679512418"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512418"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679512417"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512417"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>  </span><span id="local-6989586621679512416"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512416"><span class="hs-identifier hs-var">noFinalizers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO () -&gt; IO Bool
</span><a href="GHC.ForeignPtr.html#insertHaskellFinalizer"><span class="hs-identifier hs-var">insertHaskellFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512418"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512417"><span class="hs-identifier hs-var">finalizer</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512416"><span class="hs-identifier hs-var">noFinalizers</span></a></span><span>
</span><span id="line-311"></span><span>     </span><span class="hs-keyword">then</span><span>  </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ())
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512415"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512415"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
-&gt; ()
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# () #)
forall k1 a b.
k1
-&gt; a
-&gt; (State# RealWorld -&gt; (# State# RealWorld, b #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# a #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#mkWeak%23/GHC.Prim.html#mkWeak%23"><span class="hs-identifier hs-var">mkWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679512419"><span class="hs-identifier hs-var">fo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679512414"><span class="hs-identifier hs-var">finalizer'</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512415"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-313"></span><span>                  </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512413"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512413"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512413"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-314"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="#local-6989586621679512414"><span class="hs-identifier hs-type">finalizer'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#State%23/GHC.Prim.html#State%23"><span class="hs-identifier hs-type">State#</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#RealWorld/GHC.Prim.html#RealWorld"><span class="hs-identifier hs-type">RealWorld</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#State%23/GHC.Prim.html#State%23"><span class="hs-identifier hs-type">State#</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#RealWorld/GHC.Prim.html#RealWorld"><span class="hs-identifier hs-type">RealWorld</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621679512414"><span class="annot"><span class="annottext">finalizer' :: State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679512414"><span class="hs-identifier hs-var hs-var">finalizer'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; State# RealWorld -&gt; (# State# RealWorld, () #)
forall a. IO a -&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
</span><a href="GHC.Base.html#unIO"><span class="hs-identifier hs-var">unIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#foreignPtrFinalizer"><span class="hs-identifier hs-var">foreignPtrFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512418"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512420"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="annot"><a href="GHC.ForeignPtr.html#addForeignPtrConcFinalizer_"><span class="hs-identifier hs-var">addForeignPtrConcFinalizer_</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.ForeignPtr: attempt to add a finalizer to plain pointer&quot;</span></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="annot"><a href="GHC.ForeignPtr.html#insertHaskellFinalizer"><span class="hs-identifier hs-type">insertHaskellFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Bool/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-323"></span><span id="insertHaskellFinalizer"><span class="annot"><span class="annottext">insertHaskellFinalizer :: IORef Finalizers -&gt; IO () -&gt; IO Bool
</span><a href="GHC.ForeignPtr.html#insertHaskellFinalizer"><span class="hs-identifier hs-var hs-var">insertHaskellFinalizer</span></a></span></span><span> </span><span id="local-6989586621679512411"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512411"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679512410"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512410"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-glyph">!</span><span id="local-6989586621679512409"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512409"><span class="hs-identifier hs-var">wasEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; (Finalizers -&gt; (Finalizers, Bool)) -&gt; IO Bool
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="GHC.IORef.html#atomicModifyIORefP"><span class="hs-identifier hs-var">atomicModifyIORefP</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512411"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">((Finalizers -&gt; (Finalizers, Bool)) -&gt; IO Bool)
-&gt; (Finalizers -&gt; (Finalizers, Bool)) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512407"><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512407"><span class="hs-identifier hs-var">finalizers</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512407"><span class="hs-identifier hs-var">finalizers</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[IO ()] -&gt; Finalizers
</span><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-var">HaskellFinalizers</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512410"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-type">HaskellFinalizers</span></a></span><span> </span><span id="local-6989586621679512406"><span class="annot"><span class="annottext">[IO ()]
</span><a href="#local-6989586621679512406"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[IO ()] -&gt; Finalizers
</span><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-var">HaskellFinalizers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679512410"><span class="hs-identifier hs-var">f</span></a></span><span class="annot"><span class="annottext">IO () -&gt; [IO ()] -&gt; [IO ()]
forall k1. k1 -&gt; [k1] -&gt; [k1]
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#%3A/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[IO ()]
</span><a href="#local-6989586621679512406"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">Finalizers
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Finalizers, Bool)
forall a. a
</span><a href="GHC.ForeignPtr.html#noMixingError"><span class="hs-identifier hs-var">noMixingError</span></a></span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512409"><span class="hs-identifier hs-var">wasEmpty</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- | A box around Weak#, private to this module.</span><span>
</span><span id="line-331"></span><span class="hs-keyword">data</span><span> </span><span id="MyWeak"><span class="annot"><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-var">MyWeak</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MyWeak"><span class="annot"><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-var">MyWeak</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Weak%23/GHC.Prim.html#Weak%23"><span class="hs-identifier hs-type">Weak#</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span id="local-6989586621679512608"><span class="annot"><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-type">insertCFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Addr%23/GHC.Prim.html#Addr%23"><span class="hs-identifier hs-type">Addr#</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Int%23/GHC.Prim.html#Int%23"><span class="hs-identifier hs-type">Int#</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Addr%23/GHC.Prim.html#Addr%23"><span class="hs-identifier hs-type">Addr#</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#Addr%23/GHC.Prim.html#Addr%23"><span class="hs-identifier hs-type">Addr#</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679512608"><span class="hs-identifier hs-type">value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-335"></span><span id="insertCFinalizer"><span class="annot"><span class="annottext">insertCFinalizer :: IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var hs-var">insertCFinalizer</span></a></span></span><span> </span><span id="local-6989586621679512403"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512403"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679512402"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512402"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679512401"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512401"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621679512400"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512400"><span class="hs-identifier hs-var">ep</span></a></span></span><span> </span><span id="local-6989586621679512399"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512399"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679512398"><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679512398"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-type">MyWeak</span></a></span><span> </span><span id="local-6989586621679512397"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512397"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; value -&gt; IO MyWeak
forall value. IORef Finalizers -&gt; value -&gt; IO MyWeak
</span><a href="GHC.ForeignPtr.html#ensureCFinalizerWeak"><span class="hs-identifier hs-var">ensureCFinalizerWeak</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512403"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679512398"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ())
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512395"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512395"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Addr#
-&gt; Addr#
-&gt; Int#
-&gt; Addr#
-&gt; Weak# ()
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int# #)
forall a.
Addr#
-&gt; Addr#
-&gt; Int#
-&gt; Addr#
-&gt; Weak# a
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int# #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#addCFinalizerToWeak%23/GHC.Prim.html#addCFinalizerToWeak%23"><span class="hs-identifier hs-var">addCFinalizerToWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512402"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512399"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512401"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512400"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512397"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512395"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512394"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512394"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">1#</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512394"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-comment">-- Failed to add the finalizer because some other thread</span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-comment">-- has finalized w by calling foreignPtrFinalizer. We retry now.</span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-comment">-- This won't be an infinite loop because that thread must have</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-comment">-- replaced the content of r before calling finalizeWeak#.</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512393"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512393"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; State# RealWorld -&gt; (# State# RealWorld, () #)
forall a. IO a -&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
</span><a href="GHC.Base.html#unIO"><span class="hs-identifier hs-var">unIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
forall value.
IORef Finalizers
-&gt; Addr# -&gt; Int# -&gt; Addr# -&gt; Addr# -&gt; value -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#insertCFinalizer"><span class="hs-identifier hs-var">insertCFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512403"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512402"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512401"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512400"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512399"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679512398"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512393"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span id="local-6989586621679512593"><span class="annot"><a href="GHC.ForeignPtr.html#ensureCFinalizerWeak"><span class="hs-identifier hs-type">ensureCFinalizerWeak</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679512593"><span class="hs-identifier hs-type">value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-type">MyWeak</span></a></span></span><span>
</span><span id="line-347"></span><span id="ensureCFinalizerWeak"><span class="annot"><span class="annottext">ensureCFinalizerWeak :: IORef Finalizers -&gt; value -&gt; IO MyWeak
</span><a href="GHC.ForeignPtr.html#ensureCFinalizerWeak"><span class="hs-identifier hs-var hs-var">ensureCFinalizerWeak</span></a></span></span><span> </span><span id="local-6989586621679512392"><span class="annot"><span class="annottext">ref :: IORef Finalizers
</span><a href="#local-6989586621679512392"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.STRef.html#STRef"><span class="hs-identifier hs-type">STRef</span></a></span><span> </span><span id="local-6989586621679512391"><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
</span><a href="#local-6989586621679512391"><span class="hs-identifier hs-var">r#</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679512390"><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679512390"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>  </span><span id="local-6989586621679512389"><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512389"><span class="hs-identifier hs-var">fin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO Finalizers
forall a. IORef a -&gt; IO a
</span><a href="GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512392"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512389"><span class="hs-identifier hs-var">fin</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><a href="GHC.ForeignPtr.html#CFinalizers"><span class="hs-identifier hs-type">CFinalizers</span></a></span><span> </span><span id="local-6989586621679512387"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512387"><span class="hs-identifier hs-var">weak</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MyWeak -&gt; IO MyWeak
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak# () -&gt; MyWeak
</span><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-var">MyWeak</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512387"><span class="hs-identifier hs-var">weak</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-type">HaskellFinalizers</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO MyWeak
forall a. a
</span><a href="GHC.ForeignPtr.html#noMixingError"><span class="hs-identifier hs-var">noMixingError</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, MyWeak #)) -&gt; IO MyWeak
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, MyWeak #)) -&gt; IO MyWeak)
-&gt; (State# RealWorld -&gt; (# State# RealWorld, MyWeak #))
-&gt; IO MyWeak
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512386"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512386"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-353"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
-&gt; () -&gt; State# RealWorld -&gt; (# State# RealWorld, Weak# () #)
forall k1 a.
k1 -&gt; a -&gt; State# RealWorld -&gt; (# State# RealWorld, Weak# a #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#mkWeakNoFinalizer%23/GHC.Prim.html#mkWeakNoFinalizer%23"><span class="hs-identifier hs-var">mkWeakNoFinalizer#</span></a></span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
</span><a href="#local-6989586621679512391"><span class="hs-identifier hs-var">r#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">value -&gt; ()
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#unsafeCoerce%23/GHC.Prim.html#unsafeCoerce%23"><span class="hs-identifier hs-var">unsafeCoerce#</span></a></span><span> </span><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679512390"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512386"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512385"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512385"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512384"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512384"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>             </span><span class="hs-comment">-- See Note [MallocPtr finalizers] (#10904)</span><span>
</span><span id="line-355"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
-&gt; (Finalizers -&gt; (Finalizers, (MyWeak, Bool)))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Finalizers, (Finalizers, (MyWeak, Bool)) #)
forall d k1 b.
MutVar# d k1 -&gt; (k1 -&gt; b) -&gt; State# d -&gt; (# State# d, k1, b #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#atomicModifyMutVar2%23/GHC.Prim.html#atomicModifyMutVar2%23"><span class="hs-identifier hs-var">atomicModifyMutVar2#</span></a></span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld Finalizers
</span><a href="#local-6989586621679512391"><span class="hs-identifier hs-var">r#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak# () -&gt; Finalizers -&gt; (Finalizers, (MyWeak, Bool))
</span><a href="#local-6989586621679512383"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512384"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512385"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-356"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512382"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512382"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Finalizers
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679512381"><span class="annot"><span class="annottext">MyWeak
</span><a href="#local-6989586621679512381"><span class="hs-identifier hs-var">weak</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512380"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512380"><span class="hs-identifier hs-var">needKill</span></a></span></span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679512380"><span class="hs-identifier hs-var">needKill</span></a></span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Weak# ()
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int#,
      State# RealWorld -&gt; (# State# RealWorld, Any #) #)
forall k1 a.
Weak# k1
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int#,
      State# RealWorld -&gt; (# State# RealWorld, a #) #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#finalizeWeak%23/GHC.Prim.html#finalizeWeak%23"><span class="hs-identifier hs-var">finalizeWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512384"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512382"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512379"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512379"><span class="hs-identifier hs-var">s3</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, Any #)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>              </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512379"><span class="hs-identifier hs-var">s3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MyWeak
</span><a href="#local-6989586621679512381"><span class="hs-identifier hs-var">weak</span></a></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512382"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MyWeak
</span><a href="#local-6989586621679512381"><span class="hs-identifier hs-var">weak</span></a></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-362"></span><span>      </span><span id="local-6989586621679512383"><span class="annot"><span class="annottext">update :: Weak# () -&gt; Finalizers -&gt; (Finalizers, (MyWeak, Bool))
</span><a href="#local-6989586621679512383"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512378"><span class="annot"><span class="annottext">fin :: Finalizers
</span><a href="#local-6989586621679512378"><span class="hs-identifier hs-var">fin</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#CFinalizers"><span class="hs-identifier hs-type">CFinalizers</span></a></span><span> </span><span id="local-6989586621679512377"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512377"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512378"><span class="hs-identifier hs-var">fin</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak# () -&gt; MyWeak
</span><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-var">MyWeak</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512377"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#True/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><a href="#local-6989586621679512383"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span id="local-6989586621679512376"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512376"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak# () -&gt; Finalizers
</span><a href="GHC.ForeignPtr.html#CFinalizers"><span class="hs-identifier hs-var">CFinalizers</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512376"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak# () -&gt; MyWeak
</span><a href="GHC.ForeignPtr.html#MyWeak"><span class="hs-identifier hs-var">MyWeak</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512376"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#False/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><a href="#local-6989586621679512383"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Finalizers, (MyWeak, Bool))
forall a. a
</span><a href="GHC.ForeignPtr.html#noMixingError"><span class="hs-identifier hs-var">noMixingError</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span id="local-6989586621679512596"><span class="annot"><a href="GHC.ForeignPtr.html#noMixingError"><span class="hs-identifier hs-type">noMixingError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679512596"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-367"></span><span id="noMixingError"><span class="annot"><span class="annottext">noMixingError :: a
</span><a href="GHC.ForeignPtr.html#noMixingError"><span class="hs-identifier hs-var hs-var">noMixingError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; a) -&gt; String -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-368"></span><span>   </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.ForeignPtr: attempt to mix Haskell and C finalizers &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-369"></span><span>   </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in the same ForeignPtr&quot;</span></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="annot"><a href="GHC.ForeignPtr.html#foreignPtrFinalizer"><span class="hs-identifier hs-type">foreignPtrFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#Finalizers"><span class="hs-identifier hs-type">Finalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span id="foreignPtrFinalizer"><span class="annot"><span class="annottext">foreignPtrFinalizer :: IORef Finalizers -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#foreignPtrFinalizer"><span class="hs-identifier hs-var hs-var">foreignPtrFinalizer</span></a></span></span><span> </span><span id="local-6989586621679512375"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512375"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>  </span><span id="local-6989586621679512374"><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512374"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; Finalizers -&gt; IO Finalizers
forall a. IORef a -&gt; a -&gt; IO a
</span><a href="GHC.IORef.html#atomicSwapIORef"><span class="hs-identifier hs-var">atomicSwapIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512375"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span>
</span><span id="line-374"></span><span>             </span><span class="hs-comment">-- atomic, see #7170</span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="#local-6989586621679512374"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="GHC.ForeignPtr.html#CFinalizers"><span class="hs-identifier hs-type">CFinalizers</span></a></span><span> </span><span id="local-6989586621679512372"><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512372"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ())
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512371"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512371"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Weak# ()
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int#,
      State# RealWorld -&gt; (# State# RealWorld, () #) #)
forall k1 a.
Weak# k1
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Int#,
      State# RealWorld -&gt; (# State# RealWorld, a #) #)
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#finalizeWeak%23/GHC.Prim.html#finalizeWeak%23"><span class="hs-identifier hs-var">finalizeWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# ()
</span><a href="#local-6989586621679512372"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512371"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512370"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512370"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-number">1#</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679512369"><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679512369"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679512369"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512370"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679512368"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512368"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512368"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><a href="GHC.ForeignPtr.html#HaskellFinalizers"><span class="hs-identifier hs-type">HaskellFinalizers</span></a></span><span> </span><span id="local-6989586621679512367"><span class="annot"><span class="annottext">[IO ()]
</span><a href="#local-6989586621679512367"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[IO ()] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><a href="Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a></span><span> </span><span class="annot"><span class="annottext">[IO ()]
</span><a href="#local-6989586621679512367"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span id="local-6989586621679512644"><span class="annot"><a href="GHC.ForeignPtr.html#newForeignPtr_"><span class="hs-identifier hs-type">newForeignPtr_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512644"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512644"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-383"></span><span class="hs-comment">-- ^Turns a plain memory reference into a foreign pointer that may be</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- associated with finalizers by using 'addForeignPtrFinalizer'.</span><span>
</span><span id="line-385"></span><span id="newForeignPtr_"><span class="annot"><span class="annottext">newForeignPtr_ :: Ptr a -&gt; IO (ForeignPtr a)
</span><a href="GHC.ForeignPtr.html#newForeignPtr_"><span class="hs-identifier hs-var hs-var">newForeignPtr_</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span id="local-6989586621679512366"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512366"><span class="hs-identifier hs-var">obj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>  </span><span id="local-6989586621679512365"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512365"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Finalizers -&gt; IO (IORef Finalizers)
forall a. a -&gt; IO (IORef a)
</span><a href="GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Finalizers
</span><a href="GHC.ForeignPtr.html#NoFinalizers"><span class="hs-identifier hs-var">NoFinalizers</span></a></span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; IO (ForeignPtr a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512366"><span class="hs-identifier hs-var">obj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef Finalizers -&gt; ForeignPtrContents
</span><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-var">PlainForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512365"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span id="local-6989586621679512364"><span class="annot"><a href="GHC.ForeignPtr.html#touchForeignPtr"><span class="hs-identifier hs-type">touchForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512364"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- ^This function ensures that the foreign object in</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- question is alive at the given place in the sequence of IO</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- actions. In particular 'Foreign.ForeignPtr.withForeignPtr'</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- does a 'touchForeignPtr' after it</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- executes the user action.</span><span>
</span><span id="line-395"></span><span class="hs-comment">--</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- Note that this function should not be used to express dependencies</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- between finalizers on 'ForeignPtr's.  For example, if the finalizer</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- for a 'ForeignPtr' @F1@ calls 'touchForeignPtr' on a second</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- 'ForeignPtr' @F2@, then the only guarantee is that the finalizer</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- for @F2@ is never started before the finalizer for @F1@.  They</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- might be started together if for example both @F1@ and @F2@ are</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- otherwise unreachable, and in that case the scheduler might end up</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- running the finalizer for @F2@ first.</span><span>
</span><span id="line-404"></span><span class="hs-comment">--</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- In general, it is not recommended to use finalizers on separate</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- objects with ordering constraints between them.  To express the</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- ordering robustly requires explicit synchronisation using @MVar@s</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- between the finalizers, but even then the runtime sometimes runs</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- multiple finalizers sequentially in a single thread (for</span><span>
</span><span id="line-410"></span><span class="hs-comment">-- performance reasons), so synchronisation between finalizers could</span><span>
</span><span id="line-411"></span><span class="hs-comment">-- result in artificial deadlock.  Another alternative is to use</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- explicit reference counting.</span><span>
</span><span id="line-413"></span><span class="hs-comment">--</span><span>
</span><span id="line-414"></span><span id="touchForeignPtr"><span class="annot"><span class="annottext">touchForeignPtr :: ForeignPtr a -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#touchForeignPtr"><span class="hs-identifier hs-var hs-var">touchForeignPtr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512363"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512363"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512363"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="annot"><a href="GHC.ForeignPtr.html#touch"><span class="hs-identifier hs-type">touch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtrContents"><span class="hs-identifier hs-type">ForeignPtrContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span id="touch"><span class="annot"><span class="annottext">touch :: ForeignPtrContents -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#touch"><span class="hs-identifier hs-var hs-var">touch</span></a></span></span><span> </span><span id="local-6989586621679512362"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512362"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-var">IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ())
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679512361"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512361"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents -&gt; State# RealWorld -&gt; State# RealWorld
forall k1. k1 -&gt; State# RealWorld -&gt; State# RealWorld
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#touch%23/GHC.Prim.html#touch%23"><span class="hs-identifier hs-var">touch#</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512362"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512361"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span id="local-6989586621679512360"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512360"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679512360"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span id="local-6989586621679512652"><span class="annot"><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-type">unsafeForeignPtrToPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512652"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- ^This function extracts the pointer component of a foreign</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- pointer.  This is a potentially dangerous operations, as if the</span><span>
</span><span id="line-422"></span><span class="hs-comment">-- argument to 'unsafeForeignPtrToPtr' is the last usage</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- occurrence of the given foreign pointer, then its finalizer(s) will</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- be run, which potentially invalidates the plain pointer just</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- obtained.  Hence, 'touchForeignPtr' must be used</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- wherever it has to be guaranteed that the pointer lives on - i.e.,</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- has another usage occurrence.</span><span>
</span><span id="line-428"></span><span class="hs-comment">--</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- To avoid subtle coding errors, hand written marshalling code</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- should preferably use 'Foreign.ForeignPtr.withForeignPtr' rather</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- than combinations of 'unsafeForeignPtrToPtr' and</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- 'touchForeignPtr'.  However, the latter routines</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- are occasionally preferred in tool generated marshalling code.</span><span>
</span><span id="line-434"></span><span id="unsafeForeignPtrToPtr"><span class="annot"><span class="annottext">unsafeForeignPtrToPtr :: ForeignPtr a -&gt; Ptr a
</span><a href="GHC.ForeignPtr.html#unsafeForeignPtrToPtr"><span class="hs-identifier hs-var hs-var">unsafeForeignPtrToPtr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span id="local-6989586621679512359"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512359"><span class="hs-identifier hs-var">fo</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; Ptr a
forall a. Addr# -&gt; Ptr a
</span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-var">Ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512359"><span class="hs-identifier hs-var">fo</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span id="local-6989586621679512357"><span id="local-6989586621679512358"><span class="annot"><a href="GHC.ForeignPtr.html#castForeignPtr"><span class="hs-identifier hs-type">castForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512358"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512357"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-437"></span><span class="hs-comment">-- ^This function casts a 'ForeignPtr'</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- parameterised by one type into another type.</span><span>
</span><span id="line-439"></span><span id="castForeignPtr"><span class="annot"><span class="annottext">castForeignPtr :: ForeignPtr a -&gt; ForeignPtr b
</span><a href="GHC.ForeignPtr.html#castForeignPtr"><span class="hs-identifier hs-var hs-var">castForeignPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForeignPtr a -&gt; ForeignPtr b
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#coerce/GHC.Prim.html#coerce"><span class="hs-identifier hs-var">coerce</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span id="local-6989586621679512355"><span id="local-6989586621679512356"><span class="annot"><a href="GHC.ForeignPtr.html#plusForeignPtr"><span class="hs-identifier hs-type">plusForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512356"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#Int/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512355"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-442"></span><span class="hs-comment">-- ^Advances the given address by the given offset in bytes.</span><span>
</span><span id="line-443"></span><span class="hs-comment">--</span><span>
</span><span id="line-444"></span><span class="hs-comment">-- The new 'ForeignPtr' shares the finalizer of the original,</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- equivalent from a finalization standpoint to just creating another</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- reference to the original. That is, the finalizer will not be</span><span>
</span><span id="line-447"></span><span class="hs-comment">-- called before the new 'ForeignPtr' is unreachable, nor will it be</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- called an additional time due to this call, and the finalizer will</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- be called with the same address that it would have had this call</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- not happened, *not* the new address.</span><span>
</span><span id="line-451"></span><span class="hs-comment">--</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- @since 4.10.0.0</span><span>
</span><span id="line-453"></span><span id="plusForeignPtr"><span class="annot"><span class="annottext">plusForeignPtr :: ForeignPtr a -&gt; Int -&gt; ForeignPtr b
</span><a href="GHC.ForeignPtr.html#plusForeignPtr"><span class="hs-identifier hs-var hs-var">plusForeignPtr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span id="local-6989586621679512354"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512354"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621679512353"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512353"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#I%23/GHC.Types.html#I%23"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679512352"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512352"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr b
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-var">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Addr# -&gt; Int# -&gt; Addr#
</span><a href="../../ghc-prim-0.6.1/src/GHC-Prim.html#plusAddr%23/GHC.Prim.html#plusAddr%23"><span class="hs-identifier hs-var">plusAddr#</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679512354"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679512352"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512353"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-comment">-- | Causes the finalizers associated with a foreign pointer to be run</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- immediately.</span><span>
</span><span id="line-457"></span><span id="local-6989586621679512351"><span class="annot"><a href="GHC.ForeignPtr.html#finalizeForeignPtr"><span class="hs-identifier hs-type">finalizeForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679512351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghc-prim-0.6.1/src/GHC-Types.html#IO/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-458"></span><span id="finalizeForeignPtr"><span class="annot"><span class="annottext">finalizeForeignPtr :: ForeignPtr a -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#finalizeForeignPtr"><span class="hs-identifier hs-var hs-var">finalizeForeignPtr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-type">PlainPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- no effect</span><span>
</span><span id="line-459"></span><span class="annot"><a href="GHC.ForeignPtr.html#finalizeForeignPtr"><span class="hs-identifier hs-var">finalizeForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512350"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512350"><span class="hs-identifier hs-var">foreignPtr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers -&gt; IO ()
</span><a href="GHC.ForeignPtr.html#foreignPtrFinalizer"><span class="hs-identifier hs-var">foreignPtrFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512349"><span class="hs-identifier hs-var">refFinalizers</span></a></span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-461"></span><span>                </span><span id="local-6989586621679512349"><span class="annot"><span class="annottext">refFinalizers :: IORef Finalizers
</span><a href="#local-6989586621679512349"><span class="hs-identifier hs-var hs-var">refFinalizers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679512350"><span class="hs-identifier hs-var">foreignPtr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-462"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#PlainForeignPtr"><span class="hs-identifier hs-type">PlainForeignPtr</span></a></span><span> </span><span id="local-6989586621679512348"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512348"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512348"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-463"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.ForeignPtr.html#MallocPtr"><span class="hs-identifier hs-type">MallocPtr</span></a></span><span>     </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679512347"><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512347"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef Finalizers
</span><a href="#local-6989586621679512347"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-464"></span><span>                        </span><span class="annot"><a href="GHC.ForeignPtr.html#PlainPtr"><span class="hs-identifier hs-type">PlainPtr</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-465"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; IORef Finalizers
forall a. String -&gt; a
</span><a href="GHC.Err.html#errorWithoutStackTrace"><span class="hs-identifier hs-var">errorWithoutStackTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;finalizeForeignPtr PlainPtr&quot;</span></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span></pre></body></html>