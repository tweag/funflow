<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, BangPatterns, PatternGuards #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving, DeriveDataTypeable #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Module      :  Codec.Archive.Tar.Index</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Copyright   :  (c) 2010-2015 Duncan Coutts</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- License     :  BSD3</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Maintainer  :  duncan@community.haskell.org</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Portability :  portable</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Random access to the content of a @.tar@ archive.</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- This module uses common names and so is designed to be imported qualified:</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- &gt; import qualified Codec.Archive.Tar.Index as TarIndex</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Codec.Archive.Tar.Index</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-comment">-- | The @tar@ format does not contain an index of files within the</span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-comment">-- archive. Normally, @tar@ file have to be processed linearly. It is</span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-comment">-- sometimes useful however to be able to get random access to files</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-comment">-- within the archive.</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-comment">-- This module provides an index of a @tar@ file. A linear pass of the</span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-comment">-- @tar@ file is needed to 'build' the 'TarIndex', but thereafter you can</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-comment">-- 'lookup' paths in the @tar@ file, and then use 'hReadEntry' to</span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-comment">-- seek to the right part of the file and read the entry.</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-comment">-- An index cannot be used to lookup 'Directory' entries in a tar file;</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-comment">-- instead, you will get 'TarDir' entry listing all the entries in the</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-comment">-- directory.</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Index type</span></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier">TarIndex</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Index lookup</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#lookup"><span class="hs-identifier">lookup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndexEntry"><span class="hs-identifier">TarIndexEntry</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#toList"><span class="hs-identifier">toList</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** I\/O operations</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier">TarEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntry"><span class="hs-identifier">hReadEntry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntryHeader"><span class="hs-identifier">hReadEntryHeader</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Index construction</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#build"><span class="hs-identifier">build</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Incremental construction</span></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="hs-comment">-- $incremental-construction</span></span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier">IndexBuilder</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#empty"><span class="hs-identifier">empty</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#addNextEntry"><span class="hs-identifier">addNextEntry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#skipNextEntry"><span class="hs-identifier">skipNextEntry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#finalise"><span class="hs-identifier">finalise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#unfinalise"><span class="hs-identifier">unfinalise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Serialising indexes</span></span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#serialise"><span class="hs-identifier">serialise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#deserialise"><span class="hs-identifier">deserialise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Lower level operations with offsets and I\/O on tar files</span></span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntryHeaderOrEof"><span class="hs-identifier">hReadEntryHeaderOrEof</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier">hSeekEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEntryContentOffset"><span class="hs-identifier">hSeekEntryContentOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEndEntryOffset"><span class="hs-identifier">hSeekEndEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier">nextEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#indexEndEntryOffset"><span class="hs-identifier">indexEndEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#indexNextEntryOffset"><span class="hs-identifier">indexNextEntryOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Deprecated aliases</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#emptyIndex"><span class="hs-identifier">emptyIndex</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#finaliseIndex"><span class="hs-identifier">finaliseIndex</span></a></span><span class="hs-special">,</span><span class="hs-cpp">

#ifdef TESTS
</span><span>    </span><span class="hs-identifier">prop_lookup</span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-identifier">prop_toList</span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-identifier">prop_valid</span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-identifier">prop_serialise_deserialise</span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-identifier">prop_serialiseSize</span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-identifier">prop_index_matches_tar</span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-identifier">prop_finalise_unfinalise</span><span class="hs-special">,</span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html"><span class="hs-identifier">Codec.Archive.Tar.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tar</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Read.html"><span class="hs-identifier">Codec.Archive.Tar.Read</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tar</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html"><span class="hs-identifier">Codec.Archive.Tar.Index.StringTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">StringTable</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html"><span class="hs-identifier">Codec.Archive.Tar.Index.StringTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTable"><span class="hs-identifier">StringTable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTableBuilder"><span class="hs-identifier">StringTableBuilder</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html"><span class="hs-identifier">Codec.Archive.Tar.Index.IntTrie</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IntTrie</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html"><span class="hs-identifier">Codec.Archive.Tar.Index.IntTrie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier">IntTrie</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier">IntTrieBuilder</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath.Posix</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FilePath</span></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Monoid</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#if (MIN_VERSION_base(4,5,0))
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;&gt;)</span></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Array.Unboxed</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS.Char8</span></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LBS</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Unsafe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span class="hs-cpp">
#if MIN_VERSION_bytestring(0,10,2) || defined(MIN_VERSION_bytestring_builder)
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder.Extra</span></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toLazyByteStringWith</span></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>                                               </span><span class="annot"><span class="hs-identifier">untrimmedStrategy</span></span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Builder</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Builder.Extras</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toLazyByteStringWith</span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>                                                  </span><span class="hs-identifier">untrimmedStrategy</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef TESTS
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test.QuickCheck</span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test.QuickCheck.Property</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ioProperty</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unless</span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nub</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sort</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sortBy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stripPrefix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">on</span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">try</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Codec.Archive.Tar.Write</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Tar</span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Handle</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HBS</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- | An index of the entries in a tar file.</span><span>
</span><span id="line-141"></span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- This index type is designed to be quite compact and suitable to store either</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- on disk or in memory.</span><span>
</span><span id="line-144"></span><span class="hs-comment">--</span><span>
</span><span id="line-145"></span><span class="hs-keyword">data</span><span> </span><span id="TarIndex"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-var">TarIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TarIndex"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-var">TarIndex</span></a></span></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-comment">-- As an example of how the mapping works, consider these example files:</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-comment">--   &quot;foo/bar.hs&quot; at offset 0</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-comment">--   &quot;foo/baz.hs&quot; at offset 1024</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-comment">-- We split the paths into components and enumerate them.</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-comment">--   { &quot;foo&quot; -&gt; TokenId 0, &quot;bar.hs&quot; -&gt; TokenId 1,  &quot;baz.hs&quot; -&gt; TokenId 2 }</span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-comment">-- We convert paths into sequences of 'TokenId's, i.e.</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-comment">--   &quot;foo/bar.hs&quot; becomes [PathComponentId 0, PathComponentId 1]</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-comment">--   &quot;foo/baz.hs&quot; becomes [PathComponentId 0, PathComponentId 2]</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-comment">-- We use a trie mapping sequences of 'PathComponentId's to the entry offset:</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">--  { [PathComponentId 0, PathComponentId 1] -&gt; offset 0</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-comment">--  , [PathComponentId 0, PathComponentId 2] -&gt; offset 1024 }</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-comment">-- The mapping of filepath components as strings to ids.</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTable"><span class="hs-identifier hs-type">StringTable</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-comment">-- Mapping of sequences of filepath component ids to tar entry offsets.</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-comment">-- The offset immediatly after the last entry, where we would append any</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-comment">-- additional entries.</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059320"><span id="local-6989586621679059322"><span class="annot"><span class="annottext">TarIndex -&gt; TarIndex -&gt; Bool
(TarIndex -&gt; TarIndex -&gt; Bool)
-&gt; (TarIndex -&gt; TarIndex -&gt; Bool) -&gt; Eq TarIndex
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: TarIndex -&gt; TarIndex -&gt; Bool
$c/= :: TarIndex -&gt; TarIndex -&gt; Bool
== :: TarIndex -&gt; TarIndex -&gt; Bool
$c== :: TarIndex -&gt; TarIndex -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059313"><span id="local-6989586621679059315"><span id="local-6989586621679059317"><span class="annot"><span class="annottext">Int -&gt; TarIndex -&gt; ShowS
[TarIndex] -&gt; ShowS
TarIndex -&gt; String
(Int -&gt; TarIndex -&gt; ShowS)
-&gt; (TarIndex -&gt; String) -&gt; ([TarIndex] -&gt; ShowS) -&gt; Show TarIndex
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TarIndex] -&gt; ShowS
$cshowList :: [TarIndex] -&gt; ShowS
show :: TarIndex -&gt; String
$cshow :: TarIndex -&gt; String
showsPrec :: Int -&gt; TarIndex -&gt; ShowS
$cshowsPrec :: Int -&gt; TarIndex -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-175"></span><span>  </span><span id="local-6989586621679059309"><span class="annot"><span class="annottext">rnf :: TarIndex -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- fully strict by construction</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">-- | The result of 'lookup' in a 'TarIndex'. It can either be a file directly,</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- or a directory entry containing further entries (and all subdirectories</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- recursively). Note that the subtrees are constructed lazily, so it's</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- cheaper if you don't look at them.</span><span>
</span><span id="line-181"></span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span class="hs-keyword">data</span><span> </span><span id="TarIndexEntry"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndexEntry"><span class="hs-identifier hs-var">TarIndexEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TarFileEntry"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarFileEntry"><span class="hs-identifier hs-var">TarFileEntry</span></a></span></span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-183"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="TarDir"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarDir"><span class="hs-identifier hs-var">TarDir</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndexEntry"><span class="hs-identifier hs-type">TarIndexEntry</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059299"><span id="local-6989586621679059301"><span id="local-6989586621679059303"><span class="annot"><span class="annottext">Int -&gt; TarIndexEntry -&gt; ShowS
[TarIndexEntry] -&gt; ShowS
TarIndexEntry -&gt; String
(Int -&gt; TarIndexEntry -&gt; ShowS)
-&gt; (TarIndexEntry -&gt; String)
-&gt; ([TarIndexEntry] -&gt; ShowS)
-&gt; Show TarIndexEntry
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TarIndexEntry] -&gt; ShowS
$cshowList :: [TarIndexEntry] -&gt; ShowS
show :: TarIndexEntry -&gt; String
$cshow :: TarIndexEntry -&gt; String
showsPrec :: Int -&gt; TarIndexEntry -&gt; ShowS
$cshowsPrec :: Int -&gt; TarIndexEntry -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-keyword">newtype</span><span> </span><span id="PathComponentId"><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-var">PathComponentId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PathComponentId"><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-var">PathComponentId</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059294"><span id="local-6989586621679059296"><span class="annot"><span class="annottext">PathComponentId -&gt; PathComponentId -&gt; Bool
(PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; Eq PathComponentId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c/= :: PathComponentId -&gt; PathComponentId -&gt; Bool
== :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c== :: PathComponentId -&gt; PathComponentId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059279"><span id="local-6989586621679059281"><span id="local-6989586621679059283"><span id="local-6989586621679059285"><span id="local-6989586621679059287"><span id="local-6989586621679059289"><span id="local-6989586621679059291"><span class="annot"><span class="annottext">Eq PathComponentId
Eq PathComponentId
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Ordering)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; Bool)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; PathComponentId)
-&gt; (PathComponentId -&gt; PathComponentId -&gt; PathComponentId)
-&gt; Ord PathComponentId
PathComponentId -&gt; PathComponentId -&gt; Bool
PathComponentId -&gt; PathComponentId -&gt; Ordering
PathComponentId -&gt; PathComponentId -&gt; PathComponentId
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: PathComponentId -&gt; PathComponentId -&gt; PathComponentId
$cmin :: PathComponentId -&gt; PathComponentId -&gt; PathComponentId
max :: PathComponentId -&gt; PathComponentId -&gt; PathComponentId
$cmax :: PathComponentId -&gt; PathComponentId -&gt; PathComponentId
&gt;= :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c&gt;= :: PathComponentId -&gt; PathComponentId -&gt; Bool
&gt; :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c&gt; :: PathComponentId -&gt; PathComponentId -&gt; Bool
&lt;= :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c&lt;= :: PathComponentId -&gt; PathComponentId -&gt; Bool
&lt; :: PathComponentId -&gt; PathComponentId -&gt; Bool
$c&lt; :: PathComponentId -&gt; PathComponentId -&gt; Bool
compare :: PathComponentId -&gt; PathComponentId -&gt; Ordering
$ccompare :: PathComponentId -&gt; PathComponentId -&gt; Ordering
$cp1Ord :: Eq PathComponentId
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059262"><span id="local-6989586621679059264"><span id="local-6989586621679059266"><span id="local-6989586621679059268"><span id="local-6989586621679059270"><span id="local-6989586621679059272"><span id="local-6989586621679059274"><span id="local-6989586621679059276"><span class="annot"><span class="annottext">Int -&gt; PathComponentId
PathComponentId -&gt; Int
PathComponentId -&gt; [PathComponentId]
PathComponentId -&gt; PathComponentId
PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
PathComponentId
-&gt; PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
(PathComponentId -&gt; PathComponentId)
-&gt; (PathComponentId -&gt; PathComponentId)
-&gt; (Int -&gt; PathComponentId)
-&gt; (PathComponentId -&gt; Int)
-&gt; (PathComponentId -&gt; [PathComponentId])
-&gt; (PathComponentId -&gt; PathComponentId -&gt; [PathComponentId])
-&gt; (PathComponentId -&gt; PathComponentId -&gt; [PathComponentId])
-&gt; (PathComponentId
    -&gt; PathComponentId -&gt; PathComponentId -&gt; [PathComponentId])
-&gt; Enum PathComponentId
forall a.
(a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Int -&gt; a)
-&gt; (a -&gt; Int)
-&gt; (a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; a -&gt; [a])
-&gt; Enum a
enumFromThenTo :: PathComponentId
-&gt; PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
$cenumFromThenTo :: PathComponentId
-&gt; PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
enumFromTo :: PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
$cenumFromTo :: PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
enumFromThen :: PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
$cenumFromThen :: PathComponentId -&gt; PathComponentId -&gt; [PathComponentId]
enumFrom :: PathComponentId -&gt; [PathComponentId]
$cenumFrom :: PathComponentId -&gt; [PathComponentId]
fromEnum :: PathComponentId -&gt; Int
$cfromEnum :: PathComponentId -&gt; Int
toEnum :: Int -&gt; PathComponentId
$ctoEnum :: Int -&gt; PathComponentId
pred :: PathComponentId -&gt; PathComponentId
$cpred :: PathComponentId -&gt; PathComponentId
succ :: PathComponentId -&gt; PathComponentId
$csucc :: PathComponentId -&gt; PathComponentId
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Enum</span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059255"><span id="local-6989586621679059257"><span id="local-6989586621679059259"><span class="annot"><span class="annottext">Int -&gt; PathComponentId -&gt; ShowS
[PathComponentId] -&gt; ShowS
PathComponentId -&gt; String
(Int -&gt; PathComponentId -&gt; ShowS)
-&gt; (PathComponentId -&gt; String)
-&gt; ([PathComponentId] -&gt; ShowS)
-&gt; Show PathComponentId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PathComponentId] -&gt; ShowS
$cshowList :: [PathComponentId] -&gt; ShowS
show :: PathComponentId -&gt; String
$cshow :: PathComponentId -&gt; String
showsPrec :: Int -&gt; PathComponentId -&gt; ShowS
$cshowsPrec :: Int -&gt; PathComponentId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | An offset within a tar file. Use 'hReadEntry', 'hReadEntryHeader' or</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- 'hSeekEntryOffset'.</span><span>
</span><span id="line-192"></span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- This is actually a tar \&quot;record\&quot; number, not a byte offset.</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-keyword">type</span><span> </span><span id="TarEntryOffset"><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-var">TarEntryOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Look up a given filepath in the 'TarIndex'. It may return a 'TarFileEntry'</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- containing the 'TarEntryOffset' of the file within the tar file, or if</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- the filepath identifies a directory then it returns a 'TarDir' containing</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- the list of files within that directory.</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- Given the 'TarEntryOffset' you can then use one of the I\/O operations:</span><span>
</span><span id="line-204"></span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- * 'hReadEntry' to read the whole entry;</span><span>
</span><span id="line-206"></span><span class="hs-comment">--</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- * 'hReadEntryHeader' to read just the file metadata (e.g. its length);</span><span>
</span><span id="line-208"></span><span class="hs-comment">--</span><span>
</span><span id="line-209"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#lookup"><span class="hs-identifier hs-type">lookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndexEntry"><span class="hs-identifier hs-type">TarIndexEntry</span></a></span><span>
</span><span id="line-210"></span><span id="lookup"><span class="annot"><span class="annottext">lookup :: TarIndex -&gt; String -&gt; Maybe TarIndexEntry
</span><a href="Codec.Archive.Tar.Index.html#lookup"><span class="hs-identifier hs-var hs-var">lookup</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span id="local-6989586621679059254"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059254"><span class="hs-identifier hs-var">pathTable</span></a></span></span><span> </span><span id="local-6989586621679059253"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059253"><span class="hs-identifier hs-var">pathTrie</span></a></span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679059252"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059252"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679059251"><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059251"><span class="hs-identifier hs-var">fpath</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; String -&gt; Maybe [PathComponentId]
</span><a href="Codec.Archive.Tar.Index.html#toComponentIds"><span class="hs-identifier hs-var">toComponentIds</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059254"><span class="hs-identifier hs-var">pathTable</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059252"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621679059249"><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059249"><span class="hs-identifier hs-var">tentry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
-&gt; [PathComponentId]
-&gt; Maybe (TrieLookup PathComponentId TarEntryOffset)
forall k v.
(Enum k, Enum v) =&gt;
IntTrie k v -&gt; [k] -&gt; Maybe (TrieLookup k v)
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#lookup"><span class="hs-identifier hs-var">IntTrie.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059253"><span class="hs-identifier hs-var">pathTrie</span></a></span><span> </span><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059251"><span class="hs-identifier hs-var">fpath</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">TarIndexEntry -&gt; Maybe TarIndexEntry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset -&gt; TarIndexEntry
</span><a href="#local-6989586621679059247"><span class="hs-identifier hs-var">mkIndexEntry</span></a></span><span> </span><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059249"><span class="hs-identifier hs-var">tentry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>    </span><span id="local-6989586621679059247"><span class="annot"><span class="annottext">mkIndexEntry :: TrieLookup PathComponentId TarEntryOffset -&gt; TarIndexEntry
</span><a href="#local-6989586621679059247"><span class="hs-identifier hs-var hs-var">mkIndexEntry</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier hs-type">IntTrie.Entry</span></a></span><span> </span><span id="local-6989586621679059245"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059245"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarIndexEntry
</span><a href="Codec.Archive.Tar.Index.html#TarFileEntry"><span class="hs-identifier hs-var">TarFileEntry</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059245"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="#local-6989586621679059247"><span class="hs-identifier hs-var">mkIndexEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-type">IntTrie.Completions</span></a></span><span> </span><span id="local-6989586621679059243"><span class="annot"><span class="annottext">Completions PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059243"><span class="hs-identifier hs-var">entries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="annottext">[(String, TarIndexEntry)] -&gt; TarIndexEntry
</span><a href="Codec.Archive.Tar.Index.html#TarDir"><span class="hs-identifier hs-var">TarDir</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; PathComponentId -&gt; String
</span><a href="Codec.Archive.Tar.Index.html#fromComponentId"><span class="hs-identifier hs-var">fromComponentId</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059254"><span class="hs-identifier hs-var">pathTable</span></a></span><span> </span><span class="annot"><span class="annottext">PathComponentId
</span><a href="#local-6989586621679059241"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset -&gt; TarIndexEntry
</span><a href="#local-6989586621679059247"><span class="hs-identifier hs-var">mkIndexEntry</span></a></span><span> </span><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059240"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059241"><span class="annot"><span class="annottext">PathComponentId
</span><a href="#local-6989586621679059241"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059240"><span class="annot"><span class="annottext">TrieLookup PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059240"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Completions PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059243"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#toComponentIds"><span class="hs-identifier hs-type">toComponentIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTable"><span class="hs-identifier hs-type">StringTable</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span id="toComponentIds"><span class="annot"><span class="annottext">toComponentIds :: StringTable PathComponentId -&gt; String -&gt; Maybe [PathComponentId]
</span><a href="Codec.Archive.Tar.Index.html#toComponentIds"><span class="hs-identifier hs-var hs-var">toComponentIds</span></a></span></span><span> </span><span id="local-6989586621679059239"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059239"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">[PathComponentId] -&gt; [ByteString] -&gt; Maybe [PathComponentId]
</span><a href="#local-6989586621679059238"><span class="hs-identifier hs-var">lookupComponents</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="annottext">([ByteString] -&gt; Maybe [PathComponentId])
-&gt; (String -&gt; [ByteString]) -&gt; String -&gt; Maybe [PathComponentId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Bool) -&gt; [ByteString] -&gt; [ByteString]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.Char8.singleton</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">([ByteString] -&gt; [ByteString])
-&gt; (String -&gt; [ByteString]) -&gt; String -&gt; [ByteString]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitDirectories"><span class="hs-identifier hs-var">splitDirectories</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><span class="annottext">(ByteString -&gt; [ByteString])
-&gt; (String -&gt; ByteString) -&gt; String -&gt; [ByteString]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.Char8.pack</span></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621679059238"><span class="annot"><span class="annottext">lookupComponents :: [PathComponentId] -&gt; [ByteString] -&gt; Maybe [PathComponentId]
</span><a href="#local-6989586621679059238"><span class="hs-identifier hs-var hs-var">lookupComponents</span></a></span></span><span> </span><span id="local-6989586621679059232"><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059232"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PathComponentId] -&gt; Maybe [PathComponentId]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PathComponentId] -&gt; [PathComponentId]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059232"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="#local-6989586621679059238"><span class="hs-identifier hs-var">lookupComponents</span></a></span><span> </span><span id="local-6989586621679059230"><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059230"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059229"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059229"><span class="hs-identifier hs-var">c</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679059228"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059228"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; ByteString -&gt; Maybe PathComponentId
forall id. Enum id =&gt; StringTable id -&gt; ByteString -&gt; Maybe id
</span><a href="Codec.Archive.Tar.Index.StringTable.html#lookup"><span class="hs-identifier hs-var">StringTable.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059239"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059229"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">Maybe PathComponentId
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [PathComponentId]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679059226"><span class="annot"><span class="annottext">PathComponentId
</span><a href="#local-6989586621679059226"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PathComponentId] -&gt; [ByteString] -&gt; Maybe [PathComponentId]
</span><a href="#local-6989586621679059238"><span class="hs-identifier hs-var">lookupComponents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathComponentId
</span><a href="#local-6989586621679059226"><span class="hs-identifier hs-var">cid</span></a></span><span class="annot"><span class="annottext">PathComponentId -&gt; [PathComponentId] -&gt; [PathComponentId]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059230"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059228"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#fromComponentId"><span class="hs-identifier hs-type">fromComponentId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTable"><span class="hs-identifier hs-type">StringTable</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-234"></span><span id="fromComponentId"><span class="annot"><span class="annottext">fromComponentId :: StringTable PathComponentId -&gt; PathComponentId -&gt; String
</span><a href="Codec.Archive.Tar.Index.html#fromComponentId"><span class="hs-identifier hs-var hs-var">fromComponentId</span></a></span></span><span> </span><span id="local-6989586621679059225"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059225"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; String
</span><span class="hs-identifier hs-var">BS.Char8.unpack</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; String)
-&gt; (PathComponentId -&gt; ByteString) -&gt; PathComponentId -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; PathComponentId -&gt; ByteString
forall id. Enum id =&gt; StringTable id -&gt; id -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.StringTable.html#index"><span class="hs-identifier hs-var">StringTable.index</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059225"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-comment">-- | All the files in the index with their corresponding 'TarEntryOffset's.</span><span>
</span><span id="line-237"></span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- Note that the files are in no special order. If you intend to read all or</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- most files then is is recommended to sort by the 'TarEntryOffset'.</span><span>
</span><span id="line-240"></span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#toList"><span class="hs-identifier hs-type">toList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-242"></span><span id="toList"><span class="annot"><span class="annottext">toList :: TarIndex -&gt; [(String, TarEntryOffset)]
</span><a href="Codec.Archive.Tar.Index.html#toList"><span class="hs-identifier hs-var hs-var">toList</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span id="local-6989586621679059222"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059222"><span class="hs-identifier hs-var">pathTable</span></a></span></span><span> </span><span id="local-6989586621679059221"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059221"><span class="hs-identifier hs-var">pathTrie</span></a></span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679059220"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059219"><span class="hs-identifier hs-var">off</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059218"><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059218"><span class="hs-identifier hs-var">cids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059219"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059219"><span class="hs-identifier hs-var">off</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
-&gt; [([PathComponentId], TarEntryOffset)]
forall k v. (Enum k, Enum v) =&gt; IntTrie k v -&gt; [([k], v)]
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#toList"><span class="hs-identifier hs-var">IntTrie.toList</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059221"><span class="hs-identifier hs-var">pathTrie</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059220"><span class="annot"><span class="annottext">path :: String
</span><a href="#local-6989586621679059220"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">FilePath.joinPath</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PathComponentId -&gt; String) -&gt; [PathComponentId] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; PathComponentId -&gt; String
</span><a href="Codec.Archive.Tar.Index.html#fromComponentId"><span class="hs-identifier hs-var">fromComponentId</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059222"><span class="hs-identifier hs-var">pathTable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059218"><span class="hs-identifier hs-var">cids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Build a 'TarIndex' from a sequence of tar 'Entries'. The 'Entries' are</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- assumed to start at offset @0@ within a file.</span><span>
</span><span id="line-250"></span><span class="hs-comment">--</span><span>
</span><span id="line-251"></span><span id="local-6989586621679059215"><span class="annot"><a href="Codec.Archive.Tar.Index.html#build"><span class="hs-identifier hs-type">build</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entries"><span class="hs-identifier hs-type">Entries</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679059215"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679059215"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span></span><span>
</span><span id="line-252"></span><span id="build"><span class="annot"><span class="annottext">build :: Entries e -&gt; Either e TarIndex
</span><a href="Codec.Archive.Tar.Index.html#build"><span class="hs-identifier hs-var hs-var">build</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IndexBuilder -&gt; Entries e -&gt; Either e TarIndex
forall a. IndexBuilder -&gt; Entries a -&gt; Either a TarIndex
</span><a href="#local-6989586621679059214"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621679059214"><span class="annot"><span class="annottext">go :: IndexBuilder -&gt; Entries a -&gt; Either a TarIndex
</span><a href="#local-6989586621679059214"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679059213"><span class="annot"><span class="annottext">IndexBuilder
</span><a href="#local-6989586621679059213"><span class="hs-identifier hs-var">builder</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Next"><span class="hs-identifier hs-type">Next</span></a></span><span> </span><span id="local-6989586621679059211"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059211"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679059210"><span class="annot"><span class="annottext">Entries a
</span><a href="#local-6989586621679059210"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IndexBuilder -&gt; Entries a -&gt; Either a TarIndex
</span><a href="#local-6989586621679059214"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry -&gt; IndexBuilder -&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#addNextEntry"><span class="hs-identifier hs-var">addNextEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059211"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">IndexBuilder
</span><a href="#local-6989586621679059213"><span class="hs-identifier hs-var">builder</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Entries a
</span><a href="#local-6989586621679059210"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><a href="#local-6989586621679059214"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679059209"><span class="annot"><span class="annottext">IndexBuilder
</span><a href="#local-6989586621679059209"><span class="hs-identifier hs-var">builder</span></a></span></span><span>  </span><span class="annot"><span class="annottext">Entries a
</span><a href="Codec.Archive.Tar.Types.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarIndex -&gt; Either a TarIndex
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(TarIndex -&gt; Either a TarIndex) -&gt; TarIndex -&gt; Either a TarIndex
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">IndexBuilder -&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#finalise"><span class="hs-identifier hs-var">finalise</span></a></span><span> </span><span class="annot"><span class="annottext">IndexBuilder
</span><a href="#local-6989586621679059209"><span class="hs-identifier hs-var">builder</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><a href="#local-6989586621679059214"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">IndexBuilder
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Fail"><span class="hs-identifier hs-type">Fail</span></a></span><span> </span><span id="local-6989586621679059205"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679059205"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Either a TarIndex
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679059205"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- $incremental-construction</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- If you need more control than 'build' then you can construct the index</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- in an acumulator style using the 'IndexBuilder' and operations.</span><span>
</span><span id="line-262"></span><span class="hs-comment">--</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- Start with 'empty' and use 'addNextEntry' (or 'skipNextEntry') for</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- each 'Entry' in the tar file in order. Every entry must added or skipped in</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- order, otherwise the resulting 'TarIndex' will report the wrong</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- 'TarEntryOffset's. At the end use 'finalise' to get the 'TarIndex'.</span><span>
</span><span id="line-267"></span><span class="hs-comment">--</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- For example, 'build' is simply:</span><span>
</span><span id="line-269"></span><span class="hs-comment">--</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- &gt; build = go empty</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- &gt;   where</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- &gt;     go !builder (Next e es) = go (addNextEntry e builder) es</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- &gt;     go !builder  Done       = Right $! finalise builder</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- &gt;     go !_       (Fail err)  = Left err</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="hs-comment">-- | The intermediate type used for incremental construction of a 'TarIndex'.</span><span>
</span><span id="line-278"></span><span class="hs-comment">--</span><span>
</span><span id="line-279"></span><span class="hs-keyword">data</span><span> </span><span id="IndexBuilder"><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span></span><span>
</span><span id="line-280"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="IndexBuilder"><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.StringTable.html#StringTableBuilder"><span class="hs-identifier hs-type">StringTableBuilder</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>                  </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#PathComponentId"><span class="hs-identifier hs-type">PathComponentId</span></a></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>   </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679059200"><span id="local-6989586621679059202"><span class="annot"><span class="annottext">IndexBuilder -&gt; IndexBuilder -&gt; Bool
(IndexBuilder -&gt; IndexBuilder -&gt; Bool)
-&gt; (IndexBuilder -&gt; IndexBuilder -&gt; Bool) -&gt; Eq IndexBuilder
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: IndexBuilder -&gt; IndexBuilder -&gt; Bool
$c/= :: IndexBuilder -&gt; IndexBuilder -&gt; Bool
== :: IndexBuilder -&gt; IndexBuilder -&gt; Bool
$c== :: IndexBuilder -&gt; IndexBuilder -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059194"><span id="local-6989586621679059196"><span id="local-6989586621679059198"><span class="annot"><span class="annottext">Int -&gt; IndexBuilder -&gt; ShowS
[IndexBuilder] -&gt; ShowS
IndexBuilder -&gt; String
(Int -&gt; IndexBuilder -&gt; ShowS)
-&gt; (IndexBuilder -&gt; String)
-&gt; ([IndexBuilder] -&gt; ShowS)
-&gt; Show IndexBuilder
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [IndexBuilder] -&gt; ShowS
$cshowList :: [IndexBuilder] -&gt; ShowS
show :: IndexBuilder -&gt; String
$cshow :: IndexBuilder -&gt; String
showsPrec :: Int -&gt; IndexBuilder -&gt; ShowS
$cshowsPrec :: Int -&gt; IndexBuilder -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-286"></span><span>  </span><span id="local-6989586621679059192"><span class="annot"><span class="annottext">rnf :: IndexBuilder -&gt; ()
</span><a href="#local-6989586621679059192"><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- fully strict by construction</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | The initial empty 'IndexBuilder'.</span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#empty"><span class="hs-identifier hs-type">empty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span>
</span><span id="line-291"></span><span id="empty"><span class="annot"><span class="annottext">empty :: IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#empty"><span class="hs-identifier hs-var hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
forall id. StringTableBuilder id
</span><a href="Codec.Archive.Tar.Index.StringTable.html#empty"><span class="hs-identifier hs-var">StringTable.empty</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
forall k v. IntTrieBuilder k v
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#empty"><span class="hs-identifier hs-var">IntTrie.empty</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#emptyIndex"><span class="hs-identifier hs-type">emptyIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span>
</span><span id="line-294"></span><span id="emptyIndex"><span class="annot"><span class="annottext">emptyIndex :: IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#emptyIndex"><span class="hs-identifier hs-var hs-var">emptyIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-295"></span><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">emptyIndex</span><span> </span><span class="hs-pragma">&quot;Use TarIndex.empty&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | Add the next 'Entry' into the 'IndexBuilder'.</span><span>
</span><span id="line-298"></span><span class="hs-comment">--</span><span>
</span><span id="line-299"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#addNextEntry"><span class="hs-identifier hs-type">addNextEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span>
</span><span id="line-300"></span><span id="addNextEntry"><span class="annot"><span class="annottext">addNextEntry :: Entry -&gt; IndexBuilder -&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#addNextEntry"><span class="hs-identifier hs-var hs-var">addNextEntry</span></a></span></span><span> </span><span id="local-6989586621679059189"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059189"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span id="local-6989586621679059188"><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059188"><span class="hs-identifier hs-var">stbl</span></a></span></span><span> </span><span id="local-6989586621679059187"><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">itrie</span></a></span></span><span> </span><span id="local-6989586621679059186"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059186"><span class="hs-identifier hs-var">nextOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059185"><span class="hs-identifier hs-var">stbl'</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059184"><span class="hs-identifier hs-var">itrie'</span></a></span><span>
</span><span id="line-302"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry -&gt; TarEntryOffset -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier hs-var">nextEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059189"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059186"><span class="hs-identifier hs-var">nextOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679059183"><span class="annot"><span class="annottext">entrypath :: [ByteString]
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var hs-var">entrypath</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarPath -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitTarPath"><span class="hs-identifier hs-var">splitTarPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry -&gt; TarPath
</span><a href="Codec.Archive.Tar.Types.html#entryTarPath"><span class="hs-identifier hs-var hs-var">entryTarPath</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059189"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679059185"><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059185"><span class="hs-identifier hs-var">stbl'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059180"><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059180"><span class="hs-identifier hs-var">cids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString]
-&gt; StringTableBuilder PathComponentId
-&gt; (StringTableBuilder PathComponentId, [PathComponentId])
forall id.
Enum id =&gt;
[ByteString]
-&gt; StringTableBuilder id -&gt; (StringTableBuilder id, [id])
</span><a href="Codec.Archive.Tar.Index.StringTable.html#inserts"><span class="hs-identifier hs-var">StringTable.inserts</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059183"><span class="hs-identifier hs-var">entrypath</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059188"><span class="hs-identifier hs-var">stbl</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679059184"><span class="annot"><span class="annottext">itrie' :: IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059184"><span class="hs-identifier hs-var hs-var">itrie'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PathComponentId]
-&gt; TarEntryOffset
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
forall k v.
(Enum k, Enum v) =&gt;
[k] -&gt; v -&gt; IntTrieBuilder k v -&gt; IntTrieBuilder k v
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#insert"><span class="hs-identifier hs-var">IntTrie.insert</span></a></span><span> </span><span class="annot"><span class="annottext">[PathComponentId]
</span><a href="#local-6989586621679059180"><span class="hs-identifier hs-var">cids</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059186"><span class="hs-identifier hs-var">nextOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059187"><span class="hs-identifier hs-var">itrie</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="hs-comment">-- | Use this function if you want to skip some entries and not add them to the</span><span>
</span><span id="line-309"></span><span class="hs-comment">-- final 'TarIndex'.</span><span>
</span><span id="line-310"></span><span class="hs-comment">--</span><span>
</span><span id="line-311"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#skipNextEntry"><span class="hs-identifier hs-type">skipNextEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span>
</span><span id="line-312"></span><span id="skipNextEntry"><span class="annot"><span class="annottext">skipNextEntry :: Entry -&gt; IndexBuilder -&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#skipNextEntry"><span class="hs-identifier hs-var hs-var">skipNextEntry</span></a></span></span><span> </span><span id="local-6989586621679059177"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059177"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span id="local-6989586621679059176"><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">stbl</span></a></span></span><span> </span><span id="local-6989586621679059175"><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059175"><span class="hs-identifier hs-var">itrie</span></a></span></span><span> </span><span id="local-6989586621679059174"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059174"><span class="hs-identifier hs-var">nextOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059176"><span class="hs-identifier hs-var">stbl</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059175"><span class="hs-identifier hs-var">itrie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry -&gt; TarEntryOffset -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier hs-var">nextEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059177"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059174"><span class="hs-identifier hs-var">nextOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | Finish accumulating 'Entry' information and build the compact 'TarIndex'</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- lookup structure.</span><span>
</span><span id="line-317"></span><span class="hs-comment">--</span><span>
</span><span id="line-318"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#finalise"><span class="hs-identifier hs-type">finalise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span>
</span><span id="line-319"></span><span id="finalise"><span class="annot"><span class="annottext">finalise :: IndexBuilder -&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#finalise"><span class="hs-identifier hs-var hs-var">finalise</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span id="local-6989586621679059173"><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059173"><span class="hs-identifier hs-var">stbl</span></a></span></span><span> </span><span id="local-6989586621679059172"><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059172"><span class="hs-identifier hs-var">itrie</span></a></span></span><span> </span><span id="local-6989586621679059171"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059171"><span class="hs-identifier hs-var">finalOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">StringTable PathComponentId
-&gt; IntTrie PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-var">TarIndex</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059170"><span class="hs-identifier hs-var">pathTable</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059169"><span class="hs-identifier hs-var">pathTrie</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059171"><span class="hs-identifier hs-var">finalOffset</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>    </span><span id="local-6989586621679059170"><span class="annot"><span class="annottext">pathTable :: StringTable PathComponentId
</span><a href="#local-6989586621679059170"><span class="hs-identifier hs-var hs-var">pathTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId -&gt; StringTable PathComponentId
forall id. Enum id =&gt; StringTableBuilder id -&gt; StringTable id
</span><a href="Codec.Archive.Tar.Index.StringTable.html#finalise"><span class="hs-identifier hs-var">StringTable.finalise</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><a href="#local-6989586621679059173"><span class="hs-identifier hs-var">stbl</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621679059169"><span class="annot"><span class="annottext">pathTrie :: IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059169"><span class="hs-identifier hs-var hs-var">pathTrie</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
-&gt; IntTrie PathComponentId TarEntryOffset
forall k v. IntTrieBuilder k v -&gt; IntTrie k v
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#finalise"><span class="hs-identifier hs-var">IntTrie.finalise</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059172"><span class="hs-identifier hs-var">itrie</span></a></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#finaliseIndex"><span class="hs-identifier hs-type">finaliseIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span>
</span><span id="line-326"></span><span id="finaliseIndex"><span class="annot"><span class="annottext">finaliseIndex :: IndexBuilder -&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#finaliseIndex"><span class="hs-identifier hs-var hs-var">finaliseIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IndexBuilder -&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#finalise"><span class="hs-identifier hs-var">finalise</span></a></span><span>
</span><span id="line-327"></span><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">finaliseIndex</span><span> </span><span class="hs-pragma">&quot;Use TarIndex.finalise&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">-- | This is the offset immediately following the entry most recently added</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- to the 'IndexBuilder'. You might use this if you need to know the offsets</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- but don't want to use the 'TarIndex' lookup structure.</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- Use with 'hSeekEntryOffset'. See also 'nextEntryOffset'.</span><span>
</span><span id="line-333"></span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#indexNextEntryOffset"><span class="hs-identifier hs-type">indexNextEntryOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-335"></span><span id="indexNextEntryOffset"><span class="annot"><span class="annottext">indexNextEntryOffset :: IndexBuilder -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#indexNextEntryOffset"><span class="hs-identifier hs-var hs-var">indexNextEntryOffset</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IntTrieBuilder PathComponentId TarEntryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679059166"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059166"><span class="hs-identifier hs-var">off</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059166"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- | This is the offset immediately following the last entry in the tar file.</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- This can be useful to append further entries into the tar file.</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- Use with 'hSeekEntryOffset', or just use 'hSeekEndEntryOffset' directly.</span><span>
</span><span id="line-340"></span><span class="hs-comment">--</span><span>
</span><span id="line-341"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#indexEndEntryOffset"><span class="hs-identifier hs-type">indexEndEntryOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-342"></span><span id="indexEndEntryOffset"><span class="annot"><span class="annottext">indexEndEntryOffset :: TarIndex -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#indexEndEntryOffset"><span class="hs-identifier hs-var hs-var">indexEndEntryOffset</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679059165"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059165"><span class="hs-identifier hs-var">off</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059165"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | Calculate the 'TarEntryOffset' of the next entry, given the size and</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- offset of the current entry.</span><span>
</span><span id="line-346"></span><span class="hs-comment">--</span><span>
</span><span id="line-347"></span><span class="hs-comment">-- This is much like using 'skipNextEntry' and 'indexNextEntryOffset', but without</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- using an 'IndexBuilder'.</span><span>
</span><span id="line-349"></span><span class="hs-comment">--</span><span>
</span><span id="line-350"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier hs-type">nextEntryOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-351"></span><span id="nextEntryOffset"><span class="annot"><span class="annottext">nextEntryOffset :: Entry -&gt; TarEntryOffset -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier hs-var hs-var">nextEntryOffset</span></a></span></span><span> </span><span id="local-6989586621679059164"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621679059163"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059163"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">1</span></span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Entry -&gt; EntryContent
</span><a href="Codec.Archive.Tar.Types.html#entryContent"><span class="hs-identifier hs-var hs-var">entryContent</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059164"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#NormalFile"><span class="hs-identifier hs-type">NormalFile</span></a></span><span>     </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span>   </span><span id="local-6989586621679059159"><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059159"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; TarEntryOffset
</span><a href="#local-6989586621679059158"><span class="hs-identifier hs-var">blocks</span></a></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059159"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#OtherEntryType"><span class="hs-identifier hs-type">OtherEntryType</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679059156"><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059156"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; TarEntryOffset
</span><a href="#local-6989586621679059158"><span class="hs-identifier hs-var">blocks</span></a></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059156"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><span class="annottext">EntryContent
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-comment">-- NOTE: to avoid underflow, do the (fromIntegral :: Int64 -&gt; Word32) last</span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><a href="#local-6989586621679059158"><span class="hs-identifier hs-type">blocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621679059158"><span class="annot"><span class="annottext">blocks :: FileSize -&gt; TarEntryOffset
</span><a href="#local-6989586621679059158"><span class="hs-identifier hs-var hs-var">blocks</span></a></span></span><span> </span><span id="local-6989586621679059155"><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059155"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; TarEntryOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSize
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; FileSize -&gt; FileSize
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059155"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; FileSize -&gt; FileSize
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FileSize -&gt; FileSize -&gt; FileSize
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><span class="hs-number">512</span></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-keyword">type</span><span> </span><span id="FilePathBS"><span class="annot"><a href="Codec.Archive.Tar.Index.html#FilePathBS"><span class="hs-identifier hs-var">FilePathBS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#splitTarPath"><span class="hs-identifier hs-type">splitTarPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#TarPath"><span class="hs-identifier hs-type">TarPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#FilePathBS"><span class="hs-identifier hs-type">FilePathBS</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span id="splitTarPath"><span class="annot"><span class="annottext">splitTarPath :: TarPath -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitTarPath"><span class="hs-identifier hs-var hs-var">splitTarPath</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Types.html#TarPath"><span class="hs-identifier hs-type">TarPath</span></a></span><span> </span><span id="local-6989586621679059151"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059151"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679059150"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059150"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitDirectories"><span class="hs-identifier hs-var">splitDirectories</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059150"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitDirectories"><span class="hs-identifier hs-var">splitDirectories</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059151"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#splitDirectories"><span class="hs-identifier hs-type">splitDirectories</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#FilePathBS"><span class="hs-identifier hs-type">FilePathBS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#FilePathBS"><span class="hs-identifier hs-type">FilePathBS</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-370"></span><span id="splitDirectories"><span class="annot"><span class="annottext">splitDirectories :: ByteString -&gt; [ByteString]
</span><a href="Codec.Archive.Tar.Index.html#splitDirectories"><span class="hs-identifier hs-var hs-var">splitDirectories</span></a></span></span><span> </span><span id="local-6989586621679059149"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Char -&gt; ByteString -&gt; [ByteString]
</span><span class="hs-identifier hs-var">BS.Char8.split</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'/'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059149"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-372"></span><span>      </span><span id="local-6989586621679059147"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059147"><span class="hs-identifier hs-var">c</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679059146"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059146"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059147"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Char -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.Char8.singleton</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'/'</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Bool) -&gt; [ByteString] -&gt; [ByteString]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (ByteString -&gt; Bool) -&gt; ByteString -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059146"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-373"></span><span>      </span><span id="local-6989586621679059143"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059143"><span class="hs-identifier hs-var">cs</span></a></span></span><span>               </span><span class="hs-glyph">-&gt;</span><span>                          </span><span class="annot"><span class="annottext">(ByteString -&gt; Bool) -&gt; [ByteString] -&gt; [ByteString]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (ByteString -&gt; Bool) -&gt; ByteString -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679059143"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- Resume building an existing index</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | Resume building an existing index</span><span>
</span><span id="line-381"></span><span class="hs-comment">--</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- A 'TarIndex' is optimized for a highly compact and efficient in-memory</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- representation. This, however, makes it read-only. If you have an existing</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- 'TarIndex' for a large file, and want to add to it, you can translate the</span><span>
</span><span id="line-385"></span><span class="hs-comment">-- 'TarIndex' back to an 'IndexBuilder'. Be aware that this is a relatively</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- costly operation (linear in the size of the 'TarIndex'), though still</span><span>
</span><span id="line-387"></span><span class="hs-comment">-- faster than starting again from scratch.</span><span>
</span><span id="line-388"></span><span class="hs-comment">--</span><span>
</span><span id="line-389"></span><span class="hs-comment">-- This is the left inverse to 'finalise' (modulo ordering).</span><span>
</span><span id="line-390"></span><span class="hs-comment">--</span><span>
</span><span id="line-391"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#unfinalise"><span class="hs-identifier hs-type">unfinalise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-type">IndexBuilder</span></a></span><span>
</span><span id="line-392"></span><span id="unfinalise"><span class="annot"><span class="annottext">unfinalise :: TarIndex -&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#unfinalise"><span class="hs-identifier hs-var hs-var">unfinalise</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span id="local-6989586621679059142"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059142"><span class="hs-identifier hs-var">pathTable</span></a></span></span><span> </span><span id="local-6989586621679059141"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059141"><span class="hs-identifier hs-var">pathTrie</span></a></span></span><span> </span><span id="local-6989586621679059140"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059140"><span class="hs-identifier hs-var">finalOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><span class="annottext">StringTableBuilder PathComponentId
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; IndexBuilder
</span><a href="Codec.Archive.Tar.Index.html#IndexBuilder"><span class="hs-identifier hs-var">IndexBuilder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; StringTableBuilder PathComponentId
forall id. Enum id =&gt; StringTable id -&gt; StringTableBuilder id
</span><a href="Codec.Archive.Tar.Index.StringTable.html#unfinalise"><span class="hs-identifier hs-var">StringTable.unfinalise</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059142"><span class="hs-identifier hs-var">pathTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
-&gt; IntTrieBuilder PathComponentId TarEntryOffset
forall k v. (Enum k, Enum v) =&gt; IntTrie k v -&gt; IntTrieBuilder k v
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#unfinalise"><span class="hs-identifier hs-var">IntTrie.unfinalise</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059141"><span class="hs-identifier hs-var">pathTrie</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>                 </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059140"><span class="hs-identifier hs-var">finalOffset</span></a></span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- I/O operations</span><span>
</span><span id="line-400"></span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- | Reads an entire 'Entry' at the given 'TarEntryOffset' in the tar file.</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- The 'Handle' must be open for reading and be seekable.</span><span>
</span><span id="line-404"></span><span class="hs-comment">--</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- This reads the whole entry into memory strictly, not incrementally. For more</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- control, use 'hReadEntryHeader' and then read the entry content manually.</span><span>
</span><span id="line-407"></span><span class="hs-comment">--</span><span>
</span><span id="line-408"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntry"><span class="hs-identifier hs-type">hReadEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span>
</span><span id="line-409"></span><span id="hReadEntry"><span class="annot"><span class="annottext">hReadEntry :: Handle -&gt; TarEntryOffset -&gt; IO Entry
</span><a href="Codec.Archive.Tar.Index.html#hReadEntry"><span class="hs-identifier hs-var hs-var">hReadEntry</span></a></span></span><span> </span><span id="local-6989586621679059137"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059137"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span id="local-6989586621679059136"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059136"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621679059135"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO Entry
</span><a href="Codec.Archive.Tar.Index.html#hReadEntryHeader"><span class="hs-identifier hs-var">hReadEntryHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059137"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059136"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Entry -&gt; EntryContent
</span><a href="Codec.Archive.Tar.Types.html#entryContent"><span class="hs-identifier hs-var hs-var">entryContent</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#NormalFile"><span class="hs-identifier hs-type">NormalFile</span></a></span><span>       </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679059134"><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679059133"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059133"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Int -&gt; IO ByteString
</span><span class="hs-identifier hs-var">LBS.hGet</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059137"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSize -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>                                    </span><span class="annot"><span class="annottext">Entry -&gt; IO Entry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-414"></span><span>                                      </span><span class="annot"><span class="annottext">entryContent :: EntryContent
</span><a href="Codec.Archive.Tar.Types.html#entryContent"><span class="hs-identifier hs-var">entryContent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; FileSize -&gt; EntryContent
</span><a href="Codec.Archive.Tar.Types.html#NormalFile"><span class="hs-identifier hs-var">NormalFile</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059133"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059134"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-415"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#OtherEntryType"><span class="hs-identifier hs-type">OtherEntryType</span></a></span><span> </span><span id="local-6989586621679059131"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679059131"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679059130"><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059130"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679059129"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059129"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Int -&gt; IO ByteString
</span><span class="hs-identifier hs-var">LBS.hGet</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059137"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSize -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>                                    </span><span class="annot"><span class="annottext">Entry -&gt; IO Entry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-418"></span><span>                                      </span><span class="annot"><span class="annottext">entryContent :: EntryContent
</span><a href="Codec.Archive.Tar.Types.html#entryContent"><span class="hs-identifier hs-var">entryContent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; ByteString -&gt; FileSize -&gt; EntryContent
</span><a href="Codec.Archive.Tar.Types.html#OtherEntryType"><span class="hs-identifier hs-var">OtherEntryType</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679059131"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059129"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">FileSize
</span><a href="#local-6989586621679059130"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-419"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-420"></span><span>      </span><span class="annot"><span class="annottext">EntryContent
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Entry -&gt; IO Entry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059135"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span class="hs-comment">-- | Read the header for a 'Entry' at the given 'TarEntryOffset' in the tar</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- file. The 'entryContent' will contain the correct metadata but an empty file</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- content. The 'Handle' must be open for reading and be seekable.</span><span>
</span><span id="line-425"></span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- The 'Handle' position is advanced to the beginning of the entry content (if</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- any). You must check the 'entryContent' to see if the entry is of type</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- 'NormalFile'. If it is, the 'NormalFile' gives the content length and you</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- are free to read this much data from the 'Handle'.</span><span>
</span><span id="line-430"></span><span class="hs-comment">--</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- &gt; entry &lt;- Tar.hReadEntryHeader hnd</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- &gt; case Tar.entryContent entry of</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- &gt;   Tar.NormalFile _ size -&gt; do content &lt;- BS.hGet hnd size</span><span>
</span><span id="line-434"></span><span class="hs-comment">-- &gt;                               ...</span><span>
</span><span id="line-435"></span><span class="hs-comment">--</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- Of course you don't have to read it all in one go (as 'hReadEntry' does),</span><span>
</span><span id="line-437"></span><span class="hs-comment">-- you can use any appropriate method to read it incrementally.</span><span>
</span><span id="line-438"></span><span class="hs-comment">--</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- In addition to I\/O errors, this can throw a 'FormatError' if the offset is</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- wrong, or if the file is not valid tar format.</span><span>
</span><span id="line-441"></span><span class="hs-comment">--</span><span>
</span><span id="line-442"></span><span class="hs-comment">-- There is also the lower level operation 'hSeekEntryOffset'.</span><span>
</span><span id="line-443"></span><span class="hs-comment">--</span><span>
</span><span id="line-444"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntryHeader"><span class="hs-identifier hs-type">hReadEntryHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span>
</span><span id="line-445"></span><span id="hReadEntryHeader"><span class="annot"><span class="annottext">hReadEntryHeader :: Handle -&gt; TarEntryOffset -&gt; IO Entry
</span><a href="Codec.Archive.Tar.Index.html#hReadEntryHeader"><span class="hs-identifier hs-var hs-var">hReadEntryHeader</span></a></span></span><span> </span><span id="local-6989586621679059128"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059128"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span id="local-6989586621679059127"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059127"><span class="hs-identifier hs-var">blockOff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-446"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var">hSeekEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059128"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059127"><span class="hs-identifier hs-var">blockOff</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span id="local-6989586621679059126"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059126"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Int -&gt; IO ByteString
</span><span class="hs-identifier hs-var">LBS.hGet</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059128"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">512</span></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Entries FormatError
</span><a href="Codec.Archive.Tar.Read.html#read"><span class="hs-identifier hs-var">Tar.read</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059126"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-449"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Next"><span class="hs-identifier hs-type">Tar.Next</span></a></span><span> </span><span id="local-6989586621679059124"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059124"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="annot"><span class="annottext">Entries FormatError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Entry -&gt; IO Entry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059124"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Fail"><span class="hs-identifier hs-type">Tar.Fail</span></a></span><span> </span><span id="local-6989586621679059123"><span class="annot"><span class="annottext">FormatError
</span><a href="#local-6989586621679059123"><span class="hs-identifier hs-var">e</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FormatError -&gt; IO Entry
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">FormatError
</span><a href="#local-6989586621679059123"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-451"></span><span>      </span><span class="annot"><span class="annottext">Entries FormatError
</span><a href="Codec.Archive.Tar.Types.html#Done"><span class="hs-identifier hs-var">Tar.Done</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Entry
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hReadEntryHeader: impossible&quot;</span></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-comment">-- | Set the 'Handle' position to the position corresponding to the given</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- 'TarEntryOffset'.</span><span>
</span><span id="line-455"></span><span class="hs-comment">--</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- This position is where the entry metadata can be read. If you already know</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- the entry has a body (and perhaps know it's length), you may wish to seek to</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- the body content directly using 'hSeekEntryContentOffset'.</span><span>
</span><span id="line-459"></span><span class="hs-comment">--</span><span>
</span><span id="line-460"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-type">hSeekEntryOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span id="hSeekEntryOffset"><span class="annot"><span class="annottext">hSeekEntryOffset :: Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var hs-var">hSeekEntryOffset</span></a></span></span><span> </span><span id="local-6989586621679059122"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059122"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span id="local-6989586621679059121"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059121"><span class="hs-identifier hs-var">blockOff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; SeekMode -&gt; Integer -&gt; IO ()
</span><span class="hs-identifier hs-var">hSeek</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059122"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">SeekMode
</span><span class="hs-identifier hs-var">AbsoluteSeek</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059121"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">512</span></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="hs-comment">-- | Set the 'Handle' position to the entry content position corresponding to</span><span>
</span><span id="line-465"></span><span class="hs-comment">-- the given 'TarEntryOffset'.</span><span>
</span><span id="line-466"></span><span class="hs-comment">--</span><span>
</span><span id="line-467"></span><span class="hs-comment">-- This position is where the entry content can be read using ordinary I\/O</span><span>
</span><span id="line-468"></span><span class="hs-comment">-- operations (though you have to know in advance how big the entry content</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- is). This is /only valid/ if you /already know/ the entry has a body (i.e.</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- is a normal file).</span><span>
</span><span id="line-471"></span><span class="hs-comment">--</span><span>
</span><span id="line-472"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEntryContentOffset"><span class="hs-identifier hs-type">hSeekEntryContentOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span id="hSeekEntryContentOffset"><span class="annot"><span class="annottext">hSeekEntryContentOffset :: Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryContentOffset"><span class="hs-identifier hs-var hs-var">hSeekEntryContentOffset</span></a></span></span><span> </span><span id="local-6989586621679059117"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059117"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span id="local-6989586621679059116"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059116"><span class="hs-identifier hs-var">blockOff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var">hSeekEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059117"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059116"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span class="hs-comment">-- | This is a low level variant on 'hReadEntryHeader', that can be used to</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- iterate through a tar file, entry by entry.</span><span>
</span><span id="line-478"></span><span class="hs-comment">--</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- It has a few differences compared to 'hReadEntryHeader':</span><span>
</span><span id="line-480"></span><span class="hs-comment">--</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- * It returns an indication when the end of the tar file is reached.</span><span>
</span><span id="line-482"></span><span class="hs-comment">--</span><span>
</span><span id="line-483"></span><span class="hs-comment">-- * It /does not/ move the 'Handle' position to the beginning of the entry</span><span>
</span><span id="line-484"></span><span class="hs-comment">--   content.</span><span>
</span><span id="line-485"></span><span class="hs-comment">--</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- * It returns the 'TarEntryOffset' of the next entry.</span><span>
</span><span id="line-487"></span><span class="hs-comment">--</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- After this action, the 'Handle' position is not in any useful place. If</span><span>
</span><span id="line-489"></span><span class="hs-comment">-- you want to skip to the next entry, take the 'TarEntryOffset' returned and</span><span>
</span><span id="line-490"></span><span class="hs-comment">-- use 'hReadEntryHeaderOrEof' again. Or if having inspected the 'Entry'</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- header you want to read the entry content (if it has one) then use</span><span>
</span><span id="line-492"></span><span class="hs-comment">-- 'hSeekEntryContentOffset' on the original input 'TarEntryOffset'.</span><span>
</span><span id="line-493"></span><span class="hs-comment">--</span><span>
</span><span id="line-494"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hReadEntryHeaderOrEof"><span class="hs-identifier hs-type">hReadEntryHeaderOrEof</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-495"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span id="hReadEntryHeaderOrEof"><span class="annot"><span class="annottext">hReadEntryHeaderOrEof :: Handle -&gt; TarEntryOffset -&gt; IO (Maybe (Entry, TarEntryOffset))
</span><a href="Codec.Archive.Tar.Index.html#hReadEntryHeaderOrEof"><span class="hs-identifier hs-var hs-var">hReadEntryHeaderOrEof</span></a></span></span><span> </span><span id="local-6989586621679059115"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059115"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span id="local-6989586621679059114"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059114"><span class="hs-identifier hs-var">blockOff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var">hSeekEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059115"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059114"><span class="hs-identifier hs-var">blockOff</span></a></span><span>
</span><span id="line-498"></span><span>    </span><span id="local-6989586621679059113"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059113"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; Int -&gt; IO ByteString
</span><span class="hs-identifier hs-var">LBS.hGet</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059115"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Entries FormatError
</span><a href="Codec.Archive.Tar.Read.html#read"><span class="hs-identifier hs-var">Tar.read</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059113"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-500"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Next"><span class="hs-identifier hs-type">Tar.Next</span></a></span><span> </span><span id="local-6989586621679059112"><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="annot"><span class="annottext">Entries FormatError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679059111"><span class="annot"><span class="annottext">blockOff' :: TarEntryOffset
</span><a href="#local-6989586621679059111"><span class="hs-identifier hs-var hs-var">blockOff'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry -&gt; TarEntryOffset -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#nextEntryOffset"><span class="hs-identifier hs-var">nextEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059114"><span class="hs-identifier hs-var">blockOff</span></a></span><span>
</span><span id="line-501"></span><span>                           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset) -&gt; IO (Maybe (Entry, TarEntryOffset))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Entry, TarEntryOffset) -&gt; Maybe (Entry, TarEntryOffset)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry
</span><a href="#local-6989586621679059112"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059111"><span class="hs-identifier hs-var">blockOff'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>      </span><span class="annot"><span class="annottext">Entries FormatError
</span><a href="Codec.Archive.Tar.Types.html#Done"><span class="hs-identifier hs-var">Tar.Done</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset) -&gt; IO (Maybe (Entry, TarEntryOffset))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-503"></span><span>      </span><span class="annot"><a href="Codec.Archive.Tar.Types.html#Fail"><span class="hs-identifier hs-type">Tar.Fail</span></a></span><span> </span><span id="local-6989586621679059110"><span class="annot"><span class="annottext">FormatError
</span><a href="#local-6989586621679059110"><span class="hs-identifier hs-var">e</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FormatError -&gt; IO (Maybe (Entry, TarEntryOffset))
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">FormatError
</span><a href="#local-6989586621679059110"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-comment">-- | Seek to the end of a tar file, to the position where new entries can</span><span>
</span><span id="line-506"></span><span class="hs-comment">-- be appended, and return that 'TarEntryOffset'.</span><span>
</span><span id="line-507"></span><span class="hs-comment">--</span><span>
</span><span id="line-508"></span><span class="hs-comment">-- If you have a valid 'TarIndex' for this tar file then you should supply it</span><span>
</span><span id="line-509"></span><span class="hs-comment">-- because it allows seeking directly to the correct location.</span><span>
</span><span id="line-510"></span><span class="hs-comment">--</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- If you do not have an index, then this becomes an expensive linear</span><span>
</span><span id="line-512"></span><span class="hs-comment">-- operation because we have to read each tar entry header from the beginning</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- to find the location immediately after the last entry (this is because tar</span><span>
</span><span id="line-514"></span><span class="hs-comment">-- files have a variable length trailer and we cannot reliably find that by</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- starting at the end). In this mode, it will fail with an exception if the</span><span>
</span><span id="line-516"></span><span class="hs-comment">-- file is not in fact in the tar format.</span><span>
</span><span id="line-517"></span><span class="hs-comment">--</span><span>
</span><span id="line-518"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEndEntryOffset"><span class="hs-identifier hs-type">hSeekEndEntryOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarEntryOffset"><span class="hs-identifier hs-type">TarEntryOffset</span></a></span><span>
</span><span id="line-519"></span><span id="hSeekEndEntryOffset"><span class="annot"><span class="annottext">hSeekEndEntryOffset :: Handle -&gt; Maybe TarIndex -&gt; IO TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#hSeekEndEntryOffset"><span class="hs-identifier hs-var hs-var">hSeekEndEntryOffset</span></a></span></span><span> </span><span id="local-6989586621679059109"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059109"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679059108"><span class="annot"><span class="annottext">TarIndex
</span><a href="#local-6989586621679059108"><span class="hs-identifier hs-var">index</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059107"><span class="annot"><span class="annottext">offset :: TarEntryOffset
</span><a href="#local-6989586621679059107"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TarIndex -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#indexEndEntryOffset"><span class="hs-identifier hs-var">indexEndEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TarIndex
</span><a href="#local-6989586621679059108"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var">hSeekEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059109"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059107"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; IO TarEntryOffset
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059107"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#hSeekEndEntryOffset"><span class="hs-identifier hs-var">hSeekEndEntryOffset</span></a></span><span> </span><span id="local-6989586621679059106"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059106"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe TarIndex
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-525"></span><span>    </span><span id="local-6989586621679059105"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679059105"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO Integer
</span><span class="hs-identifier hs-var">hFileSize</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059106"><span class="hs-identifier hs-var">hnd</span></a></span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679059105"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; IO TarEntryOffset
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-528"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; IO TarEntryOffset
</span><a href="#local-6989586621679059103"><span class="hs-identifier hs-var">seekToEnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-530"></span><span>    </span><span id="local-6989586621679059103"><span class="annot"><span class="annottext">seekToEnd :: TarEntryOffset -&gt; IO TarEntryOffset
</span><a href="#local-6989586621679059103"><span class="hs-identifier hs-var hs-var">seekToEnd</span></a></span></span><span> </span><span id="local-6989586621679059102"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059102"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>      </span><span id="local-6989586621679059101"><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset)
</span><a href="#local-6989586621679059101"><span class="hs-identifier hs-var">mbe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO (Maybe (Entry, TarEntryOffset))
</span><a href="Codec.Archive.Tar.Index.html#hReadEntryHeaderOrEof"><span class="hs-identifier hs-var">hReadEntryHeaderOrEof</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059106"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059102"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-532"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset)
</span><a href="#local-6989586621679059101"><span class="hs-identifier hs-var">mbe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Entry, TarEntryOffset)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; TarEntryOffset -&gt; IO ()
</span><a href="Codec.Archive.Tar.Index.html#hSeekEntryOffset"><span class="hs-identifier hs-var">hSeekEntryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679059106"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059102"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-534"></span><span>                      </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; IO TarEntryOffset
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059102"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059100"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059100"><span class="hs-identifier hs-var">offset'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; IO TarEntryOffset
</span><a href="#local-6989586621679059103"><span class="hs-identifier hs-var">seekToEnd</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059100"><span class="hs-identifier hs-var">offset'</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- (de)serialisation</span><span>
</span><span id="line-539"></span><span class="hs-comment">--</span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span class="hs-comment">-- | The 'TarIndex' is compact in memory, and it has a similarly compact</span><span>
</span><span id="line-542"></span><span class="hs-comment">-- external representation.</span><span>
</span><span id="line-543"></span><span class="hs-comment">--</span><span>
</span><span id="line-544"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#serialise"><span class="hs-identifier hs-type">serialise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-545"></span><span id="serialise"><span class="annot"><span class="annottext">serialise :: TarIndex -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.html#serialise"><span class="hs-identifier hs-var hs-var">serialise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.html#toStrict"><span class="hs-identifier hs-var">toStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (TarIndex -&gt; ByteString) -&gt; TarIndex -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TarIndex -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.html#serialiseLBS"><span class="hs-identifier hs-var">serialiseLBS</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="hs-comment">-- we keep this version around just so we can check we got the size right.</span><span>
</span><span id="line-548"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#serialiseLBS"><span class="hs-identifier hs-type">serialiseLBS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span>
</span><span id="line-549"></span><span id="serialiseLBS"><span class="annot"><span class="annottext">serialiseLBS :: TarIndex -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.html#serialiseLBS"><span class="hs-identifier hs-var hs-var">serialiseLBS</span></a></span></span><span> </span><span id="local-6989586621679059097"><span class="annot"><span class="annottext">TarIndex
</span><a href="#local-6989586621679059097"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><span class="annottext">AllocationStrategy -&gt; ByteString -&gt; Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.toLazyByteStringWith</span></span><span>
</span><span id="line-551"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; AllocationStrategy
</span><span class="hs-identifier hs-var">BS.untrimmedStrategy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TarIndex -&gt; Int
</span><a href="Codec.Archive.Tar.Index.html#serialiseSize"><span class="hs-identifier hs-var">serialiseSize</span></a></span><span> </span><span class="annot"><span class="annottext">TarIndex
</span><a href="#local-6989586621679059097"><span class="hs-identifier hs-var">index</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">512</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">LBS.empty</span></span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TarIndex -&gt; Builder
</span><a href="Codec.Archive.Tar.Index.html#serialiseBuilder"><span class="hs-identifier hs-var">serialiseBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">TarIndex
</span><a href="#local-6989586621679059097"><span class="hs-identifier hs-var">index</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#serialiseSize"><span class="hs-identifier hs-type">serialiseSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-555"></span><span id="serialiseSize"><span class="annot"><span class="annottext">serialiseSize :: TarIndex -&gt; Int
</span><a href="Codec.Archive.Tar.Index.html#serialiseSize"><span class="hs-identifier hs-var hs-var">serialiseSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span id="local-6989586621679059093"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059093"><span class="hs-identifier hs-var">stringTable</span></a></span></span><span> </span><span id="local-6989586621679059092"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059092"><span class="hs-identifier hs-var">intTrie</span></a></span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; Int
forall id. StringTable id -&gt; Int
</span><a href="Codec.Archive.Tar.Index.StringTable.html#serialiseSize"><span class="hs-identifier hs-var">StringTable.serialiseSize</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059093"><span class="hs-identifier hs-var">stringTable</span></a></span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset -&gt; Int
forall k v. IntTrie k v -&gt; Int
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#serialiseSize"><span class="hs-identifier hs-var">IntTrie.serialiseSize</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059092"><span class="hs-identifier hs-var">intTrie</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#serialiseBuilder"><span class="hs-identifier hs-type">serialiseBuilder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.Builder</span></span><span>
</span><span id="line-561"></span><span id="serialiseBuilder"><span class="annot"><span class="annottext">serialiseBuilder :: TarIndex -&gt; Builder
</span><a href="Codec.Archive.Tar.Index.html#serialiseBuilder"><span class="hs-identifier hs-var hs-var">serialiseBuilder</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span> </span><span id="local-6989586621679059089"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059089"><span class="hs-identifier hs-var">stringTable</span></a></span></span><span> </span><span id="local-6989586621679059088"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059088"><span class="hs-identifier hs-var">intTrie</span></a></span></span><span> </span><span id="local-6989586621679059087"><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059087"><span class="hs-identifier hs-var">finalOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-562"></span><span>     </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Builder
</span><span class="hs-identifier hs-var">BS.word32BE</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">2</span></span><span> </span><span class="hs-comment">-- format version</span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Builder
</span><span class="hs-identifier hs-var">BS.word32BE</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059087"><span class="hs-identifier hs-var">finalOffset</span></a></span><span>
</span><span id="line-564"></span><span>  </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId -&gt; Builder
forall id. StringTable id -&gt; Builder
</span><a href="Codec.Archive.Tar.Index.StringTable.html#serialise"><span class="hs-identifier hs-var">StringTable.serialise</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059089"><span class="hs-identifier hs-var">stringTable</span></a></span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset -&gt; Builder
forall k v. IntTrie k v -&gt; Builder
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#serialise"><span class="hs-identifier hs-var">IntTrie.serialise</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059088"><span class="hs-identifier hs-var">intTrie</span></a></span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span class="hs-comment">-- | Read the external representation back into a 'TarIndex'.</span><span>
</span><span id="line-568"></span><span class="hs-comment">--</span><span>
</span><span id="line-569"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#deserialise"><span class="hs-identifier hs-type">deserialise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-type">TarIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span id="deserialise"><span class="annot"><span class="annottext">deserialise :: ByteString -&gt; Maybe (TarIndex, ByteString)
</span><a href="Codec.Archive.Tar.Index.html#deserialise"><span class="hs-identifier hs-var hs-var">deserialise</span></a></span></span><span> </span><span id="local-6989586621679059083"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TarIndex, ByteString)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059080"><span class="annot"><span class="annottext">ver :: TarEntryOffset
</span><a href="#local-6989586621679059080"><span class="hs-identifier hs-var hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059080"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">1</span></span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679059078"><span class="annot"><span class="annottext">finalOffset :: TarEntryOffset
</span><a href="#local-6989586621679059078"><span class="hs-identifier hs-var hs-var">finalOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-577"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679059077"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059077"><span class="hs-identifier hs-var">stringTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059076"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059076"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (StringTable PathComponentId, ByteString)
forall id. ByteString -&gt; Maybe (StringTable id, ByteString)
</span><a href="Codec.Archive.Tar.Index.StringTable.html#deserialiseV1"><span class="hs-identifier hs-var">StringTable.deserialiseV1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679059073"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059073"><span class="hs-identifier hs-var">intTrie</span></a></span></span><span class="hs-special">,</span><span>     </span><span id="local-6989586621679059072"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059072"><span class="hs-identifier hs-var">bs''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Maybe (IntTrie PathComponentId TarEntryOffset, ByteString)
forall k v. ByteString -&gt; Maybe (IntTrie k v, ByteString)
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#deserialise"><span class="hs-identifier hs-var">IntTrie.deserialise</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059076"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-579"></span><span>       </span><span class="annot"><span class="annottext">(TarIndex, ByteString) -&gt; Maybe (TarIndex, ByteString)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StringTable PathComponentId
-&gt; IntTrie PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-var">TarIndex</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059077"><span class="hs-identifier hs-var">stringTable</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059073"><span class="hs-identifier hs-var">intTrie</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059078"><span class="hs-identifier hs-var">finalOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059072"><span class="hs-identifier hs-var">bs''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679059070"><span class="annot"><span class="annottext">ver :: TarEntryOffset
</span><a href="#local-6989586621679059070"><span class="hs-identifier hs-var hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059070"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><span class="hs-number">2</span></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679059069"><span class="annot"><span class="annottext">finalOffset :: TarEntryOffset
</span><a href="#local-6989586621679059069"><span class="hs-identifier hs-var hs-var">finalOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-584"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679059068"><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059068"><span class="hs-identifier hs-var">stringTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679059067"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059067"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (StringTable PathComponentId, ByteString)
forall id. ByteString -&gt; Maybe (StringTable id, ByteString)
</span><a href="Codec.Archive.Tar.Index.StringTable.html#deserialiseV2"><span class="hs-identifier hs-var">StringTable.deserialiseV2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059083"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679059065"><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059065"><span class="hs-identifier hs-var">intTrie</span></a></span></span><span class="hs-special">,</span><span>     </span><span id="local-6989586621679059064"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059064"><span class="hs-identifier hs-var">bs''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Maybe (IntTrie PathComponentId TarEntryOffset, ByteString)
forall k v. ByteString -&gt; Maybe (IntTrie k v, ByteString)
</span><a href="Codec.Archive.Tar.Index.IntTrie.html#deserialise"><span class="hs-identifier hs-var">IntTrie.deserialise</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059067"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-586"></span><span>       </span><span class="annot"><span class="annottext">(TarIndex, ByteString) -&gt; Maybe (TarIndex, ByteString)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StringTable PathComponentId
-&gt; IntTrie PathComponentId TarEntryOffset
-&gt; TarEntryOffset
-&gt; TarIndex
</span><a href="Codec.Archive.Tar.Index.html#TarIndex"><span class="hs-identifier hs-var">TarIndex</span></a></span><span> </span><span class="annot"><span class="annottext">StringTable PathComponentId
</span><a href="#local-6989586621679059068"><span class="hs-identifier hs-var">stringTable</span></a></span><span> </span><span class="annot"><span class="annottext">IntTrie PathComponentId TarEntryOffset
</span><a href="#local-6989586621679059065"><span class="hs-identifier hs-var">intTrie</span></a></span><span> </span><span class="annot"><span class="annottext">TarEntryOffset
</span><a href="#local-6989586621679059069"><span class="hs-identifier hs-var">finalOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059064"><span class="hs-identifier hs-var">bs''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TarIndex, ByteString)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-type">readWord32BE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-591"></span><span id="readWord32BE"><span class="annot"><span class="annottext">readWord32BE :: ByteString -&gt; Int -&gt; TarEntryOffset
</span><a href="Codec.Archive.Tar.Index.html#readWord32BE"><span class="hs-identifier hs-var hs-var">readWord32BE</span></a></span></span><span> </span><span id="local-6989586621679059063"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679059062"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-592"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TarEntryOffset -&gt; TarEntryOffset)
-&gt; TarEntryOffset -&gt; TarEntryOffset
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-593"></span><span>    </span><span class="annot"><span class="annottext">Word8 -&gt; TarEntryOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Int -&gt; TarEntryOffset
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">24</span></span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; TarEntryOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Int -&gt; TarEntryOffset
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span>
</span><span id="line-595"></span><span>  </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; TarEntryOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; Int -&gt; TarEntryOffset
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-596"></span><span>  </span><span class="annot"><span class="annottext">TarEntryOffset -&gt; TarEntryOffset -&gt; TarEntryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; TarEntryOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679059063"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679059062"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- Test properties</span><span>
</span><span id="line-601"></span><span class="hs-comment">--</span><span class="hs-cpp">

#ifdef TESTS
</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- Not quite the properties of a finite mapping because we also have lookups</span><span>
</span><span id="line-606"></span><span class="hs-comment">-- that result in completions.</span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span class="hs-identifier">prop_lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-609"></span><span class="hs-identifier">prop_lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-identifier">p</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lookup</span><span> </span><span class="hs-identifier">index</span><span> </span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Prelude.lookup</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">Nothing</span><span class="hs-special">,</span><span>                    </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">TarFileEntry</span><span> </span><span class="hs-identifier">offset</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">offset'</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">offset</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">offset'</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">TarDir</span><span> </span><span class="hs-identifier">entries</span><span class="hs-special">)</span><span class="hs-special">,</span><span>      </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">sort</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nub</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">fst</span><span> </span><span class="hs-identifier">entries</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>                                                   </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">sort</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nub</span><span> </span><span class="hs-identifier">completions</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>    </span><span class="hs-identifier">_</span><span>                                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>
</span><span id="line-616"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-identifier">index</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-identifier">completions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">FilePath.splitDirectories</span><span> </span><span class="hs-identifier">completion</span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-620"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">completion</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">maybeToList</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">stripPrefix</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;/&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span class="hs-identifier">prop_toList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-623"></span><span class="hs-identifier">prop_toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-identifier">sort</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toList</span><span> </span><span class="hs-identifier">index</span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">sort</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">off</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_sz</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">off</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-identifier">index</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-628"></span><span>
</span><span id="line-629"></span><span class="hs-identifier">prop_valid</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-630"></span><span class="hs-identifier">prop_valid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">StringTable.prop_valid</span><span>   </span><span class="hs-identifier">pathbits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;TarIndex: bad string table&quot;</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">IntTrie.prop_lookup</span><span>      </span><span class="hs-identifier">intpaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;TarIndex: bad int trie&quot;</span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">IntTrie.prop_completions</span><span> </span><span class="hs-identifier">intpaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;TarIndex: bad int trie&quot;</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">prop'</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-string">&quot;TarIndex: bad prop&quot;</span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-identifier">index</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">TarIndex</span><span> </span><span class="hs-identifier">pathTable</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span>    </span><span class="hs-identifier">pathbits</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">BS.Char8.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">FilePath.splitDirectories</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>                         </span><span class="hs-identifier">paths</span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-identifier">intpaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cids</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">offset</span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_size</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">offset</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-644"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">cids</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toComponentIds</span><span> </span><span class="hs-identifier">pathTable</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-identifier">prop'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flip</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">file</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_size</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">offset</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-646"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">lookup</span><span> </span><span class="hs-identifier">index</span><span> </span><span class="hs-identifier">file</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-647"></span><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">TarFileEntry</span><span> </span><span class="hs-identifier">offset'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">offset'</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">offset</span><span>
</span><span id="line-648"></span><span>        </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span class="hs-identifier">prop_serialise_deserialise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-651"></span><span class="hs-identifier">prop_serialise_deserialise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">index</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">BS.empty</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">deserialise</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">serialise</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">index</span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-654"></span><span>    </span><span class="hs-identifier">index</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span class="hs-identifier">prop_serialiseSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-657"></span><span class="hs-identifier">prop_serialiseSize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">LBS.toChunks</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">serialiseLBS</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">index</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-659"></span><span>      </span><span class="hs-special">[</span><span class="hs-identifier">c1</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">BS.length</span><span> </span><span class="hs-identifier">c1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">serialiseSize</span><span> </span><span class="hs-identifier">index</span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-662"></span><span>    </span><span class="hs-identifier">index</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><span id="line-663"></span><span>
</span><span id="line-664"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-identifier">FilePath</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier">Show</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Arbitrary</span><span> </span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NonEmptyFilePath</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">FilePath.joinPath</span><span>
</span><span id="line-668"></span><span>                </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">listOf1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">elements</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;b&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;c&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;d&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Int64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TarEntryOffset</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier">Show</span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Arbitrary</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>      </span><span class="hs-identifier">paths</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">listOf</span><span> </span><span class="hs-identifier">arbitraryPath</span><span>
</span><span id="line-675"></span><span>      </span><span class="hs-identifier">sizes</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">vectorOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getNonNegative</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">arbitrary</span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">offsets</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">scanl</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">o</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">o</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">blocks</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">sizes</span><span>
</span><span id="line-677"></span><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">zip</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">zip</span><span> </span><span class="hs-identifier">sizes</span><span> </span><span class="hs-identifier">offsets</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-identifier">arbitraryPath</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">FilePath.joinPath</span><span>
</span><span id="line-680"></span><span>                         </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">listOf1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">elements</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;b&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;c&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;d&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-glyph">:</span><span class="hs-identifier">ks</span><span class="hs-special">)</span><span>
</span><span id="line-683"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">isPrefixOfOther</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ks</span><span>
</span><span id="line-684"></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-identifier">ks</span><span>
</span><span id="line-685"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-identifier">ks</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span>      </span><span class="hs-identifier">isPrefixOfOther</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">a</span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span>      </span><span class="hs-identifier">blocks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TarEntryOffset</span><span>
</span><span id="line-690"></span><span>      </span><span class="hs-identifier">blocks</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">512</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span class="hs-comment">-- Helper for bulk construction.</span><span>
</span><span id="line-693"></span><span class="hs-identifier">construct</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Int64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TarEntryOffset</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TarIndex</span><span>
</span><span id="line-694"></span><span class="hs-identifier">construct</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-695"></span><span>    </span><span class="hs-identifier">either</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">undefined</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">id</span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">build</span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">path</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">size</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_off</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">es</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Next</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-identifier">size</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">es</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Done</span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span class="hs-identifier">example0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Entries</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span class="hs-identifier">example0</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-701"></span><span>         </span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-string">&quot;foo-1.0/foo-1.0.cabal&quot;</span><span> </span><span class="hs-number">1500</span><span> </span><span class="hs-comment">-- at block 0</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-special">`</span><span class="hs-identifier">Next</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-string">&quot;foo-1.0/LICENSE&quot;</span><span>       </span><span class="hs-number">2000</span><span> </span><span class="hs-comment">-- at block 4</span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-special">`</span><span class="hs-identifier">Next</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-string">&quot;foo-1.0/Data/Foo.hs&quot;</span><span>   </span><span class="hs-number">1000</span><span> </span><span class="hs-comment">-- at block 9</span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-special">`</span><span class="hs-identifier">Next</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">Done</span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span class="hs-identifier">example1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Entries</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span class="hs-identifier">example1</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-identifier">Next</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-string">&quot;./&quot;</span><span> </span><span class="hs-number">1500</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Done</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">example0</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Entry</span><span>
</span><span id="line-711"></span><span class="hs-identifier">testEntry</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">simpleEntry</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">NormalFile</span><span> </span><span class="hs-identifier">mempty</span><span> </span><span class="hs-identifier">size</span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-identifier">Right</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toTarPath</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-identifier">name</span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span class="hs-comment">-- | Simple tar archive containing regular files only</span><span>
</span><span id="line-716"></span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-717"></span><span>    </span><span class="hs-identifier">simpleTarEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Tar.Entries</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">simpleTarRaw</span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">LBS.ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">simpleTarBS</span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">LBS.ByteString</span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-identifier">show</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">simpleTarRaw</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span class="hs-identifier">prop_index_matches_tar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Property</span><span>
</span><span id="line-726"></span><span class="hs-identifier">prop_index_matches_tar</span><span> </span><span class="hs-identifier">sta</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-identifier">ioProperty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">try</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">either</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">SomeException</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>                                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">True</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-732"></span><span>      </span><span class="hs-identifier">h</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">HBS.readHandle</span><span> </span><span class="hs-identifier">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">simpleTarBS</span><span> </span><span class="hs-identifier">sta</span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span>      </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">simpleTarEntries</span><span> </span><span class="hs-identifier">sta</span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TarEntryOffset</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Tar.Entries</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>    </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">Tar.Done</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-737"></span><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span>    </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Tar.Fail</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-739"></span><span>      </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Fail entry in SimpleTarArchive&quot;</span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>    </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-identifier">offset</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Tar.Next</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-identifier">es</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-741"></span><span>      </span><span class="hs-identifier">goEntry</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-identifier">offset</span><span> </span><span class="hs-identifier">e</span><span>
</span><span id="line-742"></span><span>      </span><span class="hs-identifier">goEntries</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextEntryOffset</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-identifier">offset</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">es</span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span>    </span><span class="hs-identifier">goEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TarEntryOffset</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Tar.Entry</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-identifier">goEntry</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-identifier">offset</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-746"></span><span>      </span><span class="hs-identifier">e'</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hReadEntry</span><span> </span><span class="hs-identifier">h</span><span> </span><span class="hs-identifier">offset</span><span>
</span><span id="line-747"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Tar.entryContent</span><span> </span><span class="hs-identifier">e</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Tar.entryContent</span><span> </span><span class="hs-identifier">e'</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-748"></span><span>        </span><span class="hs-special">(</span><span class="hs-identifier">Tar.NormalFile</span><span> </span><span class="hs-identifier">bs</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Tar.NormalFile</span><span> </span><span class="hs-identifier">bs'</span><span> </span><span class="hs-identifier">sz'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-749"></span><span>          </span><span class="hs-identifier">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sz</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">sz'</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">bs</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">bs'</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-750"></span><span>            </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Entry mismatch&quot;</span><span>
</span><span id="line-751"></span><span>        </span><span class="hs-identifier">_otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-752"></span><span>          </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;unexpected entry types&quot;</span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Arbitrary</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-756"></span><span>      </span><span class="hs-identifier">numEntries</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sized</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">choose</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n</span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>      </span><span class="hs-identifier">rawEntries</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkRaw</span><span> </span><span class="hs-identifier">numEntries</span><span>
</span><span id="line-758"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">entries</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mkList</span><span> </span><span class="hs-identifier">rawEntries</span><span>
</span><span id="line-759"></span><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">SimpleTarArchive</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-760"></span><span>          </span><span class="hs-identifier">simpleTarEntries</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mkEntries</span><span> </span><span class="hs-identifier">entries</span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">simpleTarRaw</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rawEntries</span><span>
</span><span id="line-762"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">simpleTarBS</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Tar.write</span><span> </span><span class="hs-identifier">entries</span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-764"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>      </span><span class="hs-identifier">mkRaw</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Gen</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">LBS.ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-766"></span><span>      </span><span class="hs-identifier">mkRaw</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-identifier">mkRaw</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-768"></span><span>         </span><span class="hs-comment">-- Pick a size around 0, 1, or 2 block boundaries</span><span>
</span><span id="line-769"></span><span>         </span><span class="hs-identifier">sz</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sized</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">elements</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">take</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-identifier">fileSizes</span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>         </span><span class="hs-identifier">bs</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">LBS.pack</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">vectorOf</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-identifier">arbitrary</span><span>
</span><span id="line-771"></span><span>         </span><span class="hs-identifier">es</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkRaw</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>         </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;file&quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">n</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">es</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>      </span><span class="hs-identifier">mkList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">LBS.ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Tar.Entry</span><span class="hs-special">]</span><span>
</span><span id="line-775"></span><span>      </span><span class="hs-identifier">mkList</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-776"></span><span>      </span><span class="hs-identifier">mkList</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">fp</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">es</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">entry</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">mkList</span><span> </span><span class="hs-identifier">es</span><span>
</span><span id="line-777"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-778"></span><span>          </span><span class="hs-identifier">Right</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toTarPath</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-identifier">fp</span><span>
</span><span id="line-779"></span><span>          </span><span class="hs-identifier">entry</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">simpleEntry</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-identifier">content</span><span>
</span><span id="line-780"></span><span>          </span><span class="hs-identifier">content</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NormalFile</span><span> </span><span class="hs-identifier">bs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">LBS.length</span><span> </span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span>      </span><span class="hs-identifier">mkEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Tar.Entry</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Tar.Entries</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>      </span><span class="hs-identifier">mkEntries</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Tar.Done</span><span>
</span><span id="line-784"></span><span>      </span><span class="hs-identifier">mkEntries</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">e</span><span class="hs-glyph">:</span><span class="hs-identifier">es</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Tar.Next</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkEntries</span><span> </span><span class="hs-identifier">es</span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>      </span><span class="hs-comment">-- Sizes around 0, 1, and 2 block boundaries</span><span>
</span><span id="line-787"></span><span>      </span><span class="hs-identifier">fileSizes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Int</span><span class="hs-special">]</span><span>
</span><span id="line-788"></span><span>      </span><span class="hs-identifier">fileSizes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-789"></span><span>                           </span><span class="hs-number">0</span><span> </span><span class="hs-special">,</span><span>    </span><span class="hs-number">1</span><span> </span><span class="hs-special">,</span><span>    </span><span class="hs-number">2</span><span>
</span><span id="line-790"></span><span>        </span><span class="hs-special">,</span><span>  </span><span class="hs-number">510</span><span> </span><span class="hs-special">,</span><span>  </span><span class="hs-number">511</span><span> </span><span class="hs-special">,</span><span>  </span><span class="hs-number">512</span><span> </span><span class="hs-special">,</span><span>  </span><span class="hs-number">513</span><span> </span><span class="hs-special">,</span><span>  </span><span class="hs-number">514</span><span>
</span><span id="line-791"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-number">1022</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-number">1023</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-number">1024</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-number">1025</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-number">1026</span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span class="hs-comment">-- | 'IndexBuilder' constructed from a 'SimpleIndex'</span><span>
</span><span id="line-795"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-identifier">IndexBuilder</span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier">Show</span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Arbitrary</span><span> </span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">build'</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">simpleTarEntries</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">arbitrary</span><span>
</span><span id="line-800"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-801"></span><span>      </span><span class="hs-comment">-- like 'build', but don't finalize</span><span>
</span><span id="line-802"></span><span>      </span><span class="hs-identifier">build'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Entries</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IndexBuilder</span><span>
</span><span id="line-803"></span><span>      </span><span class="hs-identifier">build'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">empty</span><span>
</span><span id="line-804"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-805"></span><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">builder</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Next</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-identifier">es</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addNextEntry</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-identifier">builder</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">es</span><span>
</span><span id="line-806"></span><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">builder</span><span>  </span><span class="hs-identifier">Done</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">builder</span><span>
</span><span id="line-807"></span><span>          </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier">Fail</span><span> </span><span class="hs-identifier">err</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">err</span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="hs-identifier">prop_finalise_unfinalise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-810"></span><span class="hs-identifier">prop_finalise_unfinalise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SimpleIndexBuilder</span><span> </span><span class="hs-identifier">index</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-811"></span><span>    </span><span class="hs-identifier">unfinalise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">finalise</span><span> </span><span class="hs-identifier">index</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">index</span><span class="hs-cpp">

#endif
</span><span>
</span><span id="line-815"></span><span class="annot"><a href="Codec.Archive.Tar.Index.html#toStrict"><span class="hs-identifier hs-type">toStrict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-cpp">
#if MIN_VERSION_bytestring(0,10,0)
</span><span id="toStrict"><span class="annot"><span class="annottext">toStrict :: ByteString -&gt; ByteString
</span><a href="Codec.Archive.Tar.Index.html#toStrict"><span class="hs-identifier hs-var hs-var">toStrict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">LBS.toStrict</span></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">toStrict</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">BS.concat</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">LBS.toChunks</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if !(MIN_VERSION_base(4,5,0))
</span><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span>
</span><span id="line-824"></span><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mappend</span><span class="hs-cpp">
#endif
</span></pre></body></html>